:sourcesdir: ../../../source

[[example_jasper]]
=== Пример отчёта JRXML

Этот пример также основан на тестовом приложении *Library*, исходный код которого доступен на https://github.com/cuba-platform/sample-library[GitHub].

Для использования отчётов в проекте активируйте элемент *reports* в списке *App components* на экране
редактирования свойств проекта (меню *CUBA* → *Project Properties*) в CUBA Studio.

Для импорта отчёта откройте экран *Reports* -> *Reports* и нажмите кнопку *Import*. Выберите файл Reports.zip в корневом каталоге проекта. В таблице появятся два отчёта, один из которых – Book availability in department. Данный отчёт выводит список публикаций книг, доступных в выбранном отделе; формат вывода по умолчанию – XLS. Теперь создадим новый шаблон JasperReports для этого отчёта.

. <<structure,Структура данных>> отчёта.
+
--
.Редактор отчёта: структура данных
image::sample_jasper.png[align="center"]

Рассмотрим полосы отчёта.

* Полоса *Header* – заголовок отчёта. Она содержит набор данных с Groovy-скриптом, выводящим значение <<parameters, внешнего параметра>> отчёта:
+
[source, groovy]
----
[['library_department_name' : params['library_department'].name]]
----

* Полоса *Data* выводит список книг в выбранном отделе путем выполнения следующего Groovy-скрипта:
+
[source, groovy]
----
include::{sourcesdir}/example_jasper.groovy[]
----
+
В данном запросе используется внешний параметр отчёта – `library_department`. Параметр имеет тип *Entity*, однако его можно напрямую сравнивать с полями-идентификаторами сущностей, преобразование будет выполнено автоматически.
--

. <<parameters,Параметры>> отчёта.
+
На вкладке *Parameters and Formats* объявлен один внешний параметр отчёта – `Department`:
+
.Редактор параметра
image::sample_jasper_2.png[align="center"]
+
Этот параметр запрашивается у пользователя при запуске отчёта. Выбор автора производится через экран `library$LibraryDepartment.browse`, имеющийся в приложении.

. <<template_jasper,Шаблон>> отчёта.
+
--
На вкладке *Templates* определен один шаблон формата XLS, загруженный из файла `BookAvailability.xls`.

Создайте новый файл JRXML со следующим содержимым:

[source, xml]
.BookAvailability.jrxml
----
include::{sourcesdir}/jasper.jrxml[]
----

Таблица в этом шаблоне привязана к дочернему источнику данных `subDataset`. Элемент `title` обращается к данным полосы *Header* напрямую. Вы можете заранее посмотреть, как будет выглядеть отчёт, открыв шаблон в визуальном редакторе JasperReports.

Загрузите новый шаблон в приложение, выбрав любой тип вывода, и сделайте его шаблоном по умолчанию:

.Редактор шаблона
image::sample_jasper_3.png[align="center"]
--

<<running,Выполните>> отчёт, чтобы убедиться в его работоспособности:

.Пример выполненного отчёта
image::sample_jasper_4.png[align="center"]

