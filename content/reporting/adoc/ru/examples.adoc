[[examples]]
== Пример отчета

Рассмотрим устройство одного отчета в приложении-примере *Библиотека*, исходный код которого доступны по адресу https://github.com/cuba-platform/sample-library.

Для использования отчетов в Вашем проекте, необходимо активировать элемент *reports* в списке *App components* на экране
редактирования свойств проекта (секция *Project properties*, кнопка *Edit*) в CUBA Studio.

Для импорта отчета откройте экран *Reports* -> *Reports* и нажмите кнопку *Import*. Выберите файл Reports.zip в корневом каталоге проекта. В таблице появятся два отчета, один из которых - Books by author. Данный отчет выводит список публикаций книг по автору, группируя их по названию книги и издателю. Формат вывода - XLS.

. <<structure,Структура данных>> отчета.
+
--
image::sample1_structure.png[align="center"]

Рассмотрим полосы отчета.

* Полоса *header* - заголовок отчета. Содержит набор данных с Groovy-скриптом, выводящим значения <<parameters,внешних параметров>> отчета:
+
[source, groovy]
----
[['authorName' : (params['author'].firstName + ' ' + params['author'].lastName)]]
----

* Полоса *book* выводит книги путем выполнения следующего SQL-запроса:
+
[source, sql]
----
select b.name as book_name, b.id as book_id
from library_book b 
    join library_book_author_link ba on ba.book_id = b.id
    join library_author a on a.id = ba.author_id
where a.id = ${author}
----
+
В данном запросе используется внешний параметр отчета - author. Параметр имеет тип *Entity*, однако в SQL-запросах его можно напрямую сравнивать с полями-идентификаторами сущностей, преобразование будет выполнено автоматически.

* Вложенная в *book* полоса *publisher* выводит издателей книги путем выполнения следующего SQL-запроса:
+
[source, sql]
----
select p.name as publisher, bp.year, p.id as publisher_id
from library_book_publication bp
    join library_publisher p on p.id = bp.publisher_id
where bp.book_id = ${book.book_id}
----
+
В данном запросе в качестве параметра используется поле родительской полосы - `++book_id++`. Таким образом осуществляется связь между родительской и дочерней полосами.

* Вложенная в *publisher* полоса *publication* выводит издания книги путем выполнения следующего SQL-запроса:
+
[source, sql]
----
select ld.name as department, count(bi.id) as amount
from library_book_instance bi
    join library_book_publication bp on bp.id = bi.book_publication_id
    join library_library_department ld on ld.id = bi.library_department_id
where bp.publisher_id = ${publisher.publisher_id} and bp.book_id = ${book.book_id}
group by ld.name
----
+
В данном запросе в качестве параметров используются поля обоих родительских полос - `++book_id++` и `++publisher_id++`. 
--

. <<parameters,Параметры>> отчета. 
+
--
На вкладке *Parameters and Formats* объявлен один внешний параметр отчета - Author:

image::sample1_param.png[align="center"]

Этот параметр будет запрошен у пользователя при запуске отчета. Выбор автора будет производиться через экран `library$Author.lookup`, имеющийся в приложении.
--

. <<template,Шаблоны>> отчета.
+
На вкладке *Templates* определен один шаблон формата XLS, загруженный из файла BooksByAuthor.xls:
+
image::sample1_template.png[align="center"]

. <<localization,Локализация>> названия отчета.
+
На вкладке *Localization* задано название отчета для русской локали:
+
[source, properties]
----
ru = Книги по автору
----

Вызвать отчет на <<running,исполнение>> можно из общего списка в экране *Reports* -> *Run Reports*.

[[without_params]]
== Пример отчёта без параметров

Можно создать отчёт и вручную, не прибегая к Мастеру. Рассмотрим ещё один пример отчёта, на этот раз без использования внешних параметров, который будет выводить все книги из базы данных в одну таблицу.
За основу возьмём то же приложение-пример https://github.com/cuba-platform/sample-library[*Библиотека*].

Чтобы перейти к созданию отчёта, необходимо нажать *Create* -> *New* на вкладке *Reports*.

image::without_params_1.png[align="center"]

Так мы попадаем сразу в *Report editor*. Допустим, мы собираемся создать максимально прямолинейную структуру отчёта.
Создадим 3 дочерние полосы для Root: *Title, TableHeader* и *Books*. Первые две оставим пустыми, для Books создадим набор данных с помощью запроса на вывод всех книг, имеющихся в базе данных, и детальной информации по ним:

[source, sql]
----
select b.name as "book_name", a.first_name||' '||a.last_name as "author",
lp.name as "publisher", cast(bp.year_ as varchar(4)) as "year",
ld.name as "department", count(bi.id) as "amount"
from library_book b
    join library_book_author_link ba on ba.book_id = b.id
    join library_author a on a.id = ba.author_id
    join library_book_publication bp on bp.book_id = b.id
    join library_publisher lp on lp.id = bp.publisher_id
    join library_book_instance bi on bi.book_publication_id = bp.id
    join library_library_department ld on ld.id = bi.library_department_id
where b.id is not null
group by bp.year_, lp.name, a.first_name||' '||a.last_name, b.name, ld.name
order by a.first_name||' '||a.last_name asc;
----

image::without_params_2.png[align="center"]


Затем вручную создаём шаблон, содержащий 3 обязательные полосы, указанные в *Report structure*, добавляем файл шаблона в поле *Default Template*
и сохраняем изменения.

image::without_params_3.png[align="center"]


Теперь созданный отчёт доступен к исполнению из общего списка в экране Reports в → Run Reports. При исполнении этого отчёта не будут запрашиваться параметры, система сразу перейдёт к скачиванию файла.

image::without_params_4.png[align="center"]


При необходимости в отчёт можно включить дополнительное оформление и диаграммы средствами той программы, в которой вы создаёте шаблон, и связать их с именованными регионами, соответствующими полосам отчёта.