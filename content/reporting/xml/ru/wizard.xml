<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. -->
<chapter lang="ru" id="wizard">
    <title>Мастер создания отчетов</title>
    <para>Мастер создания отчетов - это визуальный инструмент, который позволяет быстро создавать структуру данных и шаблон отчета. Для вызова мастера в экране <guimenu>Reports</guimenu> нажмите <guibutton>Create</guibutton> -&gt; <guibutton>Using wizard</guibutton>.</para>
    <mediaobject>
        <imageobject>
            <imagedata fileref="img/reports_wizard_main.png" align="center"/>
        </imageobject>
    </mediaobject>
    <para>Мастер позволяет создавать отчеты трех типов:</para>
    <orderedlist>
        <listitem><para>Отчет по отдельному экземпляру сущности.</para></listitem>
        <listitem><para>Отчет по списку экземпляров сущности.</para></listitem>
        <listitem><para>Отчет по списку экземпляров сущности, выбранных при помощи запроса.</para></listitem>
    </orderedlist>
    <para>Процесс создания любого отчета состоит из трех этапов:</para>
    <orderedlist>
        <listitem><para>Выбор основных свойств отчета.</para></listitem>
        <listitem><para>Редактирование регионов отчета.</para></listitem>
        <listitem><para>Сохранение отчета.</para></listitem>
    </orderedlist>
    <para>Созданный отчет можно доработать обычным способом в редакторе, и запустить либо через <link linkend="run_common">общий список</link> отчетов, либо с помощью <link linkend="run_actions">действий</link> <code>TablePrintFormAction</code> и <code>EditorPrintFormAction</code>.</para>
    <para>Рассмотрим работу мастера на примере тестового приложения <application>Библиотека</application>, доступного для загрузки по нажатию на кнопку <guibutton>Samples</guibutton> в окне выбора проекта <application>CUBA Studio</application>.</para>
    <section id="single_entity_report">
        <title>Отчет по экземпляру сущности</title>
        <para>Допустим, что мы хотим получить сведения об отдельно взятом издании книги, то есть экземпляре сущности <code>library$BookPublication</code>.</para>
        <para>Для этого необходимо запустить мастер создания отчетов и на первом этапе указать детали отчета:</para>
        <itemizedlist>
            <listitem><para><guilabel>Entity</guilabel> - сущность, по экземпляру которой будет создаваться отчет - <code>library$BookPublication</code>.</para></listitem>
            <listitem><para><guilabel>Format of template file</guilabel> - формат шаблона, по которому будет создаваться отчет - DOCX. Доступны также форматы XSLX и PDF.</para></listitem>
            <listitem><para><guilabel>Report name</guilabel> - имя, под которым будет сохранен отчет - <code>Publication details</code>.</para></listitem>
        </itemizedlist>
        <para>Затем нужно выбрать тип построения отчета - <guilabel>Report for single entity</guilabel>. Этот тип построения означает, что отчет будет создаваться по одной сущности.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_step_1.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>После этого необходимо нажать на кнопку <guibutton>Next</guibutton> и в отобразившемся окне выбрать атрибуты сущности <code>BookPublication</code> и связанных с ней сущностей, которые будут включены в отчет (<code>Publication.Book.Name</code>, <code>Publication.Publisher.Name</code>, <code>Publication.Year</code> и <code>Publication.City.Name</code>). Для этого выбираем их в левой колонке и переносим в правую колонку нажатием на кнопку <inlinemediaobject><imageobject><imagedata fileref="img/attributes_selection_arrow.png"/></imageobject></inlinemediaobject> или двойным кликом.</para>
        <para>Атрибуты будут отображаться в отчете в том порядке, в котором они выбраны на этом этапе. Для того чтобы изменить порядок отображения, перемещайте атрибуты при помощи кнопок <inlinemediaobject><imageobject><imagedata fileref="img/attributes_selection_up.png"/></imageobject></inlinemediaobject>/<inlinemediaobject><imageobject><imagedata fileref="img/attributes_selection_down.png"/></imageobject></inlinemediaobject>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_attributes.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>После нажатия на кнопку ОК произойдет переход ко второму этапу - редактированию регионов отчета.</para>
        <para>Отобразишийся экран содержит список именованных регионов - полос шаблона отчета, в которых будут отображаться данные. Мастер позволяет добавить в шаблон несколько регионов, позволяющих отображать разные наборы данных в виде простого текста.</para>
        <para>При необходимости набор атрибутов сущности, загружаемых в регион шаблона отчета, можно отредактировать, нажав на ссылку со списком атрибутов в описании региона. Также можно добавить новый регион, нажав на кнопку <guibutton>Add simple region</guibutton>.</para>
        <para>Если в сущности есть атрибуты-коллекции, появится также кнопка <guibutton>Add tabulated region</guibutton>, позволяющая добавить регион для отображения данных в виде таблицы.</para>
        <para>В обоих случаях отобразится окно выбора атрибутов сущности <code>library$BookPublication</code>, позволяющее добавить или удалить атрибуты из набора.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_step_2.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>На этом этапе можно посмотреть, как отчет будет выглядеть с текущим набором данных, нажав на кнопку <guibutton>Run</guibutton> и выбрав экземпляр сущности <code>library$BookPublication</code>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_test_running.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>После настройки регионов можно переходить к третьему этапу - сохранению отчета. На этом этапе можно просмотреть готовый шаблон отчета, изменить название и формат файла вывода. Доступны три типа: DOCX, HTML, PDF.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_step_3.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>После нажатия на кнопку <guibutton>Save</guibutton> откроется стандартный редактор отчета, в котором при необходимости можно произвести более тонкую настройку шаблона и структуры данных. После завершения редактирования нажмите <guibutton>Save and close</guibutton> в редакторе отчета.</para>
        <para>Отчет будет добавлен в группу отчетов <guilabel>General</guilabel> в браузере отчетов, откуда его можно запустить кнопкой <guibutton>Run</guibutton>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_reports_list.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Дополнительно мы можем сделать так, чтобы  чтобы отчет о деталях публикации запускался из браузера публикаций. Для этого необходимо добавить в XML-дескрипторе <code>bookpublication-browse.xml</code> к таблице публикаций кнопку <guibutton>Print details</guibutton> для запуска отчета:</para>
        <programlisting language="xml">
            <![CDATA[
<groupTable id="bookPublicationTable"
    ...
    <buttonsPanel>
        ...
        <button id="printDetails"
        caption="msg://printDetails"/>]]>
        </programlisting>
        <para>После чего необходимо добавить к ней в контроллере экрана действие <code>TablePrintFormAction</code> для запуска отчета:</para>
        <programlisting language="java">
            <![CDATA[
@Inject
private Button printDetails;

@Override
public void init(Map<String, Object> params) {
    TablePrintFormAction action = new TablePrintFormAction("report", this, bookPublicationTable);
          bookPublicationTable.addAction(action);
          printDetails.setAction(action);
    }]]>
        </programlisting>
        <para>После этого можно запускать отчет по любой публикации, выбирая ее в таблице и нажимая на кнопку <guibutton>Print details</guibutton></para>.
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_running.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Готовый отчет выглядит следующим образом:</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/single_entity_result.png" align="center"/>
            </imageobject>
        </mediaobject>
    </section>
    <section id="list_of_entities_report">
        <title>Отчет по списку экземпляров сущности</title>
        <para>Мастер отчетов позволяет создавать два вида отчетов по списку экземпляров сущности:</para>
        <orderedlist>
            <listitem><para>отчет по вручную выбранным экземплярам определенной сущности;</para></listitem>
            <listitem><para>отчет по экземплярам сущности, удовлетворяющим некоторому запросу.</para></listitem>
        </orderedlist>
        <para>Рассмотрим первый тип отчета. Допустим, что нам необходимо получить список экземпляров книг, находящихся в библиотеке (сущность <code>library$BookInstance</code>) с их названиями и отделами библиотеки, в которых они находятся.</para>
        <para>На первом этапе необходимо указать детали отчета:</para>
        <itemizedlist>
            <listitem><para><guilabel>Entity</guilabel> - сущность, по списку экземпляров которой будет создаваться отчет - <code>library$BookInstance</code>.</para></listitem>
            <listitem><para><guilabel>Format of template file</guilabel> - формат вывода отчета - XSLX.</para></listitem>
            <listitem><para><guilabel>Report name</guilabel> - имя отчета - <code>Book items location</code>.</para></listitem>
        </itemizedlist>
        <para>Затем нужно выбрать тип построения отчета - <guilabel>Report for list of entities</guilabel> и нажать <guibutton>Next</guibutton>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/list_of_entities_step_1.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>В соответствии с условием задачи, в окне выбора атрибутов необходимо выбрать <code>BookItem.Publication.Book.Name</code>, <code>BookItem.LibraryDepartment.Name</code>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/list_of_entities_attributes.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Нажмем <guibutton>ОК</guibutton> для перехода ко второму этапу - редактированию регионов отчета.</para>
        <para>Шаблон отчета по списку сущностей может содержать только один регион, выводящий данные в виде таблицы. Добавлять новые регионы нельзя, но можно отредактировать набор данных в существующем, нажав на ссылку со списком атрибутов, либо удалить существующий регион и создать его заново, для чего наверху станет активной кнопка <guibutton>Add tabulated region</guibutton>.</para>
        <para>В данном случае, менять ничего не нужно. Нажмем <guibutton>Next</guibutton> -> <guibutton>Save</guibutton> для сохранения отчета. В редакторе отчетов отчет будет выглядеть следующим образом:</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/list_of_entities_editor.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>После сохранения отчет можно запускать из браузера отчетов.</para>
        <para>Дополнительно мы можем добавить кнопку запуска отчета в экран просмотра экземпляров книг, открывающийся из браузера публикаций по кнопке <guibutton>Show items</guibutton>. Для этого установим в XML-дескрипторе экрана <code>bookinstance-browse.xml</code> для таблицы экземпляров книг (<code>bookInstancesTable</code>) атрибут <code>“multiselect=true”</code> и добавим код кнопки:</para>
        <programlisting language="xml">
            <![CDATA[
      <table id="bookInstanceTable"
             multiselect="true">
             ...
                  <buttonsPanel>
                  ...
                      <button id="printList"
                      caption="msg://printList"/>]]>
        </programlisting>
        <para>После этого инжектируем в контроллере компонент <code>Button</code>:</para>
        <programlisting language="java">
            <![CDATA[
@Inject
private Button printList;]]>
        </programlisting>
        <para>После этого внутри переопределенного метода <code>init()</code> добавим следующий код:</para>
        <programlisting language="java">
            <![CDATA[
TablePrintFormAction action = new TablePrintFormAction("report", this, bookInstanceTable);
    bookInstanceTable.addAction(action);
    printList.setAction(action);]]>
        </programlisting>
        <para>Теперь отчет можно запускать из браузера экземпляров книг, выбирая экземпляры для отчета в таблице и нажимая на кнопку <guibutton>Print list</guibutton>. Опция <guibutton>Print selected</guibutton> экспортирует выбранные экземпляры, опция <guibutton>Print all</guibutton> - все экземпляры, выбранные текущим фильтром.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/list_of_entities_running.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Готовый отчет будет выглядеть следующим образом:</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/list_of_entities_result.png" align="center"/>
            </imageobject>
        </mediaobject>
        </section>
        <section id="query_report">
            <title>Отчет по экземплярам сущности, отобранным при помощи запроса</title>
        <para>Теперь рассмотрим второй <link linkend="list_of_entities_report">тип отчета</link> - отчет по списку сущностей, выбранных с помощью запроса. Для этого усложним задачу: отчет должен содержать в себе список экземпляров книг (с именами и названиями отделов), добавленных  после определенной даты.</para>
        <para>Как и в предыдущем случае, начнем с того, что зададим детали отчета:</para>
        <itemizedlist>
            <listitem><para><guilabel>Entity</guilabel> - сущность, по списку экземпляров которой будет создаваться отчет - <code>library$BookInstance</code>.</para></listitem>
            <listitem><para><guilabel>Format of template file</guilabel> - формат вывода отчета - XSLX.</para></listitem>
            <listitem><para><guilabel>Report name</guilabel> - имя отчета - <code>Recently added book items.</code></para></listitem>
        </itemizedlist>
        <para>Затем нужно выбрать тип построения отчета - <guilabel>Report for list of entities, selected by query</guilabel>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_step_1.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Выбранный тип отчета позволит нам автоматически отобрать список сущностей, соответствующих определенному запросу. Для того чтобы задать этот запрос, необходимо нажать на ссылку <guilabel>Set query</guilabel>, появившуюся внизу.</para>
        <para>Отобразится окно выбора условий запроса, которое во многом аналогично соотвествующему окну универсального фильтра. Оно позволяет добавлять условия, объединять их в группы AND/OR и настраивать их параметры.</para>
        <para>Для добавления нового условия запроса нужно нажать на кнопку <guibutton>Add</guibutton>. Отобразится окно выбора атрибутов сущности <code>library$BookInstance</code>, в котором необходимо выбрать атрибут <code>Created at</code>. Атрибут будет добавлен в дерево условий запроса и в панели справа отобразятся его свойства. Выберем оператор запроса (<code>>=</code>).</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_parameter.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>После сохранения запроса необходимо нажать <guibutton>Next</guibutton> и перейти к выбору атрибутов сущности <code>library$BookInstance</code>, которые будут включены в отчет. В соответствии с условием задачи, перенесем в правую колонку атрибуты <code>BookItem.Publication.Book.Name</code>, <code>BookItem.LibraryDepartment.Name</code>. Нажмем <guibutton>ОК</guibutton> для перехода ко второму этапу.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_step_2.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Нажмем <guibutton>Next</guibutton> -> <guibutton>Save</guibutton> для сохранения отчета. В отобразившемся редакторе готовый отчет будет выглядеть следующим образом:</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_editor.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>В редакторе можно усложить структуру отчета, добавив новые полосы и наборы данных, а также настроить дизайн шаблона отчета, сделать локализацию отчета или определить настройки прав доступа.</para>
        <para>К примеру, перейдем на вкладку <guilabel>Parameters and Values</guilabel>. В списке <guilabel>Parameters</guilabel> выберем и изменим имя параметра запроса: <code>Date</code> вместо стандартного <code>CreateTs1</code>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_parameter_rename.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Наконец, добавим в экран просмотра списка отделов библиотеки кнопку <guibutton>Report</guibutton>, позволяющую запустить данный отчет.</para>
        <para>Для этого внесем в XML-дескриптор экрана <code>librarydepartment-browse.xml</code> реализацию кнопки:</para>
        <programlisting language="xml">
            <![CDATA[
<table id="libraryDepartmentTable"
    ...
    <buttonsPanel id="buttonsPanel">
        ...
        <button id="reportBtn"
         caption="msg://reportBtn"/>
     </buttonsPanel>
</table>]]>
        </programlisting>
        <para>После чего в контроллере инжектируем компонент <code>Button</code>:</para>
        <programlisting language="java">
            <![CDATA[
@Inject
private Button reportBtn;]]>
        </programlisting>
        <para>и в переопределенном методе зададим для кнопки действие <code>RunReportAction</code>:</para>
        <programlisting language="java">
            <![CDATA[
reportBtn.setAction(new RunReportAction("report", this));]]>
        </programlisting>
        <para>В браузере отделов библиотеки появится кнопка <guibutton>Report</guibutton>, по нажатию на которую открывается список всех доступных в системе отчетов. Для того чтобы запустить наш отчет, необходимо выбрать в списке <guilabel>Recently added book items</guilabel>, указать дату и нажать <guibutton>Run report</guibutton>.</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_running.png" align="center"/>
            </imageobject>
        </mediaobject>
        <para>Готовый отчет выглядит следующим образом:</para>
        <mediaobject>
            <imageobject>
                <imagedata fileref="img/query_result.png" align="center"/>
            </imageobject>
        </mediaobject>
    </section>
</chapter>