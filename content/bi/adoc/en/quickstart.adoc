[[quick_start]]
== Quick Start

We have created a small project to demonstrate how to enrich your CUBA application with BI reports. As an illustration we will embed a Pentaho report in a small demo application for customers and orders management.

In order to start, please setup the BI Add-on following the <<setup_addon,instruction>>.

=== Setup CUBA sample application

. Clone sample project from https://git.haulmont.com/platform/bi-demo.git

. Open the project in IDE or in Studio, run the `createDb` command and start the application server.

=== Setup Pentaho

. Download and install Pentaho: http://www.pentaho.com/download

. Stop _Pentaho Server_, _Pentaho Solution Repository_ background processes in Windows Services or its equivalent.

. Change Pentaho default port to 8081:
+
--
* Navigate to _$PENTAHO_HOME$/server/pentaho-server/tomcat/conf_, where $PENTAHO_HOME$ is the directory where Pentaho is installed

* Change default tomcat port to 8081 in the `server.xml`:

[source,xml]
----
include::{sourcesdir}/bi_port.xml[]
----
--

. Setup authentication of CUBA users in Pentaho:
+
--
* open the directory _$BI_PROJECT$/com/haulmont/addon/bi/pentaho_, where $BI_PROJECT$ is the directory where BI Add-on project is located

* copy `cuba-pentaho-authentication.xml` to _$PENTAHO_HOME$/server/pentaho-server/pentaho-solutions/system_

* edit `pentaho-spring-beans.xml` in _/pentaho-solutions/system_ and add the line `<import resource="cuba-pentaho-authentication.xml" />` after the `<import resource="applicationContext-spring-security.xml" />` line.
+
[source,xml]
----
include::{sourcesdir}/bi_beans.xml[]
----

* open _$BI_PROJECT$/modules/pentaho/build/libs_

* copy `cuba-bi-pentaho-0.1-SNAPSHOT.jar` to _$PENTAHO_HOME$/server/pentaho-server/tomcat/webapps/pentaho/WEB-INF/lib_
--

. Start Pentaho Server, Pentaho Solution Repository background processes in Windows Services or its equivalent.

=== Load Data to Star Schema

In our Pentaho report we will use aggregated data from multiple database tables. This data will be stored in additional tables and then loaded to the Star Schema. In our case, the Star Schema will consist of one fact table (Orders) and two dimension tables (Customer and Product), providing the ability to drill into the report hierarchy.

==== Lazy workaround

You can use the ready star schema delivered with the demo project.

. Open _$BI_DEMO_PROJECT$/modules/core/src/com/haulmont/bidemo/core/kettle/bidemo.kjb_, where $BI_DEMO_PROJECT$ is the directory where  BI Demo project is located.

. Click *Run* to update the Star Schema.
+
image::bi_star_schema.png[align="center"]

Now you can pass to <<analysis_report,creating the Analysis Report>>.

==== Create Database connection

If you want to create the star schema yourself, follow the steps below. For the detailed instructions consult the http://wiki.pentaho.com/display/EAI/.03+Database+Connections[Pentaho wiki].

. Start Pentaho Data Integration using spoon.bat from _$PENTAHO_HOME$/design-tools/data-integration_

. Create new transformation.

. Create new database connection for the transformation:
+
--
* Enter the Connection Name

* Connection Type: Hypersonic

* Access: Native (JDBC)

* Host Name: localhost

* Database Name: bidemo

* Port Number: 19001

* User Name: sa

* Leave the Password field empty

image::star-schema.png[align="center"]
--

==== Create Dimensions

For the dimensions, we will use Products and Customers. Each product refers to some product line, that is the type of product, e.g. _Ford T_ belongs to the _Vintage Cars_ product line.

Customers belong to certain cities, they, in turn, refer to some countries, the countries are grouped into territories.

. First, create the Product transformation. Drag and drop the *Table input* node onto the worksheet and define the fields we need for the report: product `id`, `name` and `product_line_id`.
+
image::star-schema_2.png[align="center"]

. Then create an Insert/Update node for products:
+
image::star-schema_3.png[align="center"]

. Create the transformation for product lines:
+
image::star-schema_4.png[align="center"]

. Finalize the first transformation with the *Update* node:
+
image::star-schema_5.png[align="center"]

. Create the Customer transformation in the same way, including City and Territory levels, and add it to the Product one:
+
image::star-schema_6.png[align="center"]

. When the transformation is ready, wrap it in the corresponding job, using the *START* and *Success* nodes and the *Abort job* exit node in case of an error:
+
image::star-schema_12.png[align="center"]

==== Create Facts

For the Facts measure we will take the Orders and Order Lines.

. First, create the Order Line transformation. Drag and drop the *Table input* node onto the worksheet and define the fields we need for the report: `id`, `product_id`, `quantity` and `order_id`:
+
image::star-schema_7.png[align="center"]

. Then create an Insert/Update node for order lines:
+
image::star-schema_8.png[align="center"]

. Create the transformation for orders:
+
image::star-schema_9.png[align="center"]

. Finally, update the customers IDs in the table:
+
image::star-schema_10.png[align="center"]

. The Facts transformation is now ready:
+
image::star-schema_11.png[align="center"]

. Wrap the transformation in the corresponding job:
+
image::star-schema_13.png[align="center"]

==== Create Star Schema

Now let's assemble the dimensions and facts jobs into the complete star schema:

. Add the *START* node to start the job

. Start the job with the *Check Db connections* condition

. In case the DB is not connected, add the *Abort job* node for the job

. Then add consequently *Update Dimensions* and *Update Facts* jobs that we have designed earlier

. Finalize the job with the *Success* node and run the job:
+
image::star-schema_14.png[align="center"]

. Save all the job and transformation files in the project folder for further use.

[[analysis_report]]
=== Configure Pentaho Analysis Report

You can either use the analysis report delivered with the demo project or create it yourself following the steps below.

. Open Pentaho console: _http://localhost:8081/pentaho/_ and login as _Admin/password_

. Click *File → Manage Data Sources*

. Click *New Connection*
+
image::bi_pentaho.png[align="center"]

. Create connection to HSQLDB
+
image::bi_pentaho_2.png[align="center"]

==== Lazy workaround

Below is the easiest way to see what the Pentaho report looks like, you only have to import .zip-files with the analysis and the report structure.

. Click *Import Analysis*

. Select Data Source *BIDemo* and mondrian file _$BI_DEMO_PROJECT$/modules/core/src/com/haulmont/bidemo/core/pentaho/BiDemo.zip_
+
image::bi_pentaho_3.png[align="center"]

. Click Browse Files on main window. Select home/Admin folder and click *Upload*.

. Select _$BI_DEMO_PROJECT$/modules/core/src/com/haulmont/bidemo/core/pentaho/ProductsByTypeAndLocation.xanalyzer.zip_ and upload it.
+
image::bi_pentaho_4.png[align="center"]

Now you can already open the Pentaho report in the <<bi_widget,CUBA application>>.

==== Create Data Source and Analysis Report

===== Create Data Source

. Click *New Data Source*

. Select the Source Type: *Database Table(s)

. Select the new *BIDemo* connection in the list of available connections

. Select *Reporting and Analysis* as the aim of this data source.
+
image::pentaho_console.png[align="center"]

. Select the dimensions and the fact tables we have created in Spoon: _"PENTAHO_DIM_CUSTOMER"_, _"PENTAHO_DIM_PRODUCT"_, _"PENTAHO_FACT_ORDER_LINE"_:
+
image::pentaho_console_2.png[align="center"]

. Define Joins for selected tables:
+
image::pentaho_console_3.png[align="center"]

. Save the data source. Select it in the list of available datasources and export the created analysis for the further use:
+
image::pentaho_console_4.png[align="center"]

===== Create Analysis Report

. On the Pentaho Console home page click *New* -> *Analysis Report*

. Select the *BIDemo* data source

[[bi_widget]]
=== Open BI Widget in CUBA Sample Application

. Open http://localhost:8080/app

. Open Shop → BI
++++
      <table border="0" cellpadding="0" style="text-align:center;margin:auto" width="1096" align="center">
        <tr>
          <td ><script type="text/javascript">
          var oeTags = '<img src="img/pentaho.gif" width="1094" height="406" alt=""/>';
          document.write( oeTags );
          </script><br/></td>
        </tr>
      </table>
++++
