[[quick_start]]
== Быстрый старт

В качестве примера интеграции мы создали простой демонстрационный проект, содержащий BI-отчёт. Это уже привычное нам демо-приложение для учёта покупателей и заказов, в которое мы встроили отчёт Saiku на сервере Pentaho.

[[qs_setup_sample]]
=== Установка демо-приложения CUBA

. Клонируйте или скачайте демонстрационное приложение с https://github.com/cuba-platform/cuba-bi-demo.git

. Откройте проект в IDE или в CUBA Studio, выполните команду `createDb` и запустите сервер приложения.

[[qs_load_data]]
=== Загрузка данных в схему звезды

В нашем отчёте Pentaho мы будем использовать агрегированные данные из нескольких таблиц. Для хранения этих данных будут созданы дополнительные таблицы, откуда они затем будут загружены в схему звезды (Star Schema). В нашем случае схема звезды состоит из одной таблицы фактов (Orders) и двух таблиц измерений (Customer и Product), что даёт возможность "проваливаться" вглубь иерархии отчёта.

[[qs_load_data_for_impatient]]
==== Загрузка данных для нетерпеливых

Вы можете использовать уже готовую схему, скачанную вместе с демо-проектом.

. Убедитесь, что демо-проект открыт в Studio. В процессе импорта, описанном ниже, мы будем обращаться к HSQL базе данных проекта.

. Запустите утилиту _Pentaho Data Integration_:
+
--
* Перейдите в папку, где установлена утилита Pentaho Data Integration.

* Выполните `spoon.bat`.
--

. Откройте файл `$BI_DEMO_PROJECT/demo/kettle/bidemo.kjb`, где `$BI_DEMO_PROJECT` - папка, в которой находится демо-проект.

. Нажмите *Run* для обновления схемы звезды.
+
image::bi_star_schema.png[]

Теперь вы можете перейти к главе <<qs_analysis_report,создание аналитического отчёта>>.

[[qs_db_connection]]
==== Подключение к базе данных

Если вы хотите создать схему звезды самостоятельно, выполните следующие шаги. Более подробные инструкции можно найти на http://wiki.pentaho.com/display/EAI/.03+Database+Connections[Pentaho wiki].

. Откройте утилиту _Pentaho Data Integration_, запустив `spoon.bat` в папке `$PENTAHO_HOME$/design-tools/data-integration`.

. Создайте новую трансформацию.

. Создайте для трансформации новое подключение к БД:
+
--
* Введите имя подключения в поле Connection Name

* Connection Type: Hypersonic

* Access: Native (JDBC)

* Host Name: localhost

* Database Name: bidemo

* Port Number: 19001

* User Name: sa

* Поле Password field оставьте пустым

image::star-schema.png[]
--

[[qs_dimensions]]
==== Создание измерений

В качестве измерений мы будем использовать сущности Products и Customers. Каждый продукт содержит ссылку на строку продукта product line, в которой содержится тип продукта, например, _Ford T_ принадлежит к типу _Vintage Cars_.

Покупатели содержат ссылку на определённый город, который, в свою очередь, ссылается на страну, страны сгруппированы в несколько территорий.

. Для начала создадим трансформацию для Product. Перетащите узел *Table input* на рабочий лист и укажите поля, которые будут использованы в отчёте: `id` продукта, `name` и `product_line_id`.
+
image::star-schema_2.png[]

. Далее создайте для продуктов узел Insert/Update:
+
image::star-schema_3.png[]

. Создайте трансформацию для строк продукта:
+
image::star-schema_4.png[]

. Завершите трансформацию узлом *Update*:
+
image::star-schema_5.png[]

. Создайте трансформацию для сущности Customer тем же образом, включив в неё уровни City и Territory, и добавьте её к трансформации сущности Product:
+
image::star-schema_6.png[]

. Закончив создание трансформации, оберните её в соответствующую задачу, используя узлы *START* и *Success*, а также узел *Abort job* для выхода в случае ошибки:
+
image::star-schema_12.png[]

[[qs_facts]]
==== Создание фактов

Для меры фактов мы используем заказы (Orders) и строки заказов (Order Lines).

. Начнём с создания трансформации для Order Line. Перетащите узел *Table input* на рабочий лист и укажите поля, которые будут использованы в отчёте: `id`, `product_id`, `quantity` и `order_id`:
+
image::star-schema_7.png[]

. Далее создайте для строк заказа узел Insert/Update:
+
image::star-schema_8.png[]

. Создайте трансформацию для заказов:
+
image::star-schema_9.png[]

. Наконец, обновите ID покупателей в таблице:
+
image::star-schema_10.png[]

. Трансформация фактов готова:
+
image::star-schema_11.png[]

. Оберните трансформацию в соответствующую задачу:
+
image::star-schema_13.png[]

[[qs_star_schema]]
==== Создание схемы звезды

Теперь соберём задачи измерений и мер в готовую схему звезды:

. Добавьте узел *START* для запуска задачи.

. Перед выполнением добавьте проверку условия *Check Db connections*.

. На случай, если подключение к БД отсутствует, добавьте выходной узел *Abort job*.

. Затем добавьте последовательно задачи *Update Dimensions* и *Update Facts*, которые мы создали ранее.

. Завершите задачу узлом *Success* и запустите её выполнение:
+
image::star-schema_14.png[]

. Сохраните все файлы задач и трансформаций в папку проекта для дальнейшего использования.

[[qs_analysis_report]]
=== Создание аналитического отчёта Pentaho

. Откройте консоль администратора Pentaho: `++http://localhost:8081/pentaho++` и войдите под `Admin/password`.

. Нажмите *File → Manage Data Sources*.

. Нажмите на шестерёнку настроек и выберите *New Connection*:
+
image::bi_pentaho.png[]

. Создайте подключение к HSQLDB:
+
--
* Host Name: `localhost`
* Database Name: `bidemo`
* Port Number: `19001`
* User Name: `sa`

image::bi_pentaho_2.png[]
--

Теперь вы можете либо использовать готовый отчёт, <<qs_demo_report,поставляемый с демо-проектом>>, либо создать создать его самостоятельно, следуя инструкции <<qs_create_report,ниже>>.

[[qs_demo_report]]
==== Использование готового отчёта

Здесь описан наиболее простой способ познакомиться с отчётами Saiku, в котором достаточно импортировать ZIP-файлы с анализом и структурой отчёта.

. Нажмите *Import Analysis*.

. Выберите источник данных `BIDemo` и импортируйте файл Mondrian `$BI_DEMO_PROJECT/demo/pentaho/BiDemo.zip`. Будет загружена готовая структура отчёта.
+
image::bi_pentaho_3.png[]

. Нажмите New → Saiku Analytics → Create a new query. Выберите куб `BiDemo` и заполните меры, измерения и ряды, как на скриншоте ниже:
+
image::bi_pentaho_5.png[]

. Сохраните отчёт в каталог `/home/admin`, указав имя файла `ProductsByTypeAndLocation`.

Теперь вы можете открыть отчёт Saiku в <<bi_widget,приложении CUBA>>.

[[qs_create_report]]
==== Создание источника данных и структуры отчёта вручную

Создайте источник данных::
+
--
. Нажмите *New Data Source*.

. Выберите тип источника: *Database Table(s)*.

. Выберите новое подключение `BIDemo` из списка доступных подключений.

. Выберите назначение *Reporting and Analysis* для нового источника.
+
image::pentaho_console.png[]

. Выберите таблицы измерений и фактов, которые мы создали ранее в Spoon: `"PENTAHO_DIM_CUSTOMER"`, `"PENTAHO_DIM_PRODUCT"`, `"PENTAHO_FACT_ORDER_LINE"`:
+
image::pentaho_console_2.png[]

. Определите Joins для выбранных таблиц:
+
image::pentaho_console_3.png[]

. Задайте иерархию измерений:
+
image::pentaho_console_5.png[]

. Сохраните источник данных. Выберите его в списке доступных источников и экспортируйте созданный анализ для дальнейшего использования:
+
image::pentaho_console_4.png[]
--

Создайте аналитический отчёт::
+
--
. Нажмите New → Saiku Analytics → Create a new query. Выберите куб `BiDemo` и заполните меры, измерения и ряды, как на скриншоте ниже:
+
image::bi_pentaho_5.png[]

. Сохраните отчёт в каталог `/home/admin`, указав имя файла `ProductsByTypeAndLocation`.

Теперь вы можете открыть отчёт Saiku в <<bi_widget,приложении CUBA>>.
--

[[bi_widget]]
=== Использование виджета BI в приложении CUBA

. Перейдите по адресу `++http://localhost:8080/app++`

. Откройте *Shop → BI Saiku* в главном меню приложения:

image::saiku.gif[]
