<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><!DOCTYPE book PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" []>
<book id="fts" lang="ru" xmlns:xi="http://www.w3.org/2001/XInclude">
  <bookinfo>
    <copyright>
      <year>2015</year>
      <holder>Haulmont (<ulink url="http://www.haulmont.ru/">www.haulmont.ru</ulink>)</holder>
    </copyright>
    <title>Платформа CUBA. Полнотекстовый поиск</title>
    <author><othername>Версия 5.5</othername></author>
  </bookinfo>
  <preface>
    <title>Предисловие</title>
    <para>Данный документ является руководством по применению подсистемы <firstterm>полнотекстового поиска</firstterm> (<firstterm>full text search</firstterm>, <firstterm>FTS</firstterm>) платформы CUBA.</para>
    <simplesect id="audience">
      <title>Целевая аудитория</title>
      <para>Данное руководство предназначено для разработчиков, создающих  на платформе CUBA приложения с возможностью
        полнотекстового поиска. Предполагается, что читатель ознакомлен с <application>Руководством по разработке приложений</application>,
        доступным по адресу <ulink url="https://www.cuba-platform.com/ru/manual">www.cuba-platform.com/ru/manual</ulink>.</para>
    </simplesect>
    <simplesect id="additional_info">
      <title>Дополнительные материалы</title>
      <para>Настоящее Руководство, а также другая документация по платформе CUBA доступны по адресу
        <ulink url="https://www.cuba-platform.com/ru/manual">www.cuba-platform.com/ru/manual</ulink>.</para>
      <para>Подсистема полнотекстового поиска CUBA основана на фреймворке <application>Apache Lucene</application>,
        поэтому знакомство с его устройством будет полезным. См.
        <ulink url="http://lucene.apache.org/core">lucene.apache.org/core</ulink>.</para>
    </simplesect>
    <simplesect id="feedback">
      <title>Обратная связь</title>
      <para>Если  у Вас имеются предложения по улучшению данного руководства,  обратитесь пожалуйста в службу поддержки
        по адресу <ulink url="https://ru.cuba-platform.com/support/topics">ru.cuba-platform.com/support/topics</ulink>. </para>
      <para>При обнаружении ошибки в документации укажите, пожалуйста, номер главы и приведите небольшой участок
        окружающего текста для облегчения поиска. </para>
    </simplesect>
  </preface>
  <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="chapter1.xml" encoding="UTF-8"/>
  <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="chapter2.xml" encoding="UTF-8"/>
  <appendix id="fts_config">
    <title>Файл конфигурации FTS</title>
    <para>Файл конфигурации полнотекстового поиска представляет собой XML файл, как правило располагающийся в каталоге <filename>src</filename> модуля <structname>core</structname>, и  содержащий описание индексируемых сущностей и их атрибутов.</para>
    <para>Набор конфигурационных файлов FTS, включая определенные в базовых проектах, задается в свойстве приложения <link linkend="cuba.ftsConfig">
        <property>cuba.ftsConfig</property>
      </link>.
</para>
    <para>Рассмотрим структуру файла.
</para>
    <para><sgmltag>fts-config</sgmltag> - корневой элемент.
</para>
    <para>Элементы <sgmltag>fts-config</sgmltag>: <itemizedlist>
        <listitem>
          <para><sgmltag>entities</sgmltag> - список сущностей, подлежащих индексированию и поиску.</para>
          <para>Элементы <sgmltag>entities</sgmltag>: <itemizedlist>
              <listitem>
                <para><sgmltag>entity</sgmltag> - описание индексируемой сущности.</para>
                <para>Атрибуты <sgmltag>entity</sgmltag>:<itemizedlist>
                    <listitem>
                      <para><sgmltag>class</sgmltag> - Java класс сущности. </para>
                    </listitem>
                    <listitem>
                      <para><sgmltag>show</sgmltag>  - должна ли данная сущность показываться в результатах поиска самостоятельно. Значение <code>false</code> используется для сущностей-связей, которые не интересны пользователю сами по себе, но нужны, например, для связи загруженных файлов и сущностей предметной области. По умолчанию <code>true</code>.  </para>
                    </listitem>
                  </itemizedlist></para>
                <para>Элементы <sgmltag>entity</sgmltag>: <itemizedlist>
                    <listitem>
                      <para><sgmltag>include</sgmltag> - включить атрибут или несколько атрибутов сущности в индекс.</para>
                      <para>Атрибуты <sgmltag>include</sgmltag>: <itemizedlist>
                          <listitem>
                            <para><sgmltag>re</sgmltag> - регулярное выражение для отбора атрибутов по имени. Отбираются только атрибуты следующих типов: строка, число, дата, перечисление.</para>
                          </listitem>
                          <listitem>
                            <para><sgmltag>name</sgmltag> - имя атрибута. Может быть путем (через точку) по ссылочным атрибутам. Тип не проверяется, однако если имя является путем, то конечный атрибут должен быть сущностью, а не простым типом  (атрибут простого типа не имеет здесь смысла, он должен индексироваться в своей сущности). </para>
                          </listitem>
                        </itemizedlist></para>
                    </listitem>
                    <listitem>
                      <para><sgmltag>exclude</sgmltag> - исключить ранее включенный атрибут. Возможные атрибуты такие же, как в элементе <sgmltag>include</sgmltag>.</para>
                    </listitem>
                    <listitem>
                      <para><sgmltag>searchables</sgmltag> - Groovy-скрипт для добавления в очередь на индексирование произвольных сущностей, связанных с измененной.</para>
                      <para>Например, когда изменяется (добавляется, удаляется) экземпляр <code>CardAttachment</code>, мы должны также переиндексировать связанный с ним экземпляр <code>Card</code>, так как сам собой <code>Card</code> в очередь не встанет, ибо не менялся.</para>
                      <para>При запуске в скрипт передаются следующие переменные:
<itemizedlist>
                          <listitem>
                            <para><code>searchables</code> - список сущностей, который нужно пополнять.</para>
                          </listitem>
                          <listitem>
                            <para><code>entity</code> - текущий экземпляр сущности, помещаемый в очередь автоматически.</para>
                          </listitem>
                        </itemizedlist></para>
                      <para>Пример скрипта:
                        <programlisting language="xml"><xi:include href="../../source/fts_config_1.xml" encoding="UTF-8" parse="text"/></programlisting>
                      </para>
                    </listitem>
                    <listitem>
                      <para><sgmltag>searchableIf</sgmltag> - Groovy-скрипт для ограничения помещения в очередь некоторых экземпляров индексируемой сущности. </para>
                      <para>Например, может быть не нужно индексировать старые версии документов. </para>
                      <para>При запуске в скрипт передается переменная <code>entity</code> - текущий экземпляр сущности. Скрипт должен вернуть булевское значение - <code>true</code> для того чтобы индексировать текущий экземпляр, <code>false</code> чтобы игнорировать его.</para>
                      <para>Пример скрипта:
                        <programlisting language="xml"><xi:include href="../../source/fts_config_2.xml" encoding="UTF-8" parse="text"/></programlisting>
                      </para>
                    </listitem>
                  </itemizedlist></para>
              </listitem>
            </itemizedlist></para>
        </listitem>
      </itemizedlist></para>
    <para>Пример файла конфигурации FTS:
      <programlisting language="xml"><xi:include href="../../source/fts_config_3.xml" encoding="UTF-8" parse="text"/></programlisting>
    </para>
  </appendix>
  <appendix id="fts_properties">
    <title>Свойства приложения</title>
    <para>В данном разделе перечислены свойства приложения, имеющие отношение к подсистеме полнотекстового поиска.</para>
    <variablelist>
      <varlistentry id="cuba.ftsConfig">
        <term>cuba.ftsConfig</term>
        <listitem>
          <para>Конфигурационный параметр, задает набор файлов конфигурации FTS в проекте.</para>
          <para>Значением свойства должен быть список имен файлов, разделенный пробелами. Файлы загружаются по правилам интерфейса <code>Resources</code>. </para>
          <para>Используется в блоке Middleware.</para>
          <para>Пример:<programlisting>cuba.ftsConfig = cuba-fts.xml fts.xml</programlisting></para>
        </listitem>
      </varlistentry>
    </variablelist>
    <para>Все  свойства, описанные ниже, являются параметрами времени выполнения, хранятся в базе данных и доступны в коде приложения через конфигурационный интерфейс <code>FtsConfig</code>.</para>
    <variablelist>
      <varlistentry id="cuba.fts.enabled">
        <term>cuba.fts.enabled</term>
        <listitem>
          <para>Флаг, разрешающий использование функциональности FTS в проекте. </para>
          <para>Значение данного флага может быть оперативно изменено с помощью  атрибута <guilabel>Enabled</guilabel>  JMX-бина  <code>app-core.fts:type=FtsManager</code>.  </para>
          <para>Значение по умолчанию: <code>false</code></para>
        </listitem>
      </varlistentry>
      <varlistentry id="cuba.fts.indexDir">
        <term>cuba.fts.indexDir</term>
        <listitem>
          <para>Абсолютный путь к каталогу для хранения индексных файлов. Если не установлен, используется подкаталог <filename>ftsindex</filename> рабочего каталога приложения (задаваемого свойством <property>cuba.dataDir</property>), в стандартном варианте развертывания это <filename>tomcat/work/app-core/ftsindex</filename>.  </para>
          <para>Значение по умолчанию: не установлено</para>
        </listitem>
      </varlistentry>
      <varlistentry id="cuba.fts.indexingBatchSize">
        <term>cuba.fts.indexingBatchSize</term>
        <listitem>
          <para>Количество записей, извлекаемое из очереди на индексирование за один вызов метода <code>processQueue()</code>. </para>
          <para>Данное ограничение актуально для ситуации, когда в очереди на индексацию оказывается сразу очень большое число записей, например после выполнения метода <code>reindexAll()</code>  JMX-бина  <code>app-core.fts:type=FtsManager</code>. В этом случае индексация выполняется порциями, что занимает больше времени, но создает ограниченную и предсказуемую нагрузку на сервер.</para>
          <para>Значение по умолчанию: <code>300</code></para>
        </listitem>
      </varlistentry>
      <varlistentry id="cuba.fts.maxSearchResults">
        <term>cuba.fts.maxSearchResults</term>
        <listitem>
          <para>Максимальное количество результатов поиска. </para>
          <para>Значение по умолчанию: <code>100</code></para>
        </listitem>
      </varlistentry>
      <varlistentry id="cuba.fts.searchResultsBatchSize">
        <term>cuba.fts.searchResultsBatchSize</term>
        <listitem>
          <para>Количество элементов в одной порции результатов поиска. Для показа следующей порции пользователь должен нажать  <guibutton>More</guibutton> на экране результатов. </para>
          <para>Значение по умолчанию: <code>5</code></para>
        </listitem>
      </varlistentry>
    </variablelist>
  </appendix>
</book>
