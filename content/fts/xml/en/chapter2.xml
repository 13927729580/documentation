<?xml version='1.0' encoding='UTF-8'?>
<!-- This document was created with Syntext Serna Free. --><chapter id="ch2_quick_start" lang="en">
  <title lang="en">Quick Start</title>
  <para>This chapter describes the example of using the full text search subsystem in the <application>Library</application> sample application;
    source code for the application is available at
    <ulink url="https://www.cuba-platform.com/en/download">www.cuba-platform.com/en/download</ulink>.</para>
  <para>We will split the task into the following stages:<orderedlist>
      <listitem>
        <para>Enable search functionality for the project, configure the indexing process and verify that it works.</para>
      </listitem>
      <listitem>
        <para>Adjust the FTS configuration file to include entities from the sample <application>Library</application> data model.</para>
      </listitem>
      <listitem>
        <para>Use the   <code>EBook</code> entity and the functionality described in the  <application>Workflow subsystem</application> guide to illustrate search function for the loaded files.   </para>
      </listitem>
    </orderedlist></para>
  <section>
    <title lang="en">Project Setup</title>
    <orderedlist>
      <listitem>
        <para>Download the archive with the Library project from
          <ulink url="https://www.cuba-platform.com/en/download">www.cuba-platform.com/en/download</ulink> and unpack
          it to a local folder, for example   <filename>c:\work\library</filename>.</para>
      </listitem>
      <listitem>
        <para>Run <application>CUBA Studio</application>, import the project from  <filename>c:\work\library</filename> and open it.</para>
      </listitem>
      <listitem>
        <para>Open <guibutton>Project properties</guibutton> -&gt; <guibutton>Edit</guibutton>, include the  <structname>fts</structname> project in the list of    <guilabel>Base projects</guilabel> and  save changes. Confirm action after Studio will suggest recreating Gradle scripts. </para>
      </listitem>
      <listitem>
        <para>Select  <guimenu>Run</guimenu> -&gt; <guimenu>Deploy</guimenu>. At this point, the application will be assembled and deployed to the <code>build/tomcat</code> subfolder of the Tomcat server.</para>
      </listitem>
      <listitem>
        <para>Create the application database:  <guimenu>Run</guimenu> -&gt; <guimenu>Create database</guimenu>. In this example Studio acts as an <application>HSQL</application> database server; DB files are located in the  <filename>${user.home}/.haulmont/studio/hsqldb/library</filename> folder.</para>
      </listitem>
      <listitem>
        <para>Start the application server:  <guimenu>Run</guimenu> -&gt; <guimenu>Start application server</guimenu>. </para>
      </listitem>
      <listitem>
        <para>Open the application’s web-interface at <ulink url="http://localhost:8080/app">http://localhost:8080/app</ulink>. Log into the system with the name  <userinput>admin</userinput> and password   <userinput>admin</userinput>. </para>
      </listitem>
      <listitem>
        <para>To enable full text search functionality, open  <guimenu>Administration</guimenu> -&gt; <guimenu>JMX Console</guimenu> in the application main menu, find and open the  <code>app-core.fts:type=FtsManager</code> JMX bean. Open the   <guilabel>Enable</guilabel> attribute using double click and check the  <guilabel>Value</guilabel> checkbox.</para>
      </listitem>
    </orderedlist>
    <para>Once the steps above are completed, full text search functionality will be added to the application and ready to work. If you log out of the system and then log in again, a search field will appear in the top right panel of the main application window. However, search will not produce any results because the data has not been indexed yet.</para>
    <para>To start one-off indexing of the current state of the database (i.e. the entities listed in the FTS configuration file by default), open the <code>app-core.fts:type=FtsManager</code> JMX bean again and consequently invoke   <code>reindexAll()</code> first and then   <code>processQueue()</code>. After this, searching the &quot;adm&quot; string should give the following results:  <mediaobject>
        <imageobject>
          <imagedata fileref="img/SearchResults1.png" align="center"/>
        </imageobject>
      </mediaobject></para>
  </section>
  <section>
    <title lang="en">Configuring Invocation of Indexing Process</title>
    <para>You can use the platform’s scheduled tasks mechanism (see  <application>Application Development Guide</application> -&gt; <application>CUBA Scheduled tasks</application>) to invoke indexing process on a scheduled basis.</para>
    <para>First, you will need to activate the task starting functionality itself. Add the following property to the  <filename>app.properties</filename> file of the project <structname>core</structname> module:<programlisting>cuba.schedulingActive = true</programlisting></para>
    <para>Restart the application server, log into the system as   <userinput>admin</userinput>, open the <guimenuitem>JMX Console</guimenuitem> screen, find and open the <code>app-core.cuba:type=Scheduling</code> JMX bean and make sure that the   <guilabel>Active</guilabel> attribute is set to  <code>true</code>. </para>
    <para>Then open the  <guimenu>Administration</guimenu> -&gt; <guimenu>Scheduled Tasks</guimenu> screen, click  <guibutton>Create</guibutton> and fill in the following attribute values for a new task:<itemizedlist>
        <listitem>
          <para><guilabel>Defined by</guilabel>: Bean</para>
        </listitem>
        <listitem>
          <para><guilabel>Bean name</guilabel>: cuba_FtsManager</para>
        </listitem>
        <listitem>
          <para><guilabel>Method name</guilabel>: processQueue()</para>
        </listitem>
        <listitem>
          <para><guilabel>Singleton</guilabel>: true</para>
        </listitem>
        <listitem>
          <para><guilabel>Period, sec</guilabel>: 30</para>
        </listitem>
      </itemizedlist></para>
    <para>Save the task, select it in the table and click  <guibutton>Activate</guibutton>. From now on, the system will start indexing changed entities every 30 seconds.</para>
    <warning lang="EN">
      <para>Automatic indexing does not cover the entities created before its start. To index such entities, open the <guimenuitem>JMX Console</guimenuitem> screen and call sequentially the following methods of the <code>app-core.fts:type=FtsManager </code>JMX bean:   <code>reindexAll()</code> and <code>processQueue()</code>.</para>
    </warning>
  </section>
  <section>
    <title lang="en">Setting up Configuration File</title>
    <para>Create the  <filename>fts.xml</filename> file with the following content in the source text directory of the <structname>core</structname> module:<programlisting language="xml">&lt;fts-config&gt;
    &lt;entities&gt;

        &lt;entity class=&quot;com.sample.library.entity.Author&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.Book&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.BookInstance&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.BookPublication&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.LibraryDepartment&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.LiteratureType&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.Publisher&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.sample.library.entity.Town&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
        &lt;/entity&gt;

    &lt;/entities&gt;
&lt;/fts-config&gt;</programlisting></para>
    <para>This is the FTS configuration file, which in our case enables indexing of all domain model entities with all their attributes.</para>
    <para>Add the following property to the <filename>app.properties</filename> file of the application <structname>core</structname> module:</para>
    <programlisting>cuba.ftsConfig = cuba-fts.xml fts.xml</programlisting>
    <para>As a result, indexing will include both the entities defined in the platform&apos;s  <filename>cuba-fts.xml</filename> and the project’s  <filename>fts.xml</filename> files.</para>
    <para>Restart the application server. From now on, full text search should work for all entities of the application model as well as entities of the platform security subsystem:  <code>Role</code>, <code>Group</code>, <code>User</code>.</para>
  </section>
  <section>
    <title lang="en">Uploaded Files Content Search </title>
    <para>Take the following steps to see the example of uploaded files content search: add the workflow base project, add <code>EBook</code> entity to the project and create and complete the book scanning workflow as described in the <application>Workflow</application> subsystem guide (see   <xref linkend="additional_info"/>). Further in this section it is assumed that the application already has an instance of   <code>EBook</code> and that a file with the original book has already been uploaded as a result of the <userinput>Book scanning</userinput> process execution.</para>
    <para>Add the following elements to the project’s  <filename>fts.xml</filename> file:<programlisting language="xml">...
        &lt;entity class=&quot;com.sample.library.entity.EBook&quot;&gt;
            &lt;include name=&quot;publication.book&quot;/&gt;
            &lt;include name=&quot;attachments.file&quot;/&gt;
        &lt;/entity&gt;

        &lt;entity class=&quot;com.haulmont.workflow.core.entity.CardAttachment&quot; show=&quot;false&quot;&gt;
            &lt;include re=&quot;.*&quot;/&gt;
            &lt;exclude name=&quot;card&quot;/&gt;

            &lt;searchables&gt;
                searchables.add(entity.card)
            &lt;/searchables&gt;
        &lt;/entity&gt;

    &lt;/entities&gt;
&lt;/fts-config&gt;</programlisting></para>
    <para>In order for search results screen to display the <code>EBook</code> instances properly, you should add  <code>@NamePattern</code> annotation to the    <code>EBook</code> class:<programlisting language="java">@NamePattern(&quot;%s|publication&quot;)
public class EBook extends Card {
...</programlisting></para>
    <para>After that, restart the application server. Open the  <guimenu>JMX Console</guimenu> screen, open the  <code>app-core.fts:type=FtsManager</code> JMX bean and invoke sequentially   <code>reindexAll()</code> and  <code>processQueue()</code> to re-index the existing instances in the database and files according to the new search configuration. All new and changed data will be indexed automatically with a delay depending on the scheduled task interval, i.e. not longer than 30 seconds.</para>
    <para>As a result, if the database contains a book called  <userinput>Alice&apos;s Adventures</userinput> with an original PDF available, search results for &quot;alice&quot; will look like this:<mediaobject>
        <imageobject>
          <imagedata fileref="img/SearchResults2.png" align="center"/>
        </imageobject>
      </mediaobject></para>
    <para>Search results for &quot;rabbit&quot; will look like this:<mediaobject>
        <imageobject>
          <imagedata fileref="img/SearchResults3.png" align="center"/>
        </imageobject>
      </mediaobject></para>
  </section>
</chapter>
