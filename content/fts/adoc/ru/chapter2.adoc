[[quick_start]]
== Быстрый старт

В данной главе мы рассмотрим применение подсистемы полнотекстового поиска в приложении-примере *Библиотека*, который может быть загружен с помощью CUBA Studio.

Разобьем задачу на следующие этапы:

. Подключим функциональность поиска к проекту, настроим вызов процесса индексирования и убедимся в его работоспособности.

. Настроим конфигурационный файл FTS для работы с сущностями модели данных примера *Библиотека*.

. Для иллюстрации возможностей поиска по загруженным файлам используем сущность `EBook` и функциональность, описанную в руководстве *Подсистема Workflow*. 

[[qs_project_setup]]
=== Настройка проекта

. Запустите *CUBA Studio*, перейдите в окно *Open project > Samples* и загрузите проект Library.

. Откройте проект Library в Studio.

. Откройте окно свойств проекта *Project properties* -> *Edit* и в списке *App components* включите компонент *fts*, затем сохраните изменения. Studio предложит пересоздать скрипты Gradle - согласитесь.

. Запустите *Run* -> *Deploy*. На этом этапе будет произведена сборка приложения и оно будет развернуто на сервере Tomcat в подкаталоге `build/tomcat`.

. Создайте базу данных приложения: *Run* -> *Create database*.

. Запустите сервер приложения: *Run* -> *Start application server*. 

. Откройте веб-интерфейс приложения по адресу link:$$http://localhost:8080/app$$[http://localhost:8080/app]. Войдите в систему с именем `*admin*` и паролем `*admin*`. 

. Для того, чтобы включить функциональность полнотекстового поиска, в главном меню приложения откройте *Administration* -> *JMX Console*, найдите и откройте JMX-бин `app-core.fts:type=FtsManager`, двойным щелчком откройте атрибут *Enable* и включите флажок *Value*.

После выполнения вышеописанных действий функциональность полнотекстового поиска подключена к приложению и готова к работе. Если выйти из системы и снова выполнить логин, в правой части верхней панели главного окна приложения появится поле поиска. Однако поиск не будет давать результатов, так как никакие данные еще не проиндексированы.

Для однократного запуска индексации текущего состояния базы данных (а точнее, сущностей, описанных в конфигурационном файле FTS по умолчанию), снова откройте в экране *JMX Console* JMX-бин `app-core.fts:type=FtsManager` и вызовите последовательно сначала метод `reindexAll()`, а затем `processQueue()`. После этого поиск например строки "adm" должен выдавать следующие результаты: 

image::SearchResults1.png[align="center"]

[[qs_indexing]]
=== Настройка вызова процесса индексирования

Для периодического вызова процесса индексирования удобно воспользоваться механизмом назначенных заданий платформы (см. *Руководство по разработке приложений* -> *Назначенные задания CUBA*).

Сначала необходимо активировать весь механизм запуска задач. Добавьте в файл `app.properties` модуля *core* проекта приложения следующее свойство:

[source, properties]
----
cuba.schedulingActive = true
----

Перезапустите сервер приложения, войдите в систему пользователем `*admin*`, откройте экран *JMX Console*, найдите и откройте JMX-бин `app-core.cuba:type=Scheduling` и убедитесь, что атрибут *Active* имеет значение `true`. 

Далее откройте экран *Administration* -> *Scheduled Tasks*, нажмите *Create* и задайте следующие значения атрибутов новой задачи:

* *Defined by*: Bean

* *Bean name*: cuba_FtsManager

* *Method name*: processQueue()

* *Singleton*: true

* *Period, sec*: 30

Сохраните задачу, выделите ее в таблице и нажмите *Activate*. С этого момента каждые 30 секунд будет вызываться процесс индексирования измененных сущностей.

[WARNING]
====
Автоматическое индексирование не затрагивает сущности, созданные до его запуска. Для постановки таких сущностей в очередь на индексацию воспользуйтесь методами `reindexAll()` или `asyncReindexAll()` JMX-бина `app-core.fts:type=FtsManager`. Подробнее см. <<reindex>>.
====

[[qs_conf]]
=== Настройка файла конфигурации

Создайте в каталоге исходных текстов модуля *core* файл `fts.xml` следующего содержания:

[source, xml]
----
<fts-config>
    <entities>

        <entity class="com.sample.library.entity.Author">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.Book">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.BookInstance">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.BookPublication">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.LibraryDepartment">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.LiteratureType">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.Publisher">
            <include re=".*"/>
        </entity>

        <entity class="com.sample.library.entity.Town">
            <include re=".*"/>
        </entity>

    </entities>
</fts-config>
----

Это файл конфигурации FTS, в данном случае включающий в индексирование все сущности предметной области со всеми их атрибутами.

Добавьте в файл `app.properties` модуля *core* приложения следующее свойство:

[source, properties]
----
cuba.ftsConfig = cuba-fts.xml fts.xml
----

В результате индексироваться будут и сущности, определенные в платформе в файле `cuba-fts.xml`, и описанные в файле проекта `fts.xml`.

Перезапустите сервер приложения. На данном этапе полнотекстовый поиск должен работать по всем сущностям модели приложения, а также по сущностям подсистемы безопасности платформы: `Role`, `Group`, `User`.

[[qs_search_files]]
=== Поиск по содержимому загруженных файлов

Для иллюстрации возможностей поиска по содержимому загруженных файлов необходимо сначала подключить компонент приложения *workflow*, добавить в проект сущность `EBook`, создать и пройти процесс сканирования книги, как это описано в руководстве *Подсистема Workflow* (см. раздел <<additional_info,>>). Далее в данном разделе предполагается, что в приложении создан экземпляр `EBook` и в результате выполнения процесса `*Book scanning*` загружен соответствующий файл с оригиналом книги.

Добавьте в файл `fts.xml` проекта следующие элементы:

[source, xml]
----
...
        <entity class="com.sample.library.entity.EBook">
            <include name="publication.book"/>
            <include name="attachments.file"/>
        </entity>

        <entity class="com.haulmont.workflow.core.entity.CardAttachment" show="false">
            <include re=".*"/>
            <exclude name="card"/>

            <searchables>
                searchables.add(entity.card)
            </searchables>
        </entity>

    </entities>
</fts-config>
----

Для правильного отображения экземпляров `EBook` в экране результатов поиска добавьте классу `EBook` аннотацию `@NamePattern`:

[source, java]
----
@NamePattern("%s|publication")
public class EBook extends Card {
...
----

После этого перезапустите сервер приложения. Чтобы переиндексировать имеющиеся в базе данных сущности и файлы в соответствии с новой конфигурацией поиска, откройте в экране *JMX Console* JMX-бин `app-core.fts:type=FtsManager` и вызовите последовательно сначала метод `reindexAll()`, а затем `processQueue()`. Все вновь добавляемые и изменяемые данные будут индексироваться автоматически, с задержкой, определяемой интервалом вызова назначенного задания, т.е. не более 30 секунд.

В результате, при наличии в базе данных книги с названием `*Alice's Adventures*` и загруженным оригиналом в формате PDF, результаты поиска строки "alice" выглядят следующим образом:

image::SearchResults2.png[align="center"]

а результаты поиска строки "rabbit" так:

image::SearchResults3.png[align="center"]

[[reindex]]
=== Запуск и настройка переиндексации сущностей

Если полнотекстовый поиск был подключен в момент, когда в систему уже внесены какие-либо данные, то эти данные нужно проиндексировать. Добавление записей в очередь на индексацию осуществляется с помощью методов JMX-бина `app-core.fts:type=FtsManager`. Удобный способ вызвать метод JMX-бина это воспользоваться экраном *JMX Console* пункта меню *Администрирование*.

JMX-бин `app-core.fts:type=FtsManager` предоставляет два метода для постановки сущностей в очередь на индексацию:

* `reindexAll()` - синхронно добавляет все сущности, описанные в файле конфигурации FTS, в очередь на индексацию. При больших объемах данных этот процесс может занять длительное время, и в этом случае рекомендуется воспользоваться методом `asyncReindexAll()`.

* `asyncReindexAll()` - сущности добавляются в очередь на индексацию пакетами с помощью метода `FtsManager.reindexNextBatch()`. Размер пакета задается конфигурационным параметром <<chapter2.adoc#fts.reindexBatchSize,fts.reindexBatchSize>>. Метод `FtsManager.reindexNextBatch()` должен вызываться механизмом назначенных заданий или с помощью планировщика Spring. Пока формирование очереди не завершено, индексация не производится.
