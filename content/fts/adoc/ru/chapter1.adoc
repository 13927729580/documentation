[[general_info]]
== Обзор подсистемы FTS

Полнотекстовый поиск (full text search, FTS) платформы CUBA предоставляет возможность неструктурированного поиска по значениям атрибутов сущностей и по содержимому загруженных файлов. 

Особенностью реализации полнотекстового поиска CUBA является его ориентация на использование в бизнес-приложениях со сложными моделями данных. В частности, в результатах поиска отображаются не только сущности, напрямую содержащие в некотором атрибуте искомую строку, но и связанные сущности, при отображении которых используется этот атрибут. Например, если сущность `Order` (заказ) содержит ссылку на `Customer` (покупателя), и строка поискасодержит название покупателя, то в результатах поиска будет отображен и найденный покупатель, и заказ, на него ссылающийся. Это поведение является логичным для пользователя, который обычно видит название покупателя в экране редактирования заказа.

Результаты поиска фильтруются с учетом ограничений, накладываемых подсистемой безопасности платформы. То есть, если группа доступа текущего пользователя не разрешает загрузку некоторых экземпляров сущностей, они не будут отображатся в результатах поиска.

Подсистема полнотекстового поиска содержит два взаимосвязанных механизма: индексирование и собственно поиск.

[[indexing]]
=== Индексирование

Если в приложении подключен базовый проект *fts* и включено свойство <<fts.enabled,fts.enabled>>, то при каждом сохранении в базу данных сущности, подлежащей индексированию, ее идентификатор записывается в очередь на индексацию - таблицу *SYS_FTS_QUEUE*.

Отдельный асинхронный процесс периодически извлекает идентификаторы изменившихся сущностей из очереди, загружает экземпляры сущностей и индексирует их. Индексация производится с помощью библиотеки *Apache Lucene*. Документ Lucene содержит следующие поля: 

* Имя сущности и идентификатор экземпляра.

* Поле `all` - конкатенация индексируемых атрибутов сущности, но только локальных и типа `FileDescriptor`. Если атрибут имеет тип `FileDescriptor`, то индексируется содержимое соответствующего файла. Локальные атрибуты могут быть одного из следующих типов: строка, число, дата, перечисление.

* Поле `links` - конкатенация идентификаторов сущностей, которые содержатся в ссылочных индексируемых атрибутах. 

Под индексируемыми атрибутами понимаются атрибуты данной сущности и, возможно, связанных с ней сущностей, объявленные в дескрипторе FTS.

Индекс хранится в файловой системе, по умолчанию в подкаталоге `ftsindex` рабочего каталога приложения (задаваемого свойством `cuba.dataDir`), в стандартном варианте развертывания это `tomcat/work/app-core/ftsindex`. Расположение индекса можно изменить с помощью свойства <<fts.indexDir,fts.indexDir>>.

[[search]]
=== Поиск

Поиск ведется по следующим правилам: 

* если искомая строка обрамлена кавычками, то ищется соответствующая *фраза* - набор таких же слов в том же порядке, игнорируя знаки пунктуации;

* если искомая строка начинается с символа ++"*"++, то производится поиск по вхождению строки *в любой части слова* индексированных данных;

* в противном случае поиск производится по совпадению искомой строки с *началом слов* индексированных данных. 

Для русского и английского языка поиск производится с учетом морфологии.

Алгоритм поиска состоит из двух этапов: 

* Cначала искомая строка ищется в поле `all` документов Lucene. Найденные сущности добавляются в список результатов.

* Если что-то найдено на первом этапе, то идентификаторы найденных сущностей ищутся в поле `links` документов Lucene. Найденные на втором этапе сущности также добавляются в список результатов.

[WARNING]
====
Если строка поиска состоит из нескольких слов (и не обрамлена кавычками), то будет произведен поиск всех слов по отдельности по условию ИЛИ. То есть в результаты поиска попадут сущности, содержащие хотя бы одно из введенных слов.
====

[[index_search_example]]
=== Пример индексирования и поиска

Рассмотрим приведенный выше простейший пример со связанными сущностями `Order` и `Customer`. 

image::Example1Classes.png[align="center"]

В данном случае, если все атрибуты объектов являются индексируемыми, при индексации двух связанных экземпляров `Order` и `Customer` будут созданы два документа Lucene примерно следующего содержания:

[source, plain]
----
id: Order.id = "b671dbfc-c431-4586-adcc-fe8b84ca9617"
all: Order.number + Order.date + Order.amount = "001^2013-11-14^1000"
links: Customer.id = "f18e32bb-32c7-477a-980f-06e9cc4e7f40"
----

[source, plain]
----
id: Customer.id = "f18e32bb-32c7-477a-980f-06e9cc4e7f40"
all: Customer.name + Customer.email = "John Doe^john.doe@mail.com"
----

Теперь предположим, что ищется строка "john":

* Сначала производится поиск в полях `all` всех документов. Будет найден `Customer`, и добавлен в результаты поиска.

* Затем будет произведен поиск идентификатора найденного покупателя в полях `links` всех документов. Будет найден `Order`, и он также будет добавлен в результаты поиска.

