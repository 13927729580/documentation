[[chart]]
== Отображение диаграмм

Подсистема отображения диаграмм платформы CUBA поддерживает большое количество типов диаграмм: круговые, линейные, пузырьковые, лепестковые, диаграммы с накоплением и прочие. Имеется возможность экспорта диаграмм. Для большинства типов диаграмм поддерживается прокрутка и зуммирование. На момент написания настоящего руководства подсистема отображения диаграмм работает только в блоке *Web Client* для *Vaadin7*.

Библиотека *AmCharts*, на которой основана реализация подсистемы отображения диаграмм, распространяется по лицензии, позволяющей использовать ее бесплатно при сохранении ссылки на сайт библиотеки. Для своего проекта Вы можете link:$$http://www.amcharts.com/online-store/$$[купить] лицензию на *AmCharts* и убрать ссылку.

[[chart_configuration]]
=== Конфигурация диаграмм

Для отображения диаграмм используется компонент `Chart`, являющийся универсальным холстом. Вид диаграммы задается его свойством `configuration` типа `AbstractChart`. 

.Иерархия видов диаграмм
image::chart/charts_hierarchy_dia.png[align="center"]

Диаграммы можно описывать в XML-дескрипторе экрана. Для этого необходимо подключить соответствующий `namespace`:

[source, xml]
----
<window xmlns="http://schemas.haulmont.com/cuba/window.xsd"
        xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
        ...>
----

Соответствие элементов XML видам диаграмм:

* `chart:xyChart` - XYChart

* `chart:serialChart` - SerialChart

* `chart:pieChart` - PieChart

* `chart:funnelChart` - FunnelChart

* `chart:gaugeChart` - AngularGaugeChart

* `chart:radarChart` - RadarChart

Каждый вид диаграммы имеет свой набор атрибутов и методов, которые повторяют функционал соответствующих диаграмм библиотеки *AmCharts*. Документация по свойствам и методам диаграмм находится по адресу link:$$http://docs.amcharts.com/3/javascriptcharts$$[docs.amcharts.com/3/javascriptcharts]. 

Все атрибуты конфигурации могут иметь значение `null`, вместо таких значений будут использоваться значения по умолчанию (кроме случаев, указанных в документации AmCharts). 

[[chart_data_binding]]
=== Связь с данными

Реализовано два варианта передачи данных в диаграмму: через интерфейс `DataProvider` или через механизм источников данных. 

* Интерфейс `DataProvider` имеет стандартную реализацию: класс `ListDataProvider`. Он содержит список экземпляров `DataItem`, каждый из которых содержит набор пар ключ-значение. Экземпляр `DataProvider` передается методу `setDataProvider()` конфигурации диаграммы. Данный способ предоставления данных для диаграммы наиболее универсален, однако требует создания экземпляров `DataProvider` и `DataItem` в коде контроллера экрана.

* Источник данных типа `CollectionDatasource` устанавливается для компонента `Chart` вызовом метода `setDatasource()`. Данный вариант требует наличия сущности, представляющей данные диаграммы. Он удобен, когда такая сущность уже есть в модели данных приложения, а также когда данные диаграммы нужно отобразить и в виде таблицы.

В главе <<chart_example,>> проиллюстрированы оба способа получения данных.

Используемые для отображения свойства сущности или значения, содержащиеся в экземпляре `DataProvider`, задаются в атрибутах диаграммы, причем атрибуты различаются для разных типов диаграмм. Например для компонента `chart:pieChart` необходимо задать атрибуты `valueField` и `titleField`.В качестве значений могут выступать типы `Integer`, `Long`, `Double`, `String`, `Boolean`, `Date`. 

Динамическое добавление данных в существующий график не поддерживается, возможно только полностью перерисовать график с новыми данными. Для этого необходимо воспользоваться методом `repaint()`.

[[chart_listeners]]
=== События

Имеется возможность настроить реакцию на различные типы событий. Доступны следующие типы слушателей событий:

* `AxisZoomListener` - масштабирование оси графика.

* `ChartClickListener` - щелчок по холсту.

* `RightClickListener` - щелчок по холсту правой клавишей мыши.

* `CursorPeriodSelectListener` - выбор периода отображения курсором.

* `CursorZoomListener` - масштабирование области графика курсором.

* `GraphClickListener` - щелчок по графику.

* `GraphItemClickListener` - щелчок по элементу графика.

* `LegendItemHideListener` - скрытие элемента легенды.

* `LegendItemShowListener` - показ элемента легенды.

* `LegendItemClickListener` - щелчок по элементу легенды.

* `SliceClickListener` - щелчок по элементу круговой диаграммы.

* `SliceRightClickListener` - щелчок по элементу круговой диаграммы правой клавишей мыши.

* `SlicePullInListener` - элемент круговой диаграммы соединён с диаграммой.

* `SlicePullOutListener` - элемент круговой диаграммы отсоединён от диаграммы.

* `ZoomListener` - масштабирование холста.

Пример использования событий проиллюстрирован в разделе <<section_use_of_events,>>.

[[chart_example]]
=== Пример работы с диаграммами

В данной главе мы рассмотрим применение подсистемы отображения диаграмм в приложении-примере *Библиотека*, который может быть загружен с помощью CUBA Studio.

[[chart_project_setup]]
==== Настройка проекта приложения

. Запустите *CUBA Studio*, перейдите в окно *Open project > Samples* и загрузите проект Library.

. Откройте проект Library в Studio.

. Откройте окно свойств проекта *Project properties* -> *Edit* и в списке *Base projects* включите проект *charts*, затем сохраните изменения. *Studio* предложит пересоздать скрипты Gradle - согласитесь.

. Запустите *Run* -> *Deploy*. На этом этапе будет произведена сборка приложения, и оно будет развернуто на сервере Tomcat в подкаталоге `build/tomcat`.

. Создайте базу данных приложения, запустив *Run* -> *Create database*.

. Запустите *Build* -> *Create or update IDEA project files* чтобы создать проектные файлы для *IntelliJ IDEA*.

После выполнения вышеописанных действий функциональность для отображения диаграмм подключена к приложению и готова к работе. 

[[chart_data_extraction_service]]
==== Создание сервиса для извлечения данных

В данном разделе мы создадим сервис, позволяющий извлечь из базы данные для построения диаграмм. 

. Один из методов сервиса будет возвращать список неперсистентных сущностей, поэтому начнем с создания и регистрации класса этой сущности.
+
Создайте в пакете `com.sample.library.entity` модуля *global* класс `BooksByGenre`: 
+
[source, java]
----
include::{sourcesdir}/chart/BooksByGenre.java[]
----
+
Экземпляр этого класса содержит количество книг определенного жанра. Далее необходимо зарегистрировать класс сущности в файле `metadata.xml` модуля *global*:
+
[source, xml]
----
<metadata-model root-package="com.sample.library">
        <class>com.sample.library.entity.BooksByGenre</class>
    </metadata-model>
----
+
Один из методов сервиса будет возвращать список неперсистентных сущностей, поэтому начнем с создания и регистрации класса этой сущности.
+
. Для создания интерфейса и класса сервиса можно воспользоваться CUBA Studio. Для этого откройте вкладку *Services* на панели навигатора и нажмите на кнопку *New*. В открывшемся окне установите в поле *Interface* значение `com.sample.library.service.StatisticsService`. В полях *Bean* и *Service name* будут сгенерированы подходящие значения `com.sample.library.service.StatisticsServiceBean` и `library_StatisticsService` соответственно. Сохраните изменения.
+
Откройте интерфейс сервиса `StatisticsService` в IDE и объявите в нем методы получения данных из базы:
+
[source, java]
----
include::{sourcesdir}/chart/StatisticsService.java[]
----

. Далее откройте класс сервиса `StatisticsServiceBean` и замените его содержимое на следующий код:
+
[source, java]
----
include::{sourcesdir}/chart/StatisticsServiceBean.java[]
----
+
Метод `getCountOfBooksByGenre()` возвращает количество книг каждого жанра в виде списка сущностей `BooksByGenre`. Метод `getTopPublishers(int count)` сортирует издателей по убыванию количества экземпляров выпущенных ими книг, находящихся в библиотеке, и возвращает первые `count` издателей. Метод `getCountOfBooksByPublisherAndYear()` возвращает количество книг, выпущенных издателями в определенном году.

[[qs_adding_charts]]
==== Создание диаграмм

[[qs_screen_xml]]
===== XML-дескриптор экрана

Откройте в CUBA Studio вкладку *Screens* и создайте экран в модуле *web*. Введите значение `com/sample/library/web/charts/statistics.xml` в поле *Reference*. В полях *Id*, *Controller Name* и *Messages Pack* будут сгенерированы подходящие значения. Сохраните изменения. Далее перейдите на вкладку *XML* и замените ее содержимое на следующий код:

[source, xml]
----
include::{sourcesdir}/chart/statistics.xml[]
----

В корневой элемент дескриптора экрана добавлен атрибут `xmlns:chart`:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
    >
----

Созданный нами экран содержит панель с двумя вкладками. На первой находится круговая диаграмма, представляющая распределение книг по жанрам:

[source, xml]
----
<chart:pieChart id="pieChart"
                    angle="30"
                    balloonText="[[genre]] - [[percents]]%"
                    datasource="pieDs"
                    depth3D="15"
                    height="100%"
                    titleField="genre"
                    valueField="countOfBooks"
                    width="100%">
        <chart:exportConfig menuTop="0px">
            <chart:menuItems>
                <chart:menu format="PNG"
                            icon="VAADIN/resources/amcharts/images/export.png"/>
            </chart:menuItems>
        </chart:exportConfig>
    </chart:pieChart>
----

Даграмма получает данные из источника `pieDs`, указанного в атрибуте `datasource`. Для отображения названий и значений используются атрибуты `genre` и `countOfBooks` сущности `BooksByGenre`, список экземпляров которой находится в источнике данных. С источником данных соединена также таблица, поэтому она отображает те же данные, что и диаграмма.

Компонент `pieChart` содержит следующие атрибуты:

* `angle` - определяет угол наклона диаграммы. Может принимать значения от `0` до `90`.

* `balloonText` - определяет текст всплывающей подсказки при наведении на отделяемую часть диаграммы. Доступны для использования тэги `value`, `title`, `persents`, `description`, а также ключи из `DataItem`, список которых хранится в экземпляре `DataProvider`, либо имена атрибутов сущности в источнике данных.

* `depth3D` - толщина диграммы. При использовании совместно с атрибутом `angle` позволяет создать эффект объема.

* `titleField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будет взято значение для заголовка сектора в круговой диаграмме.

* `valueField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будет взято значение для сектора.

Компонент `pieChart` содержит следующие элементы:

* `chart:legend` - определяет легенду графика. Атрибут `position` определяет положение легенды относительно диаграммы, `markerType` - форму маркера, помечающего информацию о каждом секторе диаграммы.

* `chart:exportConfig` - добавляет возможность сохранить полученный график. Атрибуты `menuTop`, `menuLeft`, `menuRight`, `menuBottom` позволяют задать положение кнопки сохранения. В примере кнопка располагается в правом верхнем углу диаграммы.
+
Элемент `chart:menuItems` содержит настройки сохранения. Кроме используемого в примере формата `png` поддерживается сохранение в форматах `jpg`, `svg` и `pdf`. Атрибут `icon` содержит путь к изображению, которое будет использоваться в качестве кнопки импорта.

Вторая вкладка содержит график, отражающий количество книг, выпущенных в разные годы несколькими издательствами:

[source, xml]
----
<chart:serialChart id="stackedChart"
                       categoryField="year"
                       height="100%"
                       width="100%">
       <chart:chartCursor/>
       <chart:legend markerType="TRIANGLE_RIGHT"
                     position="TOP"
                     valueAlign="LEFT"/>
       <chart:categoryAxis startOnAxis="true"
                           title="msg://year"/>
       <chart:valueAxes>
          <chart:axis position="LEFT"
                      stackType="REGULAR"
                      title="msg://countOfBooks"/>
       </chart:valueAxes>
       <chart:exportConfig menuTop="0px">
          <chart:menuItems>
             <chart:menu format="PNG"
                         icon="VAADIN/resources/amcharts/images/export.png"/>
          </chart:menuItems>
       </chart:exportConfig>
    </chart:serialChart>
----

Эта диаграмма получает данные через `DataProvider`, созданный в контроллере (см. ниже), поэтому атрибут `datasource` не указан.

Атрибуты `chart:serialChart`:

* `categoryField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будут взяты значения для подписи оси категорий.

Элементы `chart:serialChart`: 

* `chart:chartCursor` - необязательный элемент, добавляющий на график курсор, который следует за движениями мыши и отображает всплывающую подсказку со значением графика, соответствующим точке нахождения курсора.

* `chart:categoryAxis` - элемент, описывающий ось категорий. Установка атрибуту `startOnAxis` значения `true` дает указание начинать отрисовывать график сразу от оси значений. По умолчанию этот атрибут имеет значение `false`. В этом случае между осью значений и графиком имеется некоторый помежуток. Атрибут `title` задает заголовок оси категорий.

* `chart:valueAxes` - элемент, описывающий вертикальные оси значений. В данном случае используется только одна ось, описываемая элементом `chart:axis`. Атрибут `position` задает положение оси значений относительно диаграммы. Установка атрибуту `stackType` значения `REGULAR` говорит о том, что используется диаграмма с накоплением. По умолчанию значение этого атрибута - `none`, в таком случае используется диаграмма без накопления.

[[qs_screen_controller]]
===== Контроллер экрана

Перейдите на вкладку *Controller* и замените ее содержимое на следующий код:

[source, java]
----
include::{sourcesdir}/chart/Statistics.java[]
----

В методе `initPieChart()` происходит заполнение источника данных `pieDs` данными, полученными из сервиса. Метод `refresh()` производит инициализацию источника данных. Этот метод необходимо вызвать, несмотря на атрибут `refreshMode="NEVER"`, установленный в XML-дескрипторе. 

В методе `initStackedChart(List<String> allPublishers)` происходит установка данных в диаграмму с накоплением. Диаграммы подобного типа показывают отношение отдельных составляющих к их совокупному значению. В метод передается список издателей, выпустивших наибольшее количество экземпляров книг, находящихся в библиотеке. Для каждого издателя строится график, представляющий количество книг, выпущенных в разные годы. Графику соответствует экземпляр класса `Graph`. Рассмотрим методы настройки графиков:

* `setFillAlphas(0.6)` - устанавливает степень непрозрачности заливки.

* `setLineAlpha(0.4)` - устанавливает толщину линии графика. Допустимые значения от `0` до `1`.

* `setTitle(publisher)` - устанавливает заголовок графика.

* `setType(GraphType.LINE)` - устанавливает тип отбражения данных.

* `setValueField(publisher)` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будет взято значение для графика.

* `++setBaloonText(publisher + " - [[year]] year: [[" + publisher + "]] books")++` - устанавливает значение всплывающей подсказки.

[[qs_screenshots]]
===== Скриншоты диаграмм

Посмотрим, как созданный нами экран выглядит в работающем приложении. Добавьте созданный экран в меню, затем пересоберите проект командой *Run* -> *Restart application server* и зайдите в систему. Откройте экран со статистикой.

.Круговая диаграмма
image::chart/pie_chart.png[align="center"]

.Диаграмма с накоплением
image::chart/stacked_chart.png[align="center"]

На диаграмме с накоплением проиллюстрирована работа курсора, который выводит подробную информацию о количестве книг, выпущенных издателями в выбранном году.

[[section_use_of_events]]
==== Использование событий

Проиллюстрируем использование событий. Добавим в экран, созданный в разделе <<qs_adding_charts,>>, обработку отделения элемента круговой диаграммы пользователем. Откройте XML-дескриптор экрана в IDE, затем инжектируйте диаграмму:

[source, java]
----
@Inject
    private Chart pieChart;
----

Далее добавьте слушателя в методе `initPieChart()`:

[source, java]
----
include::{sourcesdir}/chart/SlicePullOutListener.java[]
----

Для просмотра результата пересоберите проект командой *Run* -> *Restart application server* и зайдите в систему. Откройте экран и нажмите на один из элементов круговой диаграммы для его отделения.

.Диаграмма с обработкой события отделения элемента
image::chart/chart_with_event.png[align="center"]

