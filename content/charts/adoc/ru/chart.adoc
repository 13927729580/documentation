[[chart]]
== Отображение диаграмм

Подсистема отображения диаграмм платформы CUBA поддерживает большое количество типов диаграмм: круговые, линейные, пузырьковые, лепестковые, диаграммы с накоплением и прочие. Имеется возможность экспорта диаграмм. Для большинства типов диаграмм поддерживается прокрутка и зуммирование. На момент написания настоящего руководства подсистема отображения диаграмм работает только в блоке *Web Client* для *Vaadin7*.

Библиотека AmCharts, на которой основана реализация подсистемы отображения диаграмм, распространяется по лицензии, позволяющей использовать ее бесплатно при сохранении ссылки на сайт библиотеки. Для своего проекта Вы можете link:$$http://www.amcharts.com/online-store/$$[купить^] лицензию на AmCharts и убрать ссылку.

[[chart_configuration]]
=== Конфигурация диаграмм

Для отображения диаграмм используется компонент `Chart`, являющийся универсальным холстом. Вид диаграммы задается его свойством `configuration` типа `AbstractChart`. 

.Иерархия видов диаграмм
image::chart/charts-hierarchy-dia.svg[align="center"]

Диаграммы можно описывать в XML-дескрипторе экрана. Для этого необходимо подключить соответствующий `namespace`:

[source, xml]
----
<window xmlns="http://schemas.haulmont.com/cuba/window.xsd"
        xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
        ...>
----

Соответствие элементов XML видам диаграмм:

* `chart:xyChart` - XYChart
* `chart:serialChart` - SerialChart
* `chart:pieChart` - PieChart
* `chart:funnelChart` - FunnelChart
* `chart:gaugeChart` - AngularGaugeChart
* `chart:radarChart` - RadarChart
* `chart:ganttChart` - GanttChart

Каждый вид диаграммы имеет свой набор атрибутов и методов, которые повторяют функционал соответствующих диаграмм библиотеки AmCharts. Документация по свойствам и методам диаграмм находится по адресу link:$$http://docs.amcharts.com/3/javascriptcharts$$[docs.amcharts.com/3/javascriptcharts^].

Все атрибуты конфигурации могут иметь значение `null`, вместо таких значений будут использоваться значения по умолчанию (кроме случаев, указанных в документации AmCharts). 

[[serial_chart]]
==== SerialChart

Компонент `SerialChart` позволяет вам создать большое количество диаграмм: линейчатые, диаграммы с областями, гистограммы, диаграммы с накоплением и прочие. Такие диаграммы поддерживают несколько осей в простом или логарифмическом масштабе. Данные могут быть отображены на равных/неравных отрезках или на временной шкале.

.SerialChart в виде линейного графика
image::chart/line-chart.svg[align="center"]

.SerialChart в виде гистограммы
image::chart/column-chart.svg[align="center"]

[[pie_chart]]
==== PieChart

Компонент `PieChart` позволяет вам создать круговые диаграммы.

.PieChart
image::chart/pie-chart.svg[align="center"]

[[xy_chart]]
==== XYChart

Компонент `XYChart` позволяет вам создать точечные диаграммы, графики и пузырьковые диаграммы. Такие диаграммы поддерживают несколько осей в простом или логарифмическом масштабе.

.XYChart
image::chart/xy-chart.svg[align="center"]

[[funnel_chart]]
==== FunnelChart

Компонент `FunnelChart` позволяет вам создать пирамиды или конусы.

.FunnelChart
image::chart/funnel-chart.svg[align="center"]

[[radar_chart]]
==== RadarChart

Компонент `RadarChart` позволяет вам создать радиальные/сетчатые диаграммы.

.RadarChart
image::chart/radar-chart.svg[align="center"]

[[gauge_chart]]
==== AngularGaugeChart

Компонент `AngularGaugeChart` позволяет вам создать диаграмму-спидометр.

.GaugeChart
image::chart/gauge-chart.svg[align="center"]

[[gantt_chart]]
==== GanttChart

Компонент `GanttChart` позволяет вам создать диаграмму Ганта. Наиболее часто диаграмма Ганта используется для иллюстрации плана, графика работ по какому-либо проекту. Является одним из методов планирования проектов.

.GanttChart
image::chart/gantt-chart.svg[align="center"]

[[chart_data_binding]]
=== Связь с данными

Реализовано два варианта передачи данных в диаграмму: через интерфейс `DataProvider` или через механизм источников данных. 

* Интерфейс `DataProvider` имеет стандартную реализацию: класс `ListDataProvider`. Он содержит список экземпляров `DataItem`, каждый из которых содержит набор пар ключ-значение. Экземпляр `DataProvider` передается методу `setDataProvider()` конфигурации диаграммы. Данный способ предоставления данных для диаграммы наиболее универсален, однако требует создания экземпляров `DataProvider` и `DataItem` в коде контроллера экрана.

* Источник данных типа `CollectionDatasource` устанавливается для компонента `Chart` вызовом метода `setDatasource()`. Данный вариант требует наличия сущности, представляющей данные диаграммы. Он удобен, когда такая сущность уже есть в модели данных приложения, а также когда данные диаграммы нужно отобразить и в виде таблицы.

В главе <<chart_example>> проиллюстрированы оба способа получения данных.

Используемые для отображения свойства сущности или значения, содержащиеся в экземпляре `DataProvider`, задаются в атрибутах диаграммы, причем атрибуты различаются для разных типов диаграмм. Например для компонента `chart:pieChart` необходимо задать атрибуты `valueField` и `titleField`.В качестве значений могут выступать типы `Integer`, `Long`, `Double`, `String`, `Boolean`, `Date`. 

Динамическое добавление данных в существующий график поддерживается только при использовании механизма источников данных.

[[chart_listeners]]
=== События

Имеется возможность настроить реакцию на различные типы событий. Доступны следующие типы слушателей событий:

* `AxisZoomListener` - масштабирование оси графика.
* `ChartClickListener` - щелчок по холсту.
* `RightClickListener` - щелчок по холсту правой клавишей мыши.
* `CursorPeriodSelectListener` - выбор периода отображения курсором.
* `CursorZoomListener` - масштабирование области графика курсором.
* `GraphClickListener` - щелчок по графику.
* `GraphItemClickListener` - щелчок по элементу графика.
* `LegendItemHideListener` - скрытие элемента легенды.
* `LegendItemShowListener` - показ элемента легенды.
* `LegendItemClickListener` - щелчок по элементу легенды.
* `SliceClickListener` - щелчок по элементу круговой диаграммы.
* `SliceRightClickListener` - щелчок по элементу круговой диаграммы правой клавишей мыши.
* `SlicePullInListener` - элемент круговой диаграммы соединён с диаграммой.
* `SlicePullOutListener` - элемент круговой диаграммы отсоединён от диаграммы.
* `ZoomListener` - масштабирование холста.

Пример использования событий проиллюстрирован в разделе <<section_use_of_events,>>.

[[chart_example]]
=== Пример работы с диаграммами

В данной главе мы рассмотрим применение подсистемы отображения диаграмм.

[[chart_project_setup]]
==== Настройка проекта приложения

. Запустите *CUBA Studio*, создайте новй проект и назовите его `sampler`.

. Откройте окно свойств проекта *Project properties* -> *Edit* и в списке *Base projects* включите проект *charts*, затем сохраните изменения. Studio предложит пересоздать скрипты Gradle - согласитесь.

. Запустите *Run* -> *Deploy*. На этом этапе будет произведена сборка приложения, и оно будет развернуто на сервере Tomcat в подкаталоге `build/tomcat`.

. Запустите *Build* -> *Create or update IDEA project files* чтобы создать проектные файлы для *IntelliJ IDEA*.

После выполнения вышеописанных действий функциональность для отображения диаграмм подключена к приложению и готова к работе. 

[[chart_data_from_entity]]
==== Создание диаграммы с данными из сущности

Для первого примера мы создадим диаграмму похожую на link:$$https://www.amcharts.com/demos/3d-stacked-column-chart/$$[3D Stacked Column Chart^] из демо AmCharts. `JavaScript` код выглядит следующим образом:

[source,javascript]
----
include::{sourcesdir}/chart/column3d-chart.js[]
----

[[cdb_create_model]]
===== Создание сущности

. Откройте кладку *Entities* в CUBA Studio и нажмите кнопку *New entity*.

. В диалоге создания новой сущности задайте ей имя `CountryGrowth` и выберите тип `Not persistent`, после чего нажмите кнопку *OK*.

. Используя *Entity Designer* добавьте атрибуты:
* `country` типа `String`
* `year2014` типа `Double`
* `year2015` типа `Double`

. Откройте вкладку *Source*, чтобы увидеть сгенерированный код:
+
[source,java]
----
include::{sourcesdir}/chart/CountryGrowth.java[]
----
+
Этот класс описывает не персистентную сущность. Экземпляр этого класса содержит процент роста ВВП старны за 2014 и 2015 года.

. Нажмите кнопку *OK*, чтобы сохранить сущность и закрыть экран дизанера.

. Во вкладке *Entities* нажмите *Generate DB scripts* и сохраните сгенерированные скрипты.

. Создайте базу данных приложения, запустив *Run* -> *Create database*.

[[cdb_creating_chart]]
===== Создание диаграммы

[[cdb_xml_descriptor]]
====== XML-дескриптор экрана

Откройте в CUBA Studio вкладку *Screens* и создайте экран в модуле *web*. Введите значение `com/company/sampler/web/screens/column3d-chart.xml` в поле *Reference*. В полях *Id*, *Controller Name* и *Messages Pack* будут сгенерированы подходящие значения. Сохраните изменения. Далее перейдите на вкладку *XML* и замените ее содержимое на следующий код:

[source, xml]
----
include::{sourcesdir}/chart/column3d-chart.xml[]
----

В корневой элемент дескриптора экрана добавлен атрибут `xmlns:chart`:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
    >
----

Даграмма получает данные из источника `countryGrowthDs`, указанного в атрибуте `datasource`. Для отображения названий и значений используются атрибуты `country`, `year2014` и `year2015` сущности `CountryGrowth`, список экземпляров которой находится в источнике данных.

Компонент `chart:serialChart` содержит следующие атрибуты:

* `angle` - определяет угол наклона диаграммы. Может принимать значения от `0` до `90`.

* `balloonText` - определяет текст всплывающей подсказки при наведении на колонку диаграммы. Доступны для использования тэги `\[[value]]`, `\[[title]]`, `\[[persents]]`, `\[[description]]`, а также ключи из `DataItem`, список которых хранится в экземпляре `DataProvider`, либо имена атрибутов сущности в источнике данных. Для использования `html` тегов, их нужно экранировать.

* `depth3D` - толщина диграммы. При использовании совместно с атрибутом `angle` позволяет создать эффект объема.

* `plotAreaFillAlphas` - степень непрозрачности области графика.

* `startDuration` - длительность анимации в секундах.

* `categoryField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будут взяты значения для подписи оси категорий.

Компонент `chart:serialChart` содержит следующие элементы:

* `chart:categoryAxis` - элемент, описывающий ось категорий.
** Атрибут `gridPosition` определяет будет ли линия сетки расположена по центру ячейки или от ее начала.

* `chart:valueAxes` - элемент, описывающий вертикальные оси значений. В данном случае используется только одна ось, описываемая элементом `chart:axis`
** Атрибут `position` задает положение оси значений относительно диаграммы.
** Установка атрибуту `stackType` значения `BOX_3D` говорит о том, что колонки гистограммы будут расположенны одна позади другой.

* `chart:graphs` - элемент, описывающий графы диаграммы. Граф описывается элементом `chart:graph`.
** Атрибут `type` задает тип графа и может быть: line, column, step line, smoothed line, olhc и candlestick.
** Атрибут `valueField`определяет ключ из набора пар, содержащихся в объектах DataItem, список которых хранится в экземпляре DataProvider, по которому будет взято значение.
** Атрибут `fillAlphas` задает степень непрозрачности заполнения.
** Атрибут `lineAlpha` задает степень непрозрачности линии (или рамки колонки).

* `chart:export` – добавляет возможность сохранить полученный график.

[[cdb_screen_controller]]
====== Контроллер экрана

Перейдите на вкладку *Controller* и замените ее содержимое на следующий код:

[source, java]
----
include::{sourcesdir}/chart/Column3dChart.java[]
----

В Методе `init(Map<String, Object> params)` происходит заполнение источника данных `countryGrowthDs` данными. Метод `refresh()` производит инициализацию источника данных. Этот метод необходимо вызвать, несмотря на атрибут `refreshMode="NEVER"`, установленный в XML-дескрипторе.

[[cdb_result]]
===== Результат

. Откройте вкладку *Main Menu* в CUBA Studio и нажмите кнопку *edit* для `web-menu.xml`.

. Выберите элемент *`application`* и нажмите кнопку *new*.

. В диалоге создания элемента меню выберите `column3d-chart` в поле *id* и нажмите *add*.

. Выполните комманду *Run* -> *Start application server*.

После входа в приложение и открытия экрана из меню приложения, вы увидите диаграмму, как показанно ниже:

.Трехмерная гистограмма
image::chart/column3d-chart.svg[align="center"]

[[chart_with_data_provider]]
==== Создание диаграммы с данными из DataProvider

Данная диаграмма получает данные из экземпляра `DataProvider`, создаваемого в контроллере экрана, поэтому атрибут `datasource` не определен.

[[cdp_creating_chart]]
===== Создание диаграммы

[[cdp_xml_descriptor]]
====== XML-дескриптор экрана

Откройте в CUBA Studio вкладку *Screens* и создайте экран в модуле *web*. Введите значение `com/company/sampler/web/screens/stackedarea-chart.xml` в поле *Reference*. В полях *Id*, *Controller Name* и *Messages Pack* будут сгенерированы подходящие значения. Сохраните изменения. Далее перейдите на вкладку *XML* и замените ее содержимое на следующий код:

[source, xml]
----
include::{sourcesdir}/chart/stackedarea-chart.xml[]
----

В корневой элемент дескриптора экрана добавлен атрибут `xmlns:chart`:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
>
----

Компонент `chart:serialChart` содержит следующие атрибуты:

* `categoryField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будут взяты значения для подписи оси категорий.

Компонент `chart:serialChart` содержит следующие элементы:

* `chart:chartCursor` - необязательный элемент, добавляющий курсор к диаграмме. Курсор следует за указателем мыши и показывает всплывающие подсказки со значениями элементов диаграммы над которыми находится указатель мыши.
** Атрибут `cursorAlpha` задает степень непрозрачности линий курсора.

* `chart:legend` - определяет легенду графика.
** Атрибут `position` определяет положение легенды относительно диаграммы.
** Атрибут `equalWidths` определяет должны ли все элементы легенды быть такой же ширины как самый широкий.
** Атрибут `periodValueText` задает текст, который будет показан в значении легенды, когда пользователь не раполагает указатель мыши ни над одним элементом данных. Теги должны состоять из пары значений - название поля (value / open / close / high / low) и значение периода, для которого дожно быть показано значение - open / close / high / low / sum / average / count.
** Атрибут `valueAlign` задает выранивание значения. Возможные значения "left" и "right".
** Атрибут `valueWidth` задает ширину значения.

* `chart:valueAxes` - элемент, описывающий вертикальные оси значений. В данном случае используется только одна ось, описываемая элементом `chart:axis`
** Атрибут `position` задает положение оси значений относительно диаграммы.
** Атрибут `title` задает заголовок оси значения.
** Установка атрибуту `stackType` значения `REGULAR` говорит о том, что используется диаграмма с накоплением. По умолчанию значение этого атрибута - `none`, в таком случае используется диаграмма без накопления.
** Атрибут `gridAlpha` задает степень непрозрачности линий сетки.

* `chart:graphs` - элемент, описывающий графы диаграммы. Граф описывается элементом `chart:graph`.
** Атрибут `type` задает тип графа и может быть: line, column, step line, smoothed line, olhc и candlestick.
** Атрибут `valueField` определяет ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будет взято значение.
** Атрибут `fillAlphas` задает степень непрозрачности заполнения.
** Атрибут `lineAlpha` задает степень непрозрачности линии (или рамки колонки).
** Атрибут `hidden` определяет будет ли граф отображаться.

* `chart:categoryAxis` - элемент, описывающий ось категорий.
** Установка атрибуту `startOnAxis` значения `true` дает указание начинать отрисовывать график сразу от оси значений. По умолчанию этот атрибут имеет значение `false`. В этом случае между осью значений и графиком имеется некоторый помежуток.
** Атрибут `gridAlpha` задает степень непрозрачности линий сетки.
** Атрибут `axisColor` задает цвет оси.

* `chart:export` – добавляет возможность сохранить полученный график.

[[cdp_screen_controller]]
====== Контроллер экрана

Перейдите на вкладку *Controller* и замените ее содержимое на следующий код:

[source,java]
----
include::{sourcesdir}/chart/StackedAreaChart.java[]
----

В методе `init(Map<String, Object> params)` происходит установка данных в диаграмму с накоплением. Диаграммы подобного типа показывают отношение отдельных составляющих к их совокупному значению.

[[cdp_result]]
===== Результат

. Откройте вкладку *Main Menu* в CUBA Studio и нажмите кнопку *edit* для `web-menu.xml`.

. Выберите элемент *`application`* и нажмите кнопку *new*.

. В диалоге создания элемента меню выберите `stackedarea-chart` в поле *id* и нажмите *add*.

. Выполните комманду *Run* -> *Start application server*.

После входа в приложение и открытия экрана из меню приложения, вы увидите диаграмму, как показанно ниже:

.Диаграмма с накоплением
image::chart/stackedarea-chart.svg[align="center"]

[[section_use_of_events]]
==== Использование событий

Проиллюстрируем использование событий. Добавим в экран, созданный в разделе <<cdb_creating_chart>>, обработку события нажатия на элемент графа. Откройте XML-дескриптор экрана в IDE, затем инжектируйте диаграмму:

[source, java]
----
@Inject
    private Chart pieChart;
----

Далее добавьте слушателя в конце метода `init(Map<String, Object> params)`:

[source, java]
----
include::{sourcesdir}/chart/GraphItemClickListener.java[]
----

Для просмотра результата пересоберите проект командой *Run* -> *Restart application server* и зайдите в систему. Откройте экран и нажмите на одину из колонок гистограммы.

.Диаграмма с обработкой события нажатия на элемент графа
image::chart/chart-with-event.png[align="center", width="1242", height="570"]

