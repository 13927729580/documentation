[[chart]]
== Отображение диаграмм

Подсистема отображения диаграмм платформы CUBA поддерживает большое количество типов диаграмм: круговые, линейные, пузырьковые, лепестковые, диаграммы с накоплением и прочие. Имеется возможность экспорта диаграмм. Для большинства типов диаграмм поддерживается прокрутка и зуммирование. Подсистема отображения диаграмм работает только в веб-клиенте.

Библиотека AmCharts, на которой основана реализация подсистемы отображения диаграмм, распространяется по лицензии, позволяющей использовать ее бесплатно при сохранении ссылки на сайт библиотеки. Для своего проекта Вы можете http://www.amcharts.com/online-store/[купить^] лицензию на AmCharts и убрать ссылку.

[[chart_dependency]]
=== Добавление диаграмм в проект
Для использования диаграмм в Вашем проекте, необходимо активировать элемент *charts* в списке *App components* на экране редактирования свойств проекта (секция *Project properties*, кнопка *Edit*) в CUBA Studio.

[[chart_configuration]]
=== Конфигурация диаграмм

Для отображения диаграмм используется компонент `Chart`, являющийся универсальным холстом. Вид диаграммы задается с помощью конкретного интерфейса <<chart_types,типа диаграммы>>, унаследованного от `Chart`.

Диаграммы можно описывать как в XML-дескрипторе, так и в контроллере экрана. Для описания в дескрипторе необходимо подключить соответствующий `namespace`:

[source, xml]
----
<window xmlns="http://schemas.haulmont.com/cuba/window.xsd"
        xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
        ...>
----

Соответствие элементов XML видам диаграмм:

* `chart:xyChart` - <<xy_chart,XYChart>>
* `chart:serialChart` - <<serial_chart,SerialChart>>
* `chart:pieChart` - <<pie_chart,PieChart>>
* `chart:funnelChart` - <<funnel_chart,FunnelChart>>
* `chart:gaugeChart` - <<gauge_chart,AngularGaugeChart>>
* `chart:radarChart` - <<radar_chart,RadarChart>>
* `chart:ganttChart` - <<gantt_chart,GanttChart>>
* `chart:stockChart` - <<stock_chart,StockChart>>

Каждый вид диаграммы имеет свой набор атрибутов и методов, которые повторяют функционал соответствующих диаграмм библиотеки AmCharts. Документация по свойствам и методам диаграмм находится по адресу http://docs.amcharts.com/3/javascriptcharts[docs.amcharts.com/3/javascriptcharts^].

[[chart_renderingDelay]]
По умолчанию, все диаграммы уже отрисованы на момент открытия экрана. Чтобы отложить отрисовку и показать пользователю анимацию построения диаграммы, вы можете использовать атрибут `renderingDelay`. Этот атрибут позволяет указать задержку отрисовки в миллисекундах и доступен для всех типов диаграмм, кроме <<stock_chart,StockChart>>.

[source, xml]
----
<chart:pieChart id="pieChart"
                renderingDelay="1000.25">
----

Следующие элементы можно использовать для декларативной конфигурации всех типов диаграмм:

[[chart_allLabels]]
* `chart:allLabels` - содержит вложенные элементы `label`, в которых можно указать текст надписи и его свойства. Надписи можно размещать в любой месте на диаграмме, например:
+
--

image::chart/charts_allLabels.png[align="center"]

[source, xml]
----
<chart:allLabels>
    <chart:label x="200"
                 y="700"
                 text="You can place a label at any position on the chart"
                 color="DARKBLUE"
                 align="CENTER"
                 rotation="-30"/>
</chart:allLabels>
----
--

[[chart_balloon]]
* `chart:balloon` - задаёт настройки всплывающих пузырьковых подсказок, появляющихся при наведении курсора мыши на элемент данных диаграммы. Например:
+
--
image::chart/charts_balloon.png[align="center"]

[source, xml]
----
<chart:graphs>
    <chart:graph balloonText="[[category]]: [[value]] m/s"
                 bullet="ROUND"
                 fillAlphas="0.3"
                 valueField="value"/>
</chart:graphs>
<chart:balloon adjustBorderColor="false"
               color="WHITE"
               horizontalPadding="10"
               verticalPadding="8"/>
----

Текст подсказки указывается в атрибуте `balloonText` для каждого графа.

[[chart_additionalFields]]
** `additionalFields`
+
Для подстановки данных можно использовать все поля, уже использованные в диаграмме, такие как `titleField`, `valueField`, `category`, `value`, `description`, `percents`, `open` и т.п., а также теги HTML.
+
Кроме того, вы можете использовать и другие атрибуты сущности из источника данных диаграммы с помощью атрибута `additionalFields`. Этот атрибут позволяет добавить отдельные атрибуты сущности к запросу данных для диаграммы и передать их значения в UI, чтобы вы могли прямо использовать имена атрибутов сущностей в конфигурации диаграммы.
+
В следующем примере `title` - это заголовок графа, `category` - значение по оси категорий, `value` значение по оси значений, а `optional` - атрибут сущности `IncomeExpenses`, загруженный для подстановки в `balloonText`:
+
[source, xml]
----
<chart:serialChart additionalFields="optional"
                   addClassNames="true"
                   categoryField="year"
                   datasource="incomeExpensesDs"
                   startDuration="1">
   <chart:graphs>
        <chart:graph alphaField="alpha"
                     balloonText="&lt;span style='font-size:12px;'&gt;[[title]] in [[category]]:&lt;br&gt;
                     &lt;span style='font-size:20px;'&gt;[[value]]&lt;/span&gt; [[optional]]&lt;/span&gt;"
                     dashLengthField="dashLengthColumn"
                     title="Income"
                     type="COLUMN"
                     valueField="income"/>
        <...>
   </chart:graphs>
</chart:serialChart>
----
+
image::chart/charts_balloon_additiional.png[align="center"]
+
Список дополнительных полей можно указать декларативно через запятую:
+
[source, xml]
----
additionalFields="income,expense,vat"
----
+
или же передать список в контроллере экрана:
+
[source, java]
----
List<String> fields = Arrays.asList("income", "expense", "vat");
ganttChart.setAdditionalFields(fields);
----
--

[[chart_chartScrollbar]]
* `chart:chartScrollbar` (для диаграмм с типом <<serial_chart>> и <<xy_chart>>) - полоса прокрутки диаграммы.
+
--
* Можно использовать скроллбар для прокрутки конкретного графа:
+
image::chart/charts_zoom.png[align="center"]
+
[source, xml]
----
<chart:chartScrollbar graph="g1"
                      autoGridCount="true"
                      scrollbarHeight="30"/>
----

* Элемент `chart:chartScrollbarSettings` позволяет настроить конфигурацию полосы прокрутки:
+
[source, xml]
----
<chart:chartScrollbarSettings graph="stockGraph"
                              usePeriod="10mm"
                              position="TOP"/>
----

* Кроме того, диаграммы с типом <<gantt_chart>> могут дополнительно иметь элемент `chart:valueScrollbar` для прокрутки оси значений, в то время как `chart:chartScrollbar` будет использоваться для зуммирования оси категорий:
+
image::chart/charts_valueScrollBar.png[align="center"]
+
[source, xml]
----
<chart:valueScrollbar autoGridCount="true"
                      color="BLACK"/>
<chart:chartScrollbar autoGridCount="true"
                      color="DARKOLIVEGREEN"/>
----
--

[[chart_cursor]]
* `chart:cursor` - необязательный элемент для добавления курсора к диаграмме. Курсор следует за указателем мыши и отображает пузырьковые подсказки с данными в соответствующей точке диаграммы.
+
--
image::chart/charts_cursor.png[align="center"]

[source, xml]
----
<chart:chartCursor cursorAlpha="1"
                   cursorColor="#258cbb"
                   cursorPosition="MOUSE"
                   limitToGraph="g1"
                   pan="true"
                   valueLineAlpha="0.2"
                   valueLineBalloonEnabled="true"
                   valueLineEnabled="true"
                   valueZoomable="true"/>
----
--

* `chart:data` - необязательный элемент для <<chart_data,добавления данных>>, используется преимущественно для прототипирования диаграмм.

* `chart:export` - необязательный элемент для подключения функциональности <<chart_export,экспорта диаграмм>>. Реализация экспорта по умолчанию представляет собой кнопку *download* в углу диаграммы:
+
image::chart/charts_export.png[align="center"]

[[chart_guides]]
* `chart:guides` - горизонтальные/вертикальные направляющие.
+
--
image::chart/charts_guides.png[align="center"]

[source, xml]
----
<chart:guides>
    <chart:guide category="2001"
                 dashLength="2"
                 fillAlpha="0.2"
                 fillColor="#CC0000"
                 inside="true"
                 label="fines for speeding increased"
                 labelRotation="90"
                 toCategory="2003"/>
    <chart:guide category="2007"
                 dashLength="2"
                 inside="true"
                 label="motorcycle fee introduced"
                 labelRotation="90"
                 lineAlpha="1"
                 lineColor="#CC0000"/>
</chart:guides>
----
--

[[chart_legend]]
* `chart:legend` - элемент, описывающий легенду диаграммы, например:
+
--
image::chart/charts_legend.png[align="center"]

[source, xml]
----
<chart:legend autoMargins="false"
              marginRight="20"
              markerType="CIRCLE"
              position="RIGHT"
              valueText="[[category]]: [[value]] %"/>
----
--

* `chart:nativeJson` - <<custom_json,JSON-конфигурация>> диаграммы.

[[chart_titles]]
* `chart:titles` - заголовки осей, например:
+
--
image::chart/charts_titles.png[align="center"]
[source, xml]
----
<chart:titles>
    <chart:title alpha="1"
                 bold="true"
                 color="DARKSLATEGREY"
                 size="20"
                 tabIndex="0"
                 text="Main title"/>
    <chart:title alpha="0.5"
                 color="BISQUE"
                 size="12"
                 text="Subtitle"/>
</chart:titles>
----
--

[[chart_responsive]]
* `chart:responsive` - подключение плагина, позволяющего сделать диаграммы отзывчивыми.
+
--
Он позволяет на лету изменять внешний вид диаграммы, автоматически подстраивая её под изменения разрешения экрана. Больше информации о плагине `responsive` вы можете найти на https://www.amcharts.com/kbase/making-charts-responsive/[сайте AmCharts].

Элемент `responsive` содержит вложенные элементы `rules`, в которых задаются правила отклика диаграмм. Вы можете настроить скрытие/отображение легенды, заголовков осей, разделителей, заголовков диаграмм, ползунков масштаба, перемещение подписей с осей внутрь графика и т.п.:

[source,xml]
----
include::{sourcesdir}/chart/responsive.xml[]
----
--

Все атрибуты конфигурации могут иметь значение `null`, вместо таких значений будут использоваться значения по умолчанию (кроме случаев, указанных в документации AmCharts).

Таким же образом можно описывать диаграммы в контроллере экрана. Можно как указывать отдельные свойства, так и добавлять составные объекты:

[source,java]
----
include::{sourcesdir}/chart/chart_configure.java[]
----

[[chart_export]]
=== Экспорт диаграмм

Диаграммы могут быть экспортированы из работающего приложения в формате изображения или исходных данных. Для создания меню экспорта используется элемент `chart:export`, включающий по умолчанию следующие атрибуты:

* *Download as...* с доступными форматами: PNG, JPG, SVG, PDF
* *Save as...* с доступными форматами: CSV, XLSX, JSON
* *Annotate...*, используемый для добавления заметок и векторных аннотаций. Информацию о плагине для создания аннотаций вы можете найти https://www.amcharts.com/export-now-supports-annotating-charts-with-text-icons-arrows/[здесь].
* *Print*, открывающий стандартное окно отправки страницы на печать.

image::chart/charts_export_menu_1.png[align="center"]

Меню экспорта может быть настроено для ограничения доступа пользователей к данным диаграммы, например:

[source,xml]
----
include::{sourcesdir}/chart/chart_export_menu.xml[]
----

В этом случае пользователю будут доступны только кнопки для прямого скачивания диаграммы в заданных форматах:

image::chart/charts_export_menu_2.png[align="center"]

Вы можете задать следующие свойства экспорта:

* `backgroundColor` - цвет фона экспортируемого изображения. По умолчанию `#FFFFFF`.
* `dataDateFormat` - формат конвертации строк, содержащих даты, в объект даты. Применимо только к экспорту данных.
* `dateFormat` - форматирование даты в подписи категории в указанном формате (только экспорт данных).
* `enabled` - разрешает или запрещает возможность экспорта.
* `exportSelection` - экспорт только выбранного диапазона данных. По умолчанию `false`.
* `exportTitles` - заменяет имена полей их заголовками. По умолчанию `false`.
* `fileListener` - если выбрано значение `true`, позволяет перетащить файл с изображением и добавить его к аннотации. По умолчанию `false`.
* `fileName` - имя генерируемого файла (расширение будет добавлено в зависимости от выбранного типа экспорта).
* `keyListener` - если выбрано значение `true`, слушатель нажатия клавиш позволит отменять/повторять введённые аннотации.
* `position` - расположение кнопки экспорта. Доступные значения: `TOP_LEFT`, `TOP_RIGHT` (DEFAULT), `BOTTOM_LEFT`, `BOTTOM_RIGHT`.
* `removeImages` - если выбрано значение `true`, при экспорте будут удалены лишние изображения, загруженные из различных источников.

Следующие свойства можно настроить для каждого конкретного формата экспорта:

JPG::
+
* `quality` - качество конечного изображения. Возможные значения 0 - 1. Значение по умолчанию 1.

PNG, JPG, SVG, PDF::
+
* `multiplier` - коэффициент масштабирования конечного изображения относительно исходного размера.

CSV::
+
--
* `quotes` - опрелеляет, нужно ли заключать значения в кавычки. Значение по умолчанию `true`.
* `delimiter` - символ, используемый в качестве разделителя. По умолчанию "," (запятая).
* `escape` - определяет, нужно ли экранировать строки. Значение по умолчанию `true`.
* `withHeader` - добавляет строку заголовков с именами колонок. Значение по умолчанию `true`.
--


XLSX::
+
--
* `dateFormat` - маска формата даты XLSX. Требует значения `true` для свойства `parseDates` в CategoryAxis.
* `stringify` - приведение всего содержимого ячеек к строке. Значение по умолчанию `false`.
* `withHeader` - добавляет строку заголовков с именами колонок. Значение по умолчанию `true`.
--

PDF::
+
--
* `pageOrientation` - ориентация страницы. По умолчанию `PORTRAIT`.
* `pageOrigin` - показывает или скрывает источник генерируемого файла PDF. По умолчанию `true`.
* `pageSize` - размер страницы PDF. По умолчанию `A4`.

Кроме того, вы можете переопределить строку сообщения `label.saved.from` в главном пакете сообщений.
--

PRINT::
* `delay` - задержка перед началом печати в секундах.
* `lossless` - разрешает или запрещает оптимизацию изображения при печати. По умолчанию `false`.

[[chart_data_binding]]
=== Связь с данными

Реализовано три варианта передачи данных в диаграмму: через интерфейс `DataProvider`, через механизм источников данных, или с использованием <<chart_data_simplified,упрощённого API>>, позволяющего привязывать данные напрямую при помощи метода `addData()` и удобных конструкторов класса `MapDataItem`. Последний способ подходит для диаграмм, не привязанных к какому-либо источнику данных.

[[chart_data_provider]]
DataProvider: ::
+
--
Интерфейс `DataProvider` имеет стандартную реализацию: класс `ListDataProvider`. Он содержит список экземпляров `DataItem` из которых будут браться данные для диаграммы. Существует несколько стандартных реализаций интерфейса `DataItem`:

* `EntityDataItem` принимает экземпляр сущности.
* `MapDataItem` содержит набор пар ключ-значение.
* `SimpleDataItem` принимает экземпляр любого `public` класса.

Экземпляр `DataProvider` передается методу `setDataProvider()` конфигурации диаграммы. Данный способ предоставления данных для диаграммы наиболее универсален, однако требует создания экземпляров `DataProvider` и `DataItem` в коде контроллера экрана.
--

[[chart_datasource]]
Datasource: ::
+
--
Источник данных типа `CollectionDatasource` устанавливается для компонента `Chart` вызовом метода `setDatasource()`. Данный вариант требует наличия сущности, представляющей данные диаграммы. Он удобен, когда такая сущность уже есть в модели данных приложения, а также когда данные диаграммы нужно отобразить и в виде таблицы.

В главе <<chart_example>> проиллюстрированы все три способа получения данных.

Используемые для отображения свойства сущности или значения, содержащиеся в экземпляре `DataProvider`, задаются в атрибутах диаграммы, причем атрибуты различаются для разных типов диаграмм. Например для компонента `chart:pieChart` необходимо задать атрибуты `valueField` и `titleField`.В качестве значений могут выступать типы `Integer`, `Long`, `Double`, `String`, `Boolean`, `Date`.

Динамическое добавление данных в существующий график поддерживается для обоих механизмов.
--

[[chart_data]]
Элемент chart:data: ::
+
--
Этот способ удобен для быстрого прототипирования диаграмм. Элемент `chart:data` и вложенные в него элементы `item` позволяют вручную указать фиксированные значения прямо в XML-дескрипторе диаграммы, например:

[source, xml]
----
<chart:pieChart id="pieChart"
                titleField="key"
                valueField="value">
    <chart:data>
        <chart:item>
            <chart:property name="key" value="piece of apple pie"/>
            <chart:property name="value" value="70" type="int"/>
        </chart:item>
        <chart:item>
            <chart:property name="key" value="piece of blueberry pie"/>
            <chart:property name="value" value="20" type="int"/>
        </chart:item>
        <chart:item>
            <chart:property name="key" value="piece of cherry pie"/>
            <chart:property name="value" value="10" type="int"/>
        </chart:item>
    </chart:data>
</chart:pieChart>
----
--

[[chart_listeners]]
=== События

Имеется возможность настроить реакцию на различные типы событий. Следующие типы слушателей событий доступны для всех видов диаграмм:

* `LegendItemHideListener` - скрытие элемента легенды.
* `LegendItemShowListener` - показ элемента легенды.
* `LegendLabelClickListener` - щелчок по ярлыку легенды.
* `LegendMarkerClickListener` - щелчок по маркеру легенды.

Для каждого вида диаграмм также доступны свои типы слушателей, описанные в соответствующих <<chart_types,разделах>> документации.

Пример использования событий проиллюстрирован в разделе <<section_use_of_events>>.

Чтобы мигрировать старый код, в котором используются слушатели событий, на новую версию платформы, необходимо привести компонент `Chart` к конкретному типу диаграммы или заново инжектировать его с конкретным типом диаграммы:
[source,java]
----
@Inject
private Chart pieChart;
----
[source,java]
----
((PieChart)pieChart).addSliceClickListener(event -> {});
----

Кроме обработки событий, интерфейс `SeriesBasedChart` содержит методы `zoomOut`, `zoomToIndexes` и `zoomToDates` для манипуляций с осями диаграммы.

Подобные методы для управления осями значений также есть и в интерфейсе `CoordinateChart`: `zoomOutValueAxes`, `zoomOutValueAxis`, `zoomOutValueAxis`, `zoomValueAxisToValues` и `zoomValueAxisToValues`.


[[chart_types]]
=== Типы диаграмм
Существует несколько типов диаграмм, поддерживаемых платформой.

.Иерархия видов диаграмм
image::chart/charts_hierarchy_diagram.png[align="center"]

Эти интерфейсы представлены в виде готовых компонентов:

* <<gauge_chart,AngularGaugeChart>>,
* <<funnel_chart,FunnelChart>>,
* <<gantt_chart,GanttChart>>,
* <<pie_chart,PieChart>>,
* <<radar_chart,RadarChart>>,
* <<serial_chart,SerialChart>>,
* <<xy_chart,XYChart>>.

Все компоненты содержат константу `NAME`, таким образом, поддерживается их создание с помощью `ComponentsFactory`.

[[gauge_chart]]
==== AngularGaugeChart

Компонент `AngularGaugeChart` позволяет вам создать диаграмму-спидометр.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=gauge-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.GaugeChart
image::chart/gauge-chart.svg[align="center", width="800"]

XML-имя компонента: `chart:gaugeChart`.

Элементы `chart:gaugeChart`: ::
+
--
* `arrows` - содержит вложенные элементы `arrow` со стрелками осей.
+
[source, xml]
----
<chart:arrows>
    <chart:arrow value="60"/>
</chart:arrows>
----

* `axes` - содержит вложенные элементы `axis` для осей диаграммы.
+
[source, xml]
----
<chart:axes>
    <chart:axis id="blue"
                axisColor="#67b7dc"
                axisThickness="3"
                gridInside="false"
                inside="false"
                radius="100%"
                valueInterval="20"
                tickColor="#67b7dc"/>
    <chart:axis labelsEnabled="true"
                axisColor="#fdd400"
                axisThickness="3"
                endValue="160"
                radius="80%"
                valueInterval="20"
                tickColor="#fdd400"/>
</chart:axes>
----
+
Элемент `band` позволяет разделить ось на несколько полос, как на изображении выше:
+
[source, xml]
----
<chart:axes>
    <chart:axis axisAlpha="0.2"
                axisThickness="1"
                bottomText="60 km/h"
                bottomTextYOffset="-20"
                endValue="220"
                tickAlpha="0.2"
                valueInterval="20">
        <chart:bands>
            <chart:band color="#84b761"
                        endValue="90"
                        startValue="0"/>
            <chart:band color="#fdd400"
                        endValue="130"
                        startValue="90"/>
            <chart:band color="#cc4748"
                        endValue="220"
                        innerRadius="95%"
                        startValue="130"/>
        </chart:bands>
    </chart:axis>
</chart:axes>
----
+
Атрибуты `endValue` и `startValue` определяют диапазон значений на шкале диаграммы, атрибут `valueInterval` задаёт шаг деления шкалы.
--

Слушатели событий `AngularGaugeChart`: ::
+
--
* `ChartClickListener` - щелчок по холсту.
* `ChartRightClickListener` - щелчок по холсту правой клавишей мыши.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmAngularGauge[документацию AmCharts].

[[funnel_chart]]
==== FunnelChart

Компонент `FunnelChart` позволяет вам создать пирамиды или конусы.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=funnel3d-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.FunnelChart
image::chart/funnel-chart.svg[align="center", width="800"]

XML-имя компонента: `chart:funnelChart`.

Связь с данными: ::
+
--
. Через датасорс.
+
Вы можете указать для диаграммы источник данных с типом `CollectionDatasource`, а затем указать нужные поля в атрибутах `titleField` и `valueField` элемента `funnelChart`:
+
[source, xml]
----
<chart:funnelChart id="ratingChart"
                   align="MIDDLE_CENTER"
                   datasource="ratingDs"
                   height="200px"
                   labelPosition="RIGHT"
                   labelText="[[title]]: [[value]]"
                   marginRight="120"
                   maxLabelWidth="110"
                   marginTop="20"
                   titleField="mechanic"
                   valueField="count"
                   width="500px">
</chart:funnelChart>
----

. С помощью элемента `chart:data`.
+
Элементы `item` позволяют вручную указать фиксированные значения диаграммы.
+
[source, xml]
----
<chart:funnelChart id="ratingChart"
                   titleField="mechanic"
                   valueField="count">
    <chart:data>
        <chart:item>
            <chart:property name="mechanic" value="Jack"/>
            <chart:property name="count" value="1" type="int"/>
        </chart:item>
        <chart:item>
            <chart:property name="mechanic" value="Bob"/>
            <chart:property name="count" value="2" type="int"/>
        </chart:item>
        <chart:item>
            <chart:property name="mechanic" value="Sam"/>
            <chart:property name="count" value="3" type="int"/>
        </chart:item>
    </chart:data>
</chart:funnelChart>
----
--

Слушатели событий `FunnelChart`: ::
+
--
* `SliceClickListener` - щелчок по элементу круговой диаграммы.
* `SlicePullInListener` - элемент круговой диаграммы соединён с диаграммой.
* `SlicePullOutListener` - элемент круговой диаграммы отсоединён от диаграммы.
* `SliceRightClickListener` - щелчок по элементу круговой диаграммы правой клавишей мыши.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmFunnelChart[документацию AmCharts].

[[gantt_chart]]
==== GanttChart

Компонент `GanttChart` позволяет вам создать диаграмму Ганта.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=gantt-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.GanttChart
image::chart/gantt-chart.svg[align="center", width="800"]

XML-имя компонента: `chart:ganttChart`.

Элементы `chart:ganttChart`: ::
+
--
* `categoryAxis` - элемент, описывающий ось категорий.

* `graph` - элемент, содержащий коллекцию вложенных элементов `chart:graph`, описывающих графы диаграммы.
+
** атрибут `type` определяет тип графа и может быть: линией, столбцом, пунктиром, кривой, OHLC и японской свечой.
+
** атрибут `valueField` указывает ключ из коллекции пар ключ-значение, полученной из источника данных или data provider.

* `valueAxis` - элемент, описывающий ось значений. Если данные диаграммы основаны на значениях дат или времени, для оси значений можно указать тип  `date`.
--

Атрибуты `chart:ganttChart`: ::
+
--
* `segmentsField` - поле сегментов диаграммы.

* `additionalSegmentFields` - список дополнительных полей для сегментов, соответствующих некоторым атрибутам сущности, которые необходимо дополнительно загрузить из источника данных диаграммы. Этот атрибут используется аналогично атрибуту <<chart_additionalFields,additionalFields>>.

* `endField`/`endDateField` - конечное значение или конечная дата диаграммы.

* `startField`/`startDateField` - начальное значение или начальная дата диаграммы.

* `startDate` - начальная дата диаграммы, если выбран тип оси `date`.

* `categoryField` - поле категорий диаграммы.
--

Связь с данными: ::
+
--
Вы можете указать для диаграммы источник данных с типом `CollectionDatasource`. В примере ниже атрибуты `start` и `end` сущности указаны в качестве значений атрибутов `startDateField` и `endDateField` диаграммы:

[source, xml]
----
<chart:ganttChart id="ganttChart"
                  additionalSegmentFields="task"
                  balloonDateFormat="JJ:NN"
                  brightnessStep="7"
                  categoryField="category"
                  colorField="color"
                  columnWidth="0.5"
                  datasource="taskSpansDs"
                  endDateField="end"
                  height="100%"
                  marginRight="70"
                  period="DAYS"
                  rotate="true"
                  segmentsField="segments"
                  startDate="2016-01-01"
                  startDateField="start"
                  theme="LIGHT"
                  width="100%">
    <chart:graph balloonText="&lt;strong&gt;[[task]]&lt;/strong&gt;: [[open]] - [[value]]"
                 fillAlphas="1"
                 lineAlpha="1"
                 lineColor="WHITE"/>
    <chart:valueAxis type="DATE"/>
    <chart:valueScrollbar autoGridCount="true"
                          color="BLACK"/>
    <chart:chartCursor cursorAlpha="0"
                       cursorColor="#55bb76"
                       fullWidth="true"
                       valueLineAlpha="0.5"
                       valueBalloonsEnabled="false"
                       valueLineBalloonEnabled="true"
                       valueLineEnabled="true"
                       valueZoomable="true"
                       zoomable="false"/>
    <chart:export/>
</chart:ganttChart>
----
--

Слушатели событий `GanttChart`: ::
+
--
* `AxisZoomListener` - масштабирование оси графика.
* `CategoryItemClickListener` - щелчок по категории на оси категорий.
* `ChartClickListener` - щелчок по холсту.
* `ChartRightClickListener` - щелчок по холсту правой клавишей мыши.
* `CursorPeriodSelectListener` - выбор периода отображения курсором.
* `CursorZoomListener` - масштабирование области графика курсором.
* `GraphClickListener` - щелчок по графику.
* `GraphItemClickListener` - щелчок по элементу графика.
* `GraphItemRightClickListener` - щелчок по элементу графика правой клавишей мыши.
* `ZoomListener` - масштабирование холста.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmGanttChart[документацию AmCharts].

[[pie_chart]]
==== PieChart

Компонент `PieChart` позволяет вам создать круговые диаграммы.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=pie3d-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.PieChart
image::chart/pie-chart.svg[align="center", width="800"]

XML-имя компонента: `chart:pieChart`.

Связь с данными: ::
+
--
. Через датасорс.
+
Вы можете указать для диаграммы источник данных с типом `CollectionDatasource`, а затем указать нужные поля в атрибутах `titleField` и `valueField` элемента `pieChart`:
+
[source, xml]
----
<chart:pieChart id="pieChart"
                datasource="countryLitresDs"
                height="100%"
                titleField="country"
                valueField="litres"
                width="100%"/>
----

. С помощью элемента <<chart_data,chart:data>>.
--

Слушатели событий `PieChart`: ::
+
--
* `ChartClickListener` - щелчок по холсту.
* `ChartRightClickListener` - щелчок по холсту правой клавишей мыши.
* `SliceClickListener` - щелчок по элементу круговой диаграммы.
* `SlicePullInListener` - элемент круговой диаграммы соединён с диаграммой.
* `SlicePullOutListener` - элемент круговой диаграммы отсоединён от диаграммы.
* `SliceRightClickListener` - щелчок по элементу круговой диаграммы правой клавишей мыши.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmPieChart[документацию AmCharts].

[[radar_chart]]
==== RadarChart

Компонент `RadarChart` позволяет вам создать радиальные/сетчатые диаграммы.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=polar-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.RadarChart
image::chart/radar-chart.svg[align="center", width="800"]

XML-имя компонента: `chart:radarChart`.

Связь с данными: ::
+
--
Вы можете указать для диаграммы источник данных с типом `CollectionDatasource`, а затем указать нужные поля в качестве значений атрибутов `categoryField` элемента `radarChart` и `valueField` вложенного элемента `graph`:

[source, xml]
----
<chart:radarChart id="radarChart"
                  categoryField="country"
                  datasource="countryLitresDs"
                  height="100%"
                  startDuration="2"
                  theme="LIGHT"
                  width="100%">
    <chart:graphs>
        <chart:graph balloonText="[[value]] litres of beer per year"
                     bullet="ROUND"
                     valueField="litres"/>
    </chart:graphs>
</chart:radarChart>
----
--

Слушатели событий `RadarChart`: ::
+
--
* `AxisZoomListener` - масштабирование оси графика.
* `ChartClickListener` - щелчок по холсту.
* `ChartRightClickListener` - щелчок по холсту правой клавишей мыши.
* `GraphClickListener` - щелчок по графику.
* `GraphItemClickListener` - щелчок по элементу графика.
* `GraphItemRightClickListener` - щелчок по элементу графика правой клавишей мыши.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmRadarChart[AmCharts documentation].

[[serial_chart]]
==== SerialChart

Компонент `SerialChart` позволяет вам создать большое количество диаграмм: линейчатые, диаграммы с областями, гистограммы, диаграммы с накоплением и прочие. Такие диаграммы поддерживают несколько осей в простом или логарифмическом масштабе. Данные могут быть отображены на равных/неравных отрезках или на временной шкале.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=line-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.SerialChart в виде линейного графика
image::chart/line-chart.png[align="center", width="800"]

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=columnline-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.SerialChart в виде гистограммы
image::chart/column-chart.svg[align="center", width="800"]

XML-имя компонента: `chart:serialChart`.

Связь с данными: ::
+
--
Вы можете указать для диаграммы источник данных с типом `CollectionDatasource`, а затем указать нужные поля в качестве значений атрибутов `categoryField` элемента `serialChart` и `valueField` вложенного элемента `graph`:

[source, xml]
----
<chart:serialChart categoryField="date"
                   datasource="dateValueDs">
    <chart:graphs>
        <chart:graph valueField="value"
                     balloonText="[[value]]">
        </chart:graph>
    </chart:graphs>
    <chart:categoryAxis dashLength="1"
                        minorGridEnabled="true"/>
</chart:serialChart>
----
--

Слушатели событий `SerialChart`::
+
--
* `AxisZoomListener` - масштабирование оси графика.
* `CategoryItemClickListener` - щелчок по категории на оси категорий.
* `ChartClickListener` - щелчок по холсту.
* `ChartRightClickListener` - щелчок по холсту правой клавишей мыши.
* `CursorPeriodSelectListener` - выбор периода отображения курсором.
* `CursorZoomListener` - масштабирование области графика курсором.
* `GraphClickListener` - щелчок по графику.
* `GraphItemClickListener` - щелчок по элементу графика.
* `GraphItemRightClickListener` - щелчок по элементу графика правой клавишей мыши.
* `ZoomListener` - масштабирование холста.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmSerialChart[документацию AmCharts].

[[stock_chart]]
==== StockChartGroup

Компонент `StockChartGroup` позволяет вам создать диаграмму с накоплением, или фондовую диаграмму.

Фондовые диаграммы поддерживают несколько наборов данных и имеют готовый к использованию селектор наборов данных. Наборы данных можно сравнивать между собой.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-multiple-datasets" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.StockChart с несколькими наборами данных
image::chart/stock-chart-with-datasets.svg[align="center", width="800"]

Фондовые диаграммы могут отображать различные типы аннотаций на графе или оси. Эти аннотации называются stock events.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-stock-events" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.StockChart содержащий StockEvents
image::chart/stock-chart-with-stockevents.png[align="center", width="800"]

Фондовые диаграммы поддерживают любое количество панелей. Каждая панель может иметь любое количество графов. Каждая панель - это отдельная диаграмма и базируется на <<serial_chart,SerialChart>>. Другими словами, панель может все то же самое, что и эта диаграмма.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-multiple-panels" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.StockChart с несколькими панелями
image::chart/stock-chart-with-panels.png[align="center", width="800"]

Слушатели событий `StockChartGroup`: ::
+
--
* `DataSetSelectorCompareListener` - сравнение селекторов наборов данных.
* `DataSetSelectorSelectListener` - выбор селектора набора данных.
* `DataSetSelectorUnCompareListener` - отмена сравнения селекторов наборов данных.
* `PeriodSelectorChangeListener` - выбор периода отображения при помощи селектора.
* `StockChartClickListener` - щелчок по холсту фондовой диаграммы.
* `StockChartRightClickListener` - щелчок по холсту фондовой диаграммы правой клавишей мыши.
* `StockEventClickListener` - щелчок по событию фондовой диаграммы.
* `StockEventRollOutListener` - разворачивание события фондовой диаграммы.
* `StockEventRollOverListener` - сворачивание события фондовой диаграммы.
* `StockGraphClickListener` - щелчок по фондовой диаграмме.
* `StockGraphItemClickListener` - щелчок по элементу фондовой диаграммы.
* `StockGraphItemRightClickListener` -  щелчок по элементу фондовой диаграммы правой клавишей мыши.
* `StockGraphItemRollOutListener` - разворачивание элемента фондовой диаграммы.
* `StockGraphItemRollOverListener` - сворачивание элемента фондовой диаграммы.
* `StockGraphRollOutListener` - разворачивание фондовой диаграммы.
* `StockGraphRollOverListener` - сворачивание элемента фондовой диаграммы.
* `ZoomListener` - масштабирование холста.
--

[[xy_chart]]
==== XYChart

Компонент `XYChart` позволяет вам создать точечные диаграммы, графики и пузырьковые диаграммы. Такие диаграммы поддерживают несколько осей в простом или логарифмическом масштабе.

++++
<div class="manual-live-demo-container">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=xy-chart" class="live-demo-btn" target="_blank">ДЕМОНСТРАЦИЯ</a>
</div>
++++

.XYChart
image::chart/xy-chart.png[align="center", width="800"]

XML-имя компонента: `chart:xyChart`.

Связь с данными: ::
+
--
Вы можете указать для диаграммы источник данных с типом `CollectionDatasource`, а затем определить атрибуты `xField` и `yFields` для вложенных элементов `graph`:

[source, xml]
----
<chart:xyChart datasource="pointPairDs"
               startDuration="1">
    <chart:graphs>
        <chart:graph balloonText="x:[[x]] y:[[y]]"
                     xField="ax"
                     fillToAxis="x"
                     yField="ay"/>
        <chart:graph balloonText="x:[[x]] y:[[y]]"
                     fillToAxis="y"
                     xField="bx"
                     yField="by"/>
    </chart:graphs>
    <chart:valueAxes>
        <chart:axis id="x"
                    axisAlpha="0"
                    dashLength="1"
                    position="BOTTOM"
                    title="X Axis"/>
        <chart:axis id="y"
                    axisAlpha="0"
                    dashLength="1"
                    position="LEFT"
                    title="Y Axis"/>
    </chart:valueAxes>
</chart:xyChart>
----
--

Слушатели событий `XYChart`: ::
+
--
* `AxisZoomListener` - масштабирование оси графика.
* `ChartClickListener` - щелчок по холсту.
* `CursorPeriodSelectListener` - выбор периода отображения курсором.
* `CursorZoomListener` - масштабирование области графика курсором.
* `GraphClickListener` - щелчок по графику.
* `GraphItemClickListener` - щелчок по элементу графика.
* `GraphItemRightClickListener` - щелчок по элементу графика правой клавишей мыши.
--

Для более подробной информации об этом типе диаграмм см. http://docs.amcharts.com/3/javascriptcharts/AmXYChart[документацию AmCharts].

[[chart_example]]
=== Пример работы с диаграммами

В данной главе мы рассмотрим применение подсистемы отображения диаграмм.

[[chart_project_setup]]
==== Настройка проекта приложения

. Запустите *CUBA Studio*, создайте новый проект и назовите его `sampler`.

. Откройте окно свойств проекта *Project properties* -> *Edit* и в списке *App components* включите проект *charts*, затем сохраните изменения. Studio предложит пересоздать скрипты Gradle - согласитесь.

. Запустите *Run* -> *Deploy*. На этом этапе будет произведена сборка приложения, и оно будет развернуто на сервере Tomcat в подкаталоге `build/tomcat`.

. Запустите *Build* -> *Create or update IDEA project files* чтобы создать проектные файлы для *IntelliJ IDEA*.

После выполнения вышеописанных действий функциональность для отображения диаграмм подключена к приложению и готова к работе. 

[[chart_data_simplified]]
==== Создание диаграммы с использованием Data Binding API

Для первого примера мы создадим максимально простую диаграмму, используя упрощённый API.

Добавим компонент `chart` к экрану. Чтобы наполнить диаграмму данными, используем метод `addData()`. В качестве параметра передадим экземпляры класса `MapDataItem`, содержащие пары ключ-значение:

[source,xml]
----
<chart:pieChart id="pieChart"
                titleField="key"
                valueField="value"/>
----

[source,java]
----
pieChart.addData(MapDataItem.of("key", "piece of apple pie",
                                "value", 70),
                MapDataItem.of("key", "piece of blueberry pie",
                                "value", 20),
                MapDataItem.of("key", "piece of cherry pie",
                                "value", 10));
----

image::chart/chart_simple.png[align="center"]

[[chart_data_from_entity]]
==== Создание диаграммы с данными из сущности

В этом примере мы создадим диаграмму похожую на https://www.amcharts.com/demos/3d-stacked-column-chart/[3D Stacked Column Chart^] из демо AmCharts. `JavaScript` код выглядит следующим образом:

[source,javascript]
----
include::{sourcesdir}/chart/column3d-chart.js[]
----

[[cdb_create_model]]
===== Создание сущности

. Откройте кладку *DATA MODEL* в CUBA Studio и нажмите кнопку *New -> Entity*.

. В диалоге создания новой сущности задайте ей имя `CountryGrowth` и выберите тип `Not persistent`, после чего нажмите кнопку *OK*.

. Используя *Entity Designer* добавьте атрибуты:
* `country` типа `String`
* `year2014` типа `Double`
* `year2015` типа `Double`

. Откройте вкладку *Source*, чтобы увидеть сгенерированный код:
+
[source,java]
----
include::{sourcesdir}/chart/CountryGrowth.java[]
----
+
Этот класс описывает неперсистентную сущность. Экземпляр этого класса содержит процент роста ВВП страны за 2014 и 2015 года.

. Нажмите кнопку *OK*, чтобы сохранить сущность и закрыть экран дизайнера.

[[cdb_creating_chart]]
===== Создание диаграммы

[[cdb_xml_descriptor]]
====== XML-дескриптор экрана

Откройте в CUBA Studio вкладку *GENERIC UI* и создайте экран в модуле *web*. Введите значение `column3d-chart.xml` в поле *Descriptor*. В полях *Id*, *Controller Name* и *Messages Pack* будут сгенерированы подходящие значения. Сохраните изменения. Далее перейдите на вкладку *XML* и замените ее содержимое на следующий код:

[source, xml]
----
include::{sourcesdir}/chart/column3d-chart.xml[]
----

В корневой элемент дескриптора экрана добавлен атрибут `xmlns:chart`:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
    >
----

Диаграмма получает данные из источника `countryGrowthDs`, указанного в атрибуте `datasource`. Для отображения названий и значений используются атрибуты `country`, `year2014` и `year2015` сущности `CountryGrowth`, список экземпляров которой находится в источнике данных.

Компонент `chart:serialChart` содержит следующие атрибуты:

* `angle` - определяет угол наклона диаграммы. Может принимать значения от `0` до `90`.

* `balloonText` - определяет текст всплывающей подсказки при наведении на колонку диаграммы. Доступны для использования тэги `\[[value]]`, `\[[title]]`, `\[[persents]]`, `\[[description]]`, а также ключи из `DataItem`, список которых хранится в экземпляре `DataProvider`, либо имена атрибутов сущности в источнике данных. Для использования `html` тегов, их нужно экранировать.

* `depth3D` - толщина диаграммы. При использовании совместно с атрибутом `angle` позволяет создать эффект объема.

* `plotAreaFillAlphas` - степень непрозрачности области графика.

* `startDuration` - длительность анимации в секундах.

* `categoryField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будут взяты значения для подписи оси категорий.

Компонент `chart:serialChart` содержит следующие элементы:

* `chart:categoryAxis` - элемент, описывающий ось категорий.
** Атрибут `gridPosition` определяет будет ли линия сетки расположена по центру ячейки или от ее начала.

* `chart:valueAxes` - элемент, описывающий вертикальные оси значений. В данном случае используется только одна ось, описываемая элементом `chart:axis`
** Атрибут `position` задает положение оси значений относительно диаграммы.
** Установка атрибуту `stackType` значения `BOX_3D` говорит о том, что колонки гистограммы будут расположены одна позади другой.

* `chart:graphs` - элемент, описывающий графы диаграммы. Граф описывается элементом `chart:graph`.
** Атрибут `type` задает тип графа и может быть: line, column, step line, smoothed line, ohlc и candlestick.
** Атрибут `valueField`определяет ключ из набора пар, содержащихся в объектах DataItem, список которых хранится в экземпляре DataProvider, по которому будет взято значение.
** Атрибут `fillAlphas` задает степень непрозрачности заполнения.
** Атрибут `lineAlpha` задает степень непрозрачности линии (или рамки колонки).

* `chart:export` – добавляет возможность сохранить полученный график.

[[cdb_screen_controller]]
====== Контроллер экрана

Перейдите на вкладку *Controller* и замените ее содержимое на следующий код:

[source, java]
----
include::{sourcesdir}/chart/Column3dChart.java[]
----

В методе `init(Map<String, Object> params)` происходит заполнение источника данных `countryGrowthDs` данными. Метод `refresh()` производит инициализацию источника данных. Этот метод необходимо вызвать, несмотря на атрибут `refreshMode="NEVER"`, установленный в XML-дескрипторе.

[[cdb_result]]
===== Результат

. Откройте ссылку *Open web menu* на вкладке *GENERIC UI* в CUBA Studio.

. Убедитесь, что в меню `application` добавлен элемент `column3d-chart`. Это происходит автоматически при создании нового экрана из Studio.

. Выполните комманду *Run* -> *Start application server*.

После входа в приложение и открытия экрана из меню приложения вы увидите диаграмму, как показано ниже:

.Трехмерная гистограмма
image::chart/column3d-chart.svg[align="center", width="800"]

[[chart_with_data_provider]]
==== Создание диаграммы с данными из DataProvider

Данная диаграмма получает данные из экземпляра `DataProvider`, создаваемого в контроллере экрана, поэтому атрибут `datasource` не определен.

[[cdp_creating_chart]]
===== Создание диаграммы

[[cdp_xml_descriptor]]
====== XML-дескриптор экрана

Откройте в CUBA Studio вкладку *Screens* и создайте экран в модуле *web*. Введите значение `com/company/sampler/web/screens/stackedarea-chart.xml` в поле *Descriptor*. В полях *Id*, *Controller Name* и *Messages Pack* будут сгенерированы подходящие значения. Сохраните изменения. Далее перейдите на вкладку *XML* и замените ее содержимое на следующий код:

[source, xml]
----
include::{sourcesdir}/chart/stackedarea-chart.xml[]
----

В корневой элемент дескриптора экрана добавлен атрибут `xmlns:chart`:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
>
----

Компонент `chart:serialChart` содержит следующие атрибуты:

* `categoryField` - ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будут взяты значения для подписи оси категорий.

Компонент `chart:serialChart` содержит следующие элементы:

* `chart:chartCursor` - необязательный элемент, добавляющий курсор к диаграмме. Курсор следует за указателем мыши и показывает всплывающие подсказки со значениями элементов диаграммы над которыми находится указатель мыши.
** Атрибут `cursorAlpha` задает степень непрозрачности линий курсора.

* `chart:legend` - определяет легенду графика.
** Атрибут `position` определяет положение легенды относительно диаграммы.
** Атрибут `equalWidths` определяет, должны ли все элементы легенды быть такой же ширины как самый широкий.
** Атрибут `periodValueText` задает текст, который будет показан в значении легенды, когда пользователь не раполагает указатель мыши ни над одним элементом данных. Теги должны состоять из пары значений - название поля (value / open / close / high / low) и значение периода, для которого дожно быть показано значение - open / close / high / low / sum / average / count.
** Атрибут `valueAlign` задает выранивание значения. Возможные значения "left" и "right".
** Атрибут `valueWidth` задает ширину значения.

* `chart:valueAxes` - элемент, описывающий вертикальные оси значений. В данном случае используется только одна ось, описываемая элементом `chart:axis`
** Атрибут `position` задает положение оси значений относительно диаграммы.
** Атрибут `title` задает заголовок оси значения.
** Установка атрибуту `stackType` значения `REGULAR` говорит о том, что используется диаграмма с накоплением. По умолчанию значение этого атрибута - `none`, в таком случае используется диаграмма без накопления.
** Атрибут `gridAlpha` задает степень непрозрачности линий сетки.

* `chart:graphs` - элемент, описывающий графы диаграммы. Граф описывается элементом `chart:graph`.
** Атрибут `type` задает тип графа и может быть: line, column, step line, smoothed line, ohlc и candlestick.
** Атрибут `valueField` определяет ключ из набора пар, содержащихся в объектах `DataItem`, список которых хранится в экземпляре `DataProvider`, по которому будет взято значение.
** Атрибут `fillAlphas` задает степень непрозрачности заполнения.
** Атрибут `lineAlpha` задает степень непрозрачности линии (или рамки колонки).
** Атрибут `hidden` определяет, будет ли граф отображаться.

* `chart:categoryAxis` - элемент, описывающий ось категорий.
** Установка атрибуту `startOnAxis` значения `true` дает указание начинать отрисовывать график сразу от оси значений. По умолчанию этот атрибут имеет значение `false`. В этом случае между осью значений и графиком имеется некоторый помежуток.
** Атрибут `gridAlpha` задает степень непрозрачности линий сетки.
** Атрибут `axisColor` задает цвет оси.

* `chart:export` – добавляет возможность сохранить полученный график.

[[cdp_screen_controller]]
====== Контроллер экрана

Перейдите на вкладку *Controller* и замените ее содержимое на следующий код:

[source,java]
----
include::{sourcesdir}/chart/StackedAreaChart.java[]
----

В методе `init(Map<String, Object> params)` происходит установка данных в диаграмму с накоплением. Диаграммы подобного типа показывают отношение отдельных составляющих к их совокупному значению.

[[cdp_result]]
===== Результат

. Откройте вкладку *Main Menu* в CUBA Studio и нажмите кнопку *edit* для `web-menu.xml`.

. Выберите элемент *`application`* и нажмите кнопку *new*.

. В диалоге создания элемента меню выберите `stackedarea-chart` в поле *id* и нажмите *add*.

. Выполните комманду *Run* -> *Start application server*.

После входа в приложение и открытия экрана из меню приложения вы увидите диаграмму, как показано ниже:

.Диаграмма с накоплением
image::chart/stackedarea-chart.svg[align="center", width="800"]

[[section_incremental_data_update]]
==== Создание диаграммы с инкрементальным обновлением данных

В следующем примере мы рассмотрим диаграмму, которая получает данные из источника данных и обновляет их автоматически. Когда в источник добавляются новые данные, диаграмма не обновляется полностью: новые точки добавляются в график на лету каждые 2 секунды. Этот принцип удобно использовать при создании динамически обновляемых виджетов.

Пример основан на тестовом приложении https://github.com/cuba-platform/sample-sales[Sales], к которому мы добавим диаграмму для отображения динамики новых заказов, то есть создания новых экземпляров сущности `Order`.

. Скачайте приложение *Sales* и добавьте к нему компонент *charts*, следуя инструкции из раздела <<chart_project_setup>>.

. Создайте в Studio новый пустой экран. Назовите его *orders-history*, так как в нём будет отображаться история создания новых заказов.

. Добавьте к экрану компонент `serialChart`. Чтобы реализовать инкрементальное обновление данных, необходимо создать источник данных с типом `collectionDatasource` и привязать к нему диаграмму. В этом примере мы не будем загружать данные из базы, вместо этого мы будем создавать тестовые данные на лету, поэтому запрос в источнике данных создавать не нужно.
+
Для оси категорий укажите атрибут `date`, для оси значений - атрибут `amount`.
+
[source, xml]
----
include::{sourcesdir}/chart/chart_incremental-update.xml[]
----

. Для обновления данных на лету используйте `timer` - специальный UI-компонент, который будет отправлять HTTP-запросы на сторону сервера.
+
Отройте вкладку *Properties* дизайнера экрана и нажмите на кнопку *Timers*, чтобы добавить таймер на экран. Заполните поле *id*. Допустим, мы хотим, чтобы данные обновлялись каждые 2 секунды, в этом случае в поле *delay* укажем значение 2000 миллисекунд.
+
В поле *onTimer* укажем имя метода Java - `updateChart`. Этот метод будет вызываться каждый раз при срабатывании события таймера. Сгенерируйте метод в контроллере экрана, нажав на кнопку *>>*, после чего сохраните его, нажав *Apply*.
+
.Создание таймера
image::chart/chart_incremental-update.png[align="center"]

. Откройте контроллер экрана в IDE. Для разработки логики работы таймера нам понадобится инжектировать следующие зависимости: `timeSource`, `metadata` и экземпляр источника данных. Мы будем генерировать новый экземпляр сущности `Order` с произвольным значением `amount` при каждом событии срабатывания таймера. Новый экземпляр добавляется к источнику данных с помощью метода `includeItem()`.
+
Инициализируйте диаграмму в методе `init()`, создав таким же образом исходный экземпляр сущности `Order`.
+
[source, java]
----
include::{sourcesdir}/chart/chart_incremental-update.java[]
----
+
На этом этапе диаграмма полностью функциональна, но размер источника данных после запуска таймера будет стремительно расти, поэтому реализуем ограничение количества отображаемых заказов.
+
.Данные автоматически обновляются каждые 2 секунды
image::chart/chart_incremental-update_2.png[align="center"]

. Создайте экземпляр класса `Queue` для очереди заказов. При каждом срабатывании таймера созданный заказ будет добавлен наверх очереди `itemsQueue`. Когда размер очереди превышает 10 заказов, самый старый заказ удаляется.
+
[source, java]
----
private Queue<Order> itemsQueue = new LinkedList<>();
----
+
[source, java]
----
include::{sourcesdir}/chart/chart_incremental-update_2.java[]
----

'''

Результат::

Данные поступают в браузер инкрементально. Если открыть консоль разработчика в Chrome, на вкладке *Network* будет видно, что каждые 2 секунды страница отправляет HTTP-запрос на backend и в ответе получает очень маленький JSON, содержащий только операции `add` и `remove` со значениями поля `amount`. Это позволяет избежать повторной пересылки всех данных диаграммы.

.Одновременно отображаются только последние 10 заказов
image::chart/chart_incremental-update_3.gif[align="center"]

'''

[[section_use_of_events]]
==== Использование событий

Проиллюстрируем использование событий. Добавим в экран, созданный в разделе <<cdb_creating_chart>>, обработку события нажатия на элемент графа. Откройте XML-дескриптор экрана в IDE, затем инжектируйте диаграмму:

[source, java]
----
@Inject
private SerialChart chart;
----

Далее добавьте слушателя в конце метода `init(Map<String, Object> params)`. Если график получает данные через `DataProvider`, для обработки нажатия на элемент графа используется метод `getDataItemNN()`. В данном примере компонент `SerialChart` привязан к источнику данных, поэтому для получения элемента используется другой метод: `getEntityNN()`:

[source, java]
----
include::{sourcesdir}/chart/GraphItemClickListener.java[]
----

Для просмотра результата пересоберите проект командой *Run* -> *Restart application server* и зайдите в систему. Откройте экран и нажмите на одину из колонок гистограммы.

.Диаграмма с обработкой события нажатия на элемент графа
image::chart/chart-with-event.png[align="center", width="800", height="367"]

[[custom_json]]
==== Конфигурация с помощью JSON

Для конфигурации графика, помимо указания атрибутов в XML, можно напрямую использовать JSON, описанный в http://docs.amcharts.com/3/javascriptcharts[документации AmCharts].

Рассмотрим это на примере serialChart:

[source, xml]
----
include::{sourcesdir}/chart/custom_json_1.xml[]
----

Для графика заданы определенные данные:

[source,java]
----
include::{sourcesdir}/chart/custom_json_2.java[]
----

image::chart/chart_custom_json.png[align="center"]

Теперь мы можем изменить конфигурацию графика. Например, добавить заголовок:

[source,java]
----
include::{sourcesdir}/chart/custom_json_3.java[]
----

image::chart/chart_custom_json_title.png[align="center"]

Также возможно задать JSON конфигурацию с помощью XML:

[source, xml]
----
include::{sourcesdir}/chart/custom_json_4.xml[]
----

[[chart_replacement]]
=== Замена версии AmCharts

Версию библиотеки AmCharts, включенную в платформу, можно заменить на другую. Для этого необходимо:

. Скачать исходный код charts и stock charts с сайта https://www.amcharts.com/download/[AmCharts^].
. Объединить содержимое папок `amcharts` в одну папку.
. Скопировать папку `amcharts` в `{project.rootDir}/modules/web/web/VAADIN/webjars`
. Произвести развертывание приложения заново.

Для использования новых атрибутов, добавленных в новой версии, необходимо в контроллере экрана задать пользовательскую JSON строку для диаграммы, как показано ниже.

[source, java]
----
chart.setNativeJson("{\"valueScrollbar\":{\"autoGridCount\":true}}");
----