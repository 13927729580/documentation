[[chart]]
== Displaying Charts

CUBA platform charts display subsystem supports various chart types: pie charts, line plots, bubble charts, radar charts,
funnel charts, stock charts and more. It is also possible to export charts. Most chart types support zoom and scrolling.
The charts are supported in web client only.

AmCharts library which is the basis of the chart display subsystem is distributed under a license, which allows its free
use if you keep the link to the library website. Alternatively, you can http://www.amcharts.com/online-store[purchase^]
an AmCharts license for your project and remove the link.

[[chart_dependency]]
=== Add Charts Dependency
To use charts in your project, activate the *charts* item in the *Base projects* list on the *Project properties* page
of CUBA Studio.

[[chart_configuration]]
=== Configuring Charts

Charts are displayed using the `Chart` component acting as a universal canvas. Chart type is defined by the
`configuration` property, which has the `AbstractChart` type.

Charts can be described in a screen XML-descriptor. To do this, you should connect the corresponding `namespace`:

[source, xml]
----
<window xmlns="http://schemas.haulmont.com/cuba/window.xsd"
        xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
        ...>
----

XML elements corresponding to different chart types:

* `chart:xyChart` - XYChart
* `chart:serialChart` - SerialChart
* `chart:pieChart` - PieChart
* `chart:funnelChart` - FunnelChart
* `chart:gaugeChart` - AngularGaugeChart
* `chart:radarChart` - RadarChart
* `chart:ganttChart` - GanttChart
* `chart:stockChart` - StockChart

Each chart type has its own set of attributes and methods, which replicate the functionality of the corresponding charts
from AmCharts library. Documentation on the properties and methods of the charts is available at
http://docs.amcharts.com/3/javascriptcharts[docs.amcharts.com/3/javascriptcharts^].

Any configuration attribute can be set to `null`; in this case the system will use the default value (except the cases
specified in the AmCharts documentation).

[[chart_data_binding]]
=== Connecting Data

There are two ways how you can pass data to a chart: through the `DataProvider` interface or using the datasource mechanism. 

* The `DataProvider` interface has a standard implementation: `ListDataProvider` class. It contains a list of `DataItem`
instances from which the data for the chart will be taken. There are several standard implementations of `DataItem` interface:
** `EntityDataItem` takes an instance of any entity.
** `MapDataItem` is a set of key-value pairs.
** `SimpleDataItem` takes an instance of any `public` class.

An instance of `DataProvider` is passed to the `setDataProvider()` method of chart configuration. This approach to
providing chart data is the most universal, but it requires creating instances of `DataProvider` and `DataItem`
in a screen controller.

* A `CollectionDatasource` type datasource can be assigned to a `Chart` component by invoking the `setDatasource()`
method. This approach requires an entity that will represent chart data. It may be convenient when such entity already
exists in the application data model and also when chart data should be displayed as a table.

<<chart_example>> illustrates both approaches to providing chart data.

Entity properties or the values contained in an instance of `DataProvider` which are used for display purposes are
defined in the chart attributes. The set of chart attributes may differ for different chart types. For example, for the
`chart:pieChart` component, you should define the `valueField` and `titleField` attributes. The following types are
allowed for attribute values: `Integer`, `Long`, `Double`, `String`, `Boolean`, `Date`.

Dynamic addition of data to an existing chart is supported for both the datasource and the data provider mechanisms.

[[chart_listeners]]
=== Events

It is possible to configure handling of different event types. The following listener types are available:

* `AxisZoomListener` - chart axis scaling.
* `ChartClickListener` - click on the canvas.
* `RightClickListener` - right click on the canvas.
* `CursorPeriodSelectListener` - selection of the display period with a cursor.
* `CursorZoomListener` - scaling of the chart area with a cursor.
* `GraphClickListener` - click on a graph.
* `GraphItemClickListener` - click on a graph item.
* `LegendItemHideListener` - hiding a legend item.
* `LegendItemShowListener` - showing a legend item.
* `LegendItemClickListener` - click on a legend item.
* `SliceClickListener` - click on a slice in a pie chart.
* `SliceRightClickListener` - right-click on a slice in a pie chart.
* `SlicePullInListener` - shift of a slice of a pie chart into the chart.
* `SlicePullOutListener` - shift of a slice of a pie chart out of the chart.
* `ZoomListener` - scaling of the canvas.

Event handling examples are available in <<section_use_of_events>>.

[[chart_example]]
=== Example of Working with Charts

This chapter shows how you can use the chart display subsystem.

[[chart_project_setup]]
==== Setting up the Application Project

. Run *CUBA Studio*, create new project and name it `sampler`.

. Open *Project properties* -> *Edit* and include the *charts* project into the list of *Base projects*; save changes.
Confirm when Studio will suggest recreating Gradle scripts.

. Select *Run* -> *Deploy*. At this point, the application will be assembled and deployed to the Tomcat application
server located at `build/tomcat`.

. Select *Build* -> *Create or update IDEA project files* to create project files for *IntelliJ IDEA*.

Once the steps above are complete, the chart display functionality will be connected to the application and ready to be used.

[[chart_data_from_entity]]
==== Creating Chart with Data from an Entity

For the first example we will create the chart similar to https://www.amcharts.com/demos/3d-stacked-column-chart/[3D Stacked Column Chart^]
from AmCharts demos. This chart will retrieve data from a database, so the `datasource` attribute has to be defined.
The `JavaScript` source code which amCharts use to define such chart is as follows:

[source,javascript]
----
include::{sourcesdir}/chart/column3d-chart.js[]
----

[[cdb_create_model]]
===== Creating an Entity

. Open the *Entities* tab in CUBA Studio and click *New entity* button.

. In the *New entity* dialog type `CountryGrowth` in the *Class name* field, choose `Not persistent` for *Entity type*
and click *OK* button.

. Using *Entity Designer* add attributes:
* `country` of the type `String`
* `year2014` of the type `Double`
* `year2015` of the type `Double`

. Open the *Source* tab to see generated source code:
+
[source,java]
----
include::{sourcesdir}/chart/CountryGrowth.java[]
----
+
This class describes non-persistent entity. An instance of this class contains the number of the country GDP growth rate
for 2014 and 2015 years.

. Click *OK* button to save the entity and close the designer screen.

. In the *Entities* tab click *Generate DB scripts* button and save scripts.

. Create the application database by selecting *Run* -> *Create database*.

[[cdb_creating_chart]]
===== Creating Chart

[[cdb_xml_descriptor]]
====== Screen XML Descriptor

Open the *Screens* tab in CUBA Studio and create a screen in the *web* module. Enter the value
`com/company/sampler/web/screens/column3d-chart.xml` in the *Reference* field. The fields - *Id*,
*Controller Name* and *Messages Pack* will be filled in with appropriate values. Save changes. Open the *XML* tab and
replace its content with the following code:

[source, xml]
----
include::{sourcesdir}/chart/column3d-chart.xml[]
----

The root element of the screen descriptor contains a new `xmlns:chart` attribute:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
>
----

The chart retrieves data from the `countryGrowthDs` datasource defined in the `datasource` attribute. Names and values
are displayed using the `country`, `year2014` and `year2015` attributes of the `CountryGrowth` entity; the list of
instances for this entity is stored in the datasource.

The `chart:serialChart` component contains the following attributes:

* `angle` - defines the chart angle. May have a value from `0` to `90`.

* `balloonText` - defines text for the tooltip that appears when hovering over a column. You can use the following
tags: `\[[value]]`, `\[[title]]`, `\[[persents]]`, `\[[description]]`, as well as keys from the `DataItem` listed in a
`DataProvider` instance, or names of the entity attributes from the datasource. To use `html` tags you must escape them.

* `depth3D` - chart thickness. When used in combination with the `angle` attribute, helps to create a 3D effect.

* `plotAreaFillAlphas` - opacity of the plot area.

* `startDuration` - duration of the animation, in seconds.

* `categoryField` - a key from the set of pairs contained in the `DataItem` objects listed in a `DataProvider` instance;
this key is used to determine the labels for the category axis.

The `chart:serialChart` component contains the following elements:

* `chart:categoryAxis` - an element that describes the category axis.
** The `gridPosition` attribute specifies if a grid line is placed on the center of a cell or on the beginning of a cell.

* `chart:valueAxes` - an element that defines vertical value axes. In our case, only one vertical axis is used; the axis
is described by the `chart:axis` element.
** The `position` attribute defines position of the value axis relative to the chart.
** Setting `stackType` to `BOX_3D` makes the chart display columns one behind the other.

* `chart:graphs` - an element that contains the collection of `chart:graph` elements; the graph is described by the
`chart:graph` element.
** The `type` attribute defines the type of the graph and can be: line, column, step line, smoothed line, olhc and candlestick.
** The `valueField` attribute defines a key from the list of pairs contained in the `DataItem` objects listed in a
`DataProvider` instance; this key is used to determine the value.
** The `fillAlphas` attribute defines opacity of fill.
** The `lineAlpha` attribute defines opacity of the line (or column border). Value range is 0 - 1.

* `chart:export` – an optional element that enables chart export.

[[cdb_screen_controller]]
====== Screen Controller

Open the *Controller* tab and replace its content with the following code:

[source,java]
----
include::{sourcesdir}/chart/Column3dChart.java[]
----

The `init(Map<String, Object> params)` method populates the `countryGrowthDs` datasource with the data. The `refresh()`
method initializes the datasource. This method should be invoked regardless of the `refreshMode="NEVER"` attribute
declared in the XML-descriptor.

[[cdb_result]]
===== Result

. Open the *Main Menu* tab in CUBA Studio and click *edit* button for `web-menu.xml`.

. Choose *`application`* item and click *new* button.

. In *Create menu item* dialog choose `column3d-chart` for *id* field and click *add*.

. Select *Run* -> *Start application server*.

After logging in and opening the screen from the application menu you will see the chart like below:

.Column 3D Chart
image::chart/column3d-chart.svg[align="center", width="800"]

[[chart_with_data_provider]]
==== Creating Chart with Data from DataProvider

This chart retrieves data through the `DataProvider` created in the controller, so the `datasource` attribute is not defined.

[[cdp_creating_chart]]
===== Creating Chart

[[cdp_xml_descriptor]]
====== Screen XML Descriptor

Open the *Screens* tab in CUBA Studio and create a screen in the *web* module. Enter the value
`com/company/sampler/web/screens/stackedarea-chart.xml` in the *Reference* field. The fields - *Id*, *Controller Name*
and *Messages Pack* will be filled in with appropriate values. Save changes. Open the *XML* tab and replace its content
with the following code:

[source, xml]
----
include::{sourcesdir}/chart/stackedarea-chart.xml[]
----

The root element of the screen descriptor contains a new `xmlns:chart` attribute:

[source, xml]
----
<window xmlns:chart="http://schemas.haulmont.com/charts/charts.xsd"
    ...
>
----

`chart:serialChart` attributes:

* `categoryField` - a key from the set of pairs contained in the `DataItem` objects listed in a `DataProvider` instance;
this key is used to determine the labels for the category axis.

The elements of `chart:serialChart`:

* `chart:chartCursor` - an optional element adding a cursor to the chart; the cursor follows the mouse pointer and shows
a tooltip with the value of the corresponding point on a chart.
** The `cursorAlpha` attribute defines opacity of the cursor line.

* `chart:legend` - an element that defines the chart legend.
** The `position` attribute defines the location of the legend relative to the chart.
** The `equalWidths` attribute specifies if each of legend entry should be equal to the most wide entry.
** The `periodValueText` attribute defines the text which will be displayed in the value portion of the legend when user
is not hovering above any data point. The tags should be made out of two parts - the name of a field
(value / open / close / high / low) and the value of the period you want to be show - open / close / high / low / sum / average / count.
** The `valueAlign` attribute defines alignment of the value text. Possible values are "left" and "right".
** The `valueWidth` attribute defines width of the value text.

* `chart:valueAxes` - an element that defines vertical value axes. In our case, only one vertical axis is used; the axis
is described by the `chart:axis` element.
** The `position` attribute defines position of the value axis relative to the chart.
** The `title` attribute defines the title of the value axis.
** Setting `stackType` to `REGULAR` makes the chart display a rolling value. Setting this attribute to `none` refers to
a non-rolling value.
** The `gridAlpha` defines opacity of grid lines.

* `chart:graphs` - an element that contains the collection of `chart:graph` elements; the graph is described by the `chart:graph` element.
** The `type` attribute defines the type of the graph and can be: line, column, step line, smoothed line, olhc and candlestick.
** The `valueField` attribute defines a key from the list of pairs contained in the `DataItem` objects listed in a
`DataProvider` instance; this key is used to determine the value.
** The `fillAlphas` attribute defines opacity of fill.
** The `lineAlpha` attribute defines opacity the line (or column border). Value range is 0 - 1.
** The `hidden` attribute specifies whether the graph is hidden.

* `chart:categoryAxis` - an element that describes the category axis.
** Setting `startOnAxis` to `true` causes drawing the chart right from the value axis. The default value for this
attribute is `false`. In this case, there will be a small gap between the value axis and the chart.
** The `gridAlpha` attribute defines opacity of grid lines.
** The `axisColor` attribute defines axis color.

* `chart:export` – an optional element that enables chart export.

[[cdp_screen_controller]]
====== Screen Controller

Open the *Controller* tab and replace its content with the following code:

[source,java]
----
include::{sourcesdir}/chart/StackedAreaChart.java[]
----

The `init(Map<String, Object> params)` method submits data to the chart as a rolling value. This type of charts shows
the ratio of separate parts to their total value.

[[cdp_result]]
===== Result

. Open the *Main Menu* tab in CUBA Studio and click *edit* button for `web-menu.xml`.

. Choose *`application`* item and click *new* button.

. In *Create menu item* dialog choose `stackedarea-chart` for *id* field and click *add*.

. Select *Run* -> *Start application server*.

After logging in and opening the screen from the application menu you will see the chart like below:

.Stacked Area Chart
image::chart/stackedarea-chart.svg[align="center", width="800"]

[[section_use_of_events]]
==== Using Events

Let us consider the use of events. We will add handling of a graph item click to the screen created in
<<cdb_creating_chart>>. Open the screen controller in the IDE and inject the chart:

[source, java]
----
@Inject
private Chart chart;
----

Then add a listener at the bottom of the `init(Map<String, Object> params)` method:

[source,java]
----
include::{sourcesdir}/chart/GraphItemClickListener.java[]
----

To see the results, rebuild the project using *Run* -> *Restart application server* and log in to the system. Open the
screen and click one of the columns.

.Chart that handles graph item click event
image::chart/chart-with-event.png[align="center", width="800", height="367"]

[[chart_types]]
=== Chart Types
There are several chart types supported by CUBA platform.

.Chart Types Hierarchy
image::chart/charts-hierarchy-dia.svg[align="center"]

[[serial_chart]]
==== SerialChart

The `SerialChart` component allows you to create line, area, column, bar, step line, smoothed line, candlestick and OHLC
charts. The charts support multiple axes with simple or logarithmic scales, the data points can be displayed at
equal/irregular intervals or on timeline basis.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=line-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.SerialChart as Line Chart
image::chart/line-chart.svg[align="center", width="800"]

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=columnline-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.SerialChart as Column Chart
image::chart/column-chart.svg[align="center", width="800"]

[[pie_chart]]
==== PieChart

The `PieChart` component allows you to create pie/donut charts.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=pie3d-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.PieChart
image::chart/pie-chart.svg[align="center", width="800"]

[[xy_chart]]
==== XYChart

The `XYChart` component allows you to create XY/bubble/scatter charts. The charts support multiple axes with simple or
logarithmic scales.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=xy-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.XYChart
image::chart/xy-chart.svg[align="center", width="800"]

[[funnel_chart]]
==== FunnelChart

The `FunnelChart` component allows you to create funnel/pyramid charts.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=funnel3d-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.FunnelChart
image::chart/funnel-chart.svg[align="center", width="800"]

[[radar_chart]]
==== RadarChart

The `RadarChart` component allows you to create radar/polar charts.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=polar-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.RadarChart
image::chart/radar-chart.svg[align="center", width="800"]

[[gauge_chart]]
==== AngularGaugeChart

The `AngularGaugeChart` component allows you to create gauge charts.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=gauge-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.GaugeChart
image::chart/gauge-chart.svg[align="center", width="800"]

[[gantt_chart]]
==== GanttChart

The `GanttChart` component allows you to create Gantt charts.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=gantt-chart" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.GanttChart
image::chart/gantt-chart.svg[align="center", width="800"]

[[stock_chart]]
==== StockChartGroup

The `StockChartGroup` component allows you to create stock charts.

Stock chart supports multiple data sets and has a ready to use data set selector. Data sets might be compared one to another.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-multiple-datasets" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.StockChart with multiple data sets
image::chart/stock-chart-with-datasets.svg[align="center", width="800"]

Stock chart can display a different kind of annotations on the graph or on the axis. These annotations are called stock events.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-stock-events" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.StockChart with StockEvents
image::chart/stock-chart-with-stockevents.svg[align="center", width="800"]

Stock chart can support any number of stock panels. Each Stock Panel can have any number of graphs. Each Stock Panel is
a separate serial chart and is based on SerialChart and so it can do anything this chart can.

++++
<div class="live-demo">
    <a href="https://demo.cuba-platform.com/sampler/open?screen=stockchart-multiple-panels" class="charts-live-demo-btn" target="_blank">LIVE DEMO</a>
</div>
++++

.StockChart with multiple StockPanels
image::chart/stock-chart-with-panels.svg[align="center", width="800"]

[[chart_replacement]]
=== Replacing AmCharts Version

An instance of AmCharts library included in CUBA platform can be replaced with another one. To do this:

. Download charts and stock charts from https://www.amcharts.com/download/[AmCharts site^].
. Merge `amcharts` folder from both archives into one.
. Copy `amcharts` folder to `{project.rootDir}/modules/web/web/VAADIN/resources`
. Redeploy the application.

To use new attributes added in a new version you need to set custom JSON in your screen controller as shown below.

[source, java]
----
CubaAmchartsScene cubaAmchartsScene = (CubaAmchartsScene) WebComponentsHelper.unwrap(chart);
cubaAmchartsScene.setJson("{\"valueScrollbar\":{\"autoGridCount\":true}}");
----