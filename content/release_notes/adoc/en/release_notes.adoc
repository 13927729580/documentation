= CUBA Platform and Studio Release Notes - WORK IN PROGRESS
:toc: left
:toc-title: Table of contents
:toclevels: 6
:sectnumlevels: 6
:stylesheet: cuba.css
:linkcss:
:source-highlighter: coderay
:imagesdir: ./img
:stylesdir: ./styles
:sourcesdir: ../../source
:doctype: book
:sectlinks:
:sectanchors:
:lang: en
:revnumber: 6.7
:version-label: Version
:revremark: Copyright (c) 2017 Haulmont
:youtrack: https://youtrack.cuba-platform.com
:manual: https://doc.cuba-platform.com/manual-{revnumber}
:manual_app_props: https://doc.cuba-platform.com/manual-{revnumber}/app_properties_reference.html#
:reporting: https://doc.cuba-platform.com/reporting-{revnumber}

:!sectnums:

[[overview]]
== Overview

This document highlights major changes in CUBA Platform and Studio version {revnumber}.

[[platform]]
== Platform

=== All Resolved Issues

* https://youtrack.cuba-platform.com/issues/PL?q=Milestone:%20%7BRelease%206.7%7D%20State:%20Fixed,%20Verified%20Fix%20versions:%206.7.0%20Affected%20versions:%20-SNAPSHOT%20sort%20by:%20created%20asc[Platform 6.7.0 Resolved Issues]


[[platform_breaking_changes]]
=== Breaking Changes

. The {manual}/login.html[authentication mechanism] has been refactored to be more extensible. The `LoginServiceBean` and `LoginWorkerBean` classes are now deprecated and just delegate to the new mechanism. If you have overridden them in your project, you need to migrate your extension to using the new functionality. For example, you can use {manual}/login.html#login-events[events] to intercept login on the middle tier.

. Due to improvements in <<datatype,datatypes>>, a migration of custom datatypes is needed. Studio does it automatically when you switch to the new platform version. If you don't use Studio and your project has custom datatypes registered in `metadata.xml`, add `id` attribute to the `datatype` element and set it to the value of the `NAME` constant of your datatype class. For example:
+
[source, xml]
----
<datatype id="year" class="com.company.sample.YearDatatype"/>
----

. {manual}/list_actions.html#removeAction[RemoveAction] and `BulkEditAction` do not have `remove` and `update` constraint operation types by default anymore. The reason is as follows: {manual}/constraints.html[constraint] scripts are normally executed on middleware and expect entities in the managed state. But when you assign a constraint operation type on an action, the same scripts are executed also on the client with detached entities, which may result in unexpected "unfetched attribute" errors. So it should be a developer's decision whether to assign constraint operation types to actions and hence execute constraint scripts on the client side.

[[data_model]]
=== Data Model

[[entity_base_classes]]
==== Base Classes

Non-persistent entities should be inherited form the same {manual}/base_entity_classes.html[base classes] as persistent ones: `BaseUuidEntity`, `BaseLongIdEntity`, and so on. It allows you to have identifiers of any type, which is important when non-persistent entities represent data from some data store. The framework determines if the entity is persistent or not by the file where it is registered: `persistence.xml` or `metadata.xml`.

`AbstractNotPersistentEntity` has been deprecated, but can still be used for backward compatibility.

[[number_format]]
==== Number Format

Using the new {manual}/entity_attr_annotations.html#numberFormat_annotation[@NumberFormat] annotation, you can define a display format for numeric attributes right in the entity class. So if you need just a specific formatting of an attribute, and don't need some custom conversion algorithm, then you don't have to create a {manual}/datatype.html[Datatype] for the attribute. For example, here is an integer number without grouping separators:

[source, java]
----
@Column(name = "SIMPLE_NUMBER")
@NumberFormat(pattern = "#")
protected Integer simpleNumber;
----

[[datatype]]
==== Datatypes

The {manual}/datatype.html[datatypes] mechanism has been improved for better extensibility.

The `getName()` method of the `Datatype` interface is deprecated, and implementation classes do not need the `NAME` constant. Instead, the `id` XML attribute is used when the implementation class is registered.

The `getJavaClass()` method of the `Datatype` interface now has a default implementation that returns a value of the `@JavaClass` annotation if it is present on the class.

All datatypes are registered in `metadata.xml` files, but if old `datatypes.xml` exists, it is loaded for backward compatibility.

There is no hard-coded list of "standard datatypes" anymore. The `default` XML attribute in `metadata.xml` indicates that the datatype should be used by default for a Java class handled by this datatype, i.e. this datatype will be resolved automatically for entity attributes of appropriate type. Standard datatypes are defined in the `cuba-metadata.xml` of the `cuba` application component. Subsequent `metadata.xml` files can add and override any datatype including default ones.

The `Datatypes` class became a thin wrapper delegating to the `DatatypeRegistry` and `FormatStringsRegistry` beans. It is recommended to use `DatatypeRegistry` directly. Its `getId*()` methods are designed to get an id the datatype is registered with.

[[base_view]]
==== Base View

Sometimes `_minimal` view includes reference attributes that are not included to `_local`, so we have added one more predefined view which is available for all entities: `_base` (defined also in `View.BASE` constant). It includes all local non-system attributes and attributes defined by `@NamePattern` (effectively `_minimal` + `_local`).

[[gui]]
=== Generic UI

[[lookup_screen_customization]]
==== Lookup Screen Customization

When a browse screen is opened as a lookup, it contains an automatically added panel with buttons and a special lookup action. Now you can customize all these parts: replace the frame with buttons for all lookup screens in your project, create your own selection buttons for a certain screen, or customize the lookup action. See details in the {manual}/screen_lookup.html#screen_lookup_customization[documentation].

[[entity_combined_screen]]
==== Controller of Combined Screen

The framework now contains a {manual}/entityCombinedScreen.html[base class] for controllers of combined screens that are created by the *Entity combined screen* template in Studio. The base class encapsulates all logic of the screen, so concrete screens have no boilerplate code at all. Also, unlike the previous implementation, the base controller provides pessimistic locking in the same way as `AbstractEditor` does.

[[popupButton]]
==== PopupButton

The `PopupButton` component can show not only actions but also custom popup content. For this, the `popup` nested XML element or the corresponding `popupContent` API property must contain a single `Component` or `Container`. See details in the {manual}/gui_PopupButton.html[documentation].

[[suggestionPickerField_query]]
==== SuggestionPickerField

To simplify usage of the `SuggestionPickerField` component, we have added a declarative way of providing options for the current user input. It's the {manual}/gui_SuggestionPickerField.html#gui_suggestionPickerField_query[query] element, containing a JPQL query for loading options from the database.

[[deprecated_embedded]]
==== BrowserFrame

The new {manual}/gui_BrowserFrame.html[BrowserFrame] component is designed to display embedded web pages. It is an equivalent of the HTML iframe element.

The `Embedded` component has been deprecated. Use the {manual}/gui_Image.html[Image] component for displaying images or `BrowserFrame` for embedded web pages.

[[currencyField]]
==== CurrencyField

The new {manual}/gui_CurrencyField.html[CurrencyField] component is a text field designed for displaying and entering currency values. It has a currency symbol inside the field and is aligned to the right by default.

[[fts_in_filter]]
==== FTS Conditions in Filter

Previously, the full-text search functionality in the {manual}/gui_Filter.html#gui_Filter_fts[Filter] component could be used only by completely replacing the set of structured conditions, i.e. users had to choose whether they want to filter by conditions or by FTS. Now you can use full-text search together with structured conditions: see *FTS condition* item in the *Add condition* dialog. It can be particularly useful in predefined filters and application/search folders if you create a set of hidden structured conditions and leave only the FTS condition for users.

[[groupBox_outerMargin]]
==== Outer Marging in GroupBox

The `GroupBox` container can have a {manual}/gui_GroupBoxLayout.html#gui_GroupBox_outerMargin[margin] outside its border. Sometimes it can save you from adding an extra container just to provide a margin.

[[valo_styles]]
==== Valo Styles

`tiny`, `small`, `large`, `huge` predefined styles from the Vaadin's Valo theme can be used in the following UI components: `Button`, `Label`, `TextField`, `TextArea`, `DateField` (`large` are `huge` are not supported), `LookupField`, `PickerField`, `LookupPickerField`, `SearchPickerField`, `SuggestionPickerField`.

[[maximized_state]]
==== Maximized State

A dialog window or a message dialog can be maximized on opening or when they are already shown. It can be done declaratively in screen's XML:

[source,xml]
----
<dialogMode maximized="true"/>
----

Or programmatically:

[source, java]
----
openWindow("windowAlias", WindowManager.OpenType.DIALOG.setMaximized(true));

showMessageDialog("title", "message", MessageType.WARNING.setMaximized(true));
----

Return a maximized screen to the normal state:

[source, java]
----
button.setAction(new BaseAction("unmaximize"){
    @Override
    public void actionPerform(Component component) {
        getDialogOptions().setMaximized(false);
    }
});
----

[[rest_api]]
=== REST API

[[rest_ldap]]
==== LDAP Authentication in REST API

REST API now supports external authentication via LDAP. See {manual}/rest_api_v2_ldap.html[documentation] for details.

[[rest_filter]]
==== Entities Search Filter

You apply filters when loading lists of entities using the http://files.cuba-platform.com/swagger/6.7/#/Entities[entities] operation. See {manual}/rest_api_v2_ex_search_filter.html[documentation] for details.

[[reporting]]
=== Reporting

[[reporting_templates]]
==== New Templates and Output Types

CUBA report generator now supports the following new templates and output types:

* {reporting}/template_jasper.html[JasperReports templates] allow you to output reports in PDF, HTML and office formats using the open-source JasperReports library.

* {reporting}/template_csv.html[CSV templates] allow you to output reports in the CSV format.

* {reporting}/table_output.html[Table formatter] allows you to output reports into tables right inside your application UI. You don't need to create and upload any templates, just create the report structure and specify *Table* in the *Output type* field of the *Template editor* screen.

[[input_parameters_validation]]
==== Input Parameters Validation

Before executing a report, its input parameters can be {reporting}/parameters.html#report_parameter_validation[validated] using Groovy scripts.

[[json_dataset]]
==== JSON Dataset

The new {reporting}/structure_json.html[JSON dataset] can be used in the report structure. It allows you to specify the set of records in JSON format. The JSON content can be received from a report parameter, an external URL, or generated by a Groovy script.

[[docx_conversion]]
==== DOCX Conversion

Reports with DOCX templates can be output to PDF and HTML using LibreOffice, which provides better quality than default conversion using Docx4j. Use the {reporting}/app_properties.html#reporting.openoffice.docx.useOfficeForDocumentConversion[reporting.openoffice.docx.useOfficeForDocumentConversion] application property to specify the conversion mode.

[[misc]]
=== Miscellaneous

[[entity_log]]
==== Entity Log

The {manual}/entity_log.html[entity log] mechanism now registers and shows old values of changed attributes.

[[attr_access_control]]
==== Entity Attribute Access Control

The security subsystem allows you to set up access to entity attributes according to user permissions. But sometimes you may want to change the access to attributes dynamically depending also on the current state of the entity or its linked entities. The new mechanism allows you to create rules of what attributes should be hidden, read-only or required for a particular entity instance, and apply these rules automatically to Generic UI components and REST API. See details in the {manual}/entity_attribute_access.html[documentation].

[[accordance_with_view]]
==== Accordance With View

The `EntityStates` bean now contains a set of methods that allow you to check if an entity instance has attributes loaded according to a view: `checkLoadedWithView()` and `isLoadedWithView()`. You can use these methods to decide whether you need to reload an instance in some business logic.

The {manual}/bean_validation_constraints.html#bean_validation_cuba_annotations[@RequiredView] annotation can be added to service method definitions to ensure that entity instances are loaded with all the attributes specified in a view.

[[mssql_2005]]
==== Support for Microsoft SQL Server 2005

Now you can connect to Microsoft SQL Server 2005 databases using the *jTDS* JDBC driver. It will be selected if you specify  *Microsoft SQL Server 2005* database type for your project's main or additional data store in Studio.

If you don't use Studio, specify the following parameters for the `createDb` and `updateDb` Gradle tasks:

[source]
----
dbms = 'mssql'
dbmsVersion = '2005'
----

and the following connection parameters in `context.xml`:

[source,xml]
----
<Resource
  name="jdbc/CubaDS"
  type="javax.sql.DataSource"
  maxIdle="2"
  maxTotal="20"
  maxWaitMillis="5000"
  driverClassName="net.sourceforge.jtds.jdbc.Driver"
  username="sa"
  password="saPass1"
  url="jdbc:jtds:sqlserver://localhost/sample"/>
----

[[upd_dep]]
=== Updated Dependencies

Java libraries:
----
com.esotericsoftware/kryo-shaded = 4.0.1
com.fasterxml.jackson = 2.9.0
com.google.code.gson/gson = 2.8.1
com.haulmont.thirdparty/eclipselink = 2.6.2.cuba18
com.haulmont.yarg = 2.0.7
com.microsoft.sqlserver/mssql-jdbc = 6.2.1.jre8
com.vaadin = 7.7.10.cuba.9
com.vaadin.addon/vaadin-context-menu = 0.7.5
commons-cli/commons-cli = 1.4
commons-fileupload/commons-fileupload = 1.3.3
commons-io/commons-io = 2.5
org.apache.commons/commons-collections4 = 4.1
org.apache.commons/commons-compress = 1.14
org.codehaus.groovy/groovy-all = 2.4.12
org.javassist/javassist = 3.21.0-GA
org.springframework = 4.3.10.RELEASE
org.springframework.security = 4.2.3.RELEASE
org.springframework.security.oauth/spring-security-oauth2 = 2.1.1.RELEASE
org.thymeleaf = 3.0.7.RELEASE
org.vaadin.addons/popupbutton = 2.6.0-3
org.webjars/amcharts = 3.20.20
org.webjars/pivottable = 2.3.0
----

[[studio]]
== Studio

=== All Resolved Issues

* https://youtrack.cuba-platform.com/issues/STUDIO?q=Milestone:%20%7BRelease%206.7%7D%20State:%20Fixed,%20Verified%20Fix%20versions:%206.7.0%20Affected%20versions:%20-SNAPSHOT%20sort%20by:%20created%20asc[Studio 6.7.0 Resolved Issues]

[[studio_settings]]
=== Settings

Most of the Studio settings were moved from the Studio Server window to the *Settings* tab of the web interface initial screen. So the Studio Server window now contains only settings that really need a restart:

image::studio_settings_1.png[align="center"]

Other settings are available after the start on the *Settings* tab:

image::studio_settings_2.png[align="center"]

[[studio_repositories]]
=== Repository Configuration

Now Studio can manage multiple repositories used in your project. The repository configuration dialog is split into two sections:

image::studio_repositories_1.png[align="center"]

The first section contains the list of repositories known to Studio, with their URLs and credentials. This list is stored in the `${user.home}/.haulmont/studio/cache/base-projects.xml` file. Please note that repository passwords are saved in plain text. Initially the list contains only the CUBA public repositories, and you can add your own.

The second section contains repositories selected for the current project. You can add and remove items in this list using the *Use in the project* and *Remove from the project* buttons. The *Up/Down* buttons allow you to order the repositories in your `build.gradle`. The order of repositories affects the sequence of searching for platform versions, so we recommend placing a repository containing the platform artifacts on top.

[[screen_layout_designer]]
=== Screen Layout Designer

The screen layout designer has acquired new functionality. First of all, it is *Undo* and *Redo* actions that can be invoked using the icon buttons at the top left corner:

image::studio_screen_designer_1.png[align="center"]

The designer now analyzes the screen layout on save and reports about possible issues. In case of a "false positive", you can switch off the analysis for a particular screen in the issue dialog. The icon button at the top right corner indicates whether the analysis is active for the screen, and you can switch it on and off.

Style names of visual components can be selected from the list of predefined styles, see the "plus" button in the *stylename* field:

image::studio_screen_designer_2.png[align="center"]

[[entity_designer]]
=== Entity Designer

* Previously, the `@OnDelete` and `@OnDeleteInverse` annotations were used only at runtime when processing deletion of soft deleted entities. Now you can define the `@OnDeleteInverse` annotation also for a reference to a hard deleted entity, and Studio will create an appropriate `on delete` clause for the foreign key on the database level.

* Using the *Hide properties* link at the top of the entity designer, you can collapse the entity properties panel and give more vertical space to the list of attributes. In the collapsed state, the link changes its title  and shows the entity name:
+
image::studio_entity_designer_1.png[align="center"]

* If the entity class implements system interfaces like `Creatable` or `Versioned` itself (i.e. it does not extend `StandardEntity`), it contains appropriate fields: `createTs`, `createdBy` and so on. Now Studio shows them in the attributes table, and you can arrange them using the *Up/Down* buttons:
+
image::studio_entity_designer_2.png[align="center"]

* The Studio entity designer can create method-based non-persistent attributes. If you select *Transient* checkbox and deselect *Create field*, the attribute becomes read-only:
+
image::studio_entity_designer_3.png[align="center"]
+
The source code of the attribute will look as follows:
+
[source, java]
----
@MetaProperty(related = {"name", "num"})
public String getTitle() {
    return name + " - " + num; // written manually
}
----

* For reference attributes, the attribute type field contains a button that allows you to navigate to the linked entity:
+
image::studio_entity_designer_4.png[align="center"]
+
You can go back using the *History* dialog that is available via *Ctrl-Shift-H* or *Alt-C* shortcuts.

[[view_designer]]
=== View Designer

Sometimes you need to edit large object graphs in the the view designer. The new search capability allows you to quickly find attributes by name:

image::studio_view_designer_1.png[align="center"]
