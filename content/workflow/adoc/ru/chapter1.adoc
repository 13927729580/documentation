[[ch1_general_info]]
== Обзор подсистемы Workflow

Сутью Workflow является последовательное изменение состояния некоторой сущности (_карточка_)в соответствии с заданным _процессом_,вовлекающее пользователей системы и автоматические механизмы. Типичнымпримером является процесссогласования некоторого документа между сотрудниками ворганизации.

Рассмотрим структуру подсистемы Workflow платформы CUBA.

.Структура подсистемы Workflow
image::Workflow.png[align="center"]

Основными элементами структуры являются:

* _Process Design_ (дизайн процесса) - схема процесса, а также набор связанных с ней скриптов, переменных, параметров оповещения и локализации сообщений. Дизайн является исходным материалом для процесса, который создается или обновляется на основе дизайна в результате _развертывания_ последнего в приложении.

* _Process_ (процесс) - исполняемое описание бизнес-процесса. Механизм исполнения основан на фреймворке *jBPM 4*, поэтому основным элементом процесса является описатель графа состояний на языке jPDL. Кроме того, процесс включает в себя описатели форм пользовательского интерфейса, списки пользователей, назначенных для исполнения ролей процесса, локализованные сообщения и т.д.

* _Card_ (карточка) - сущность модели данных, непосредственно связанная с экземпляром процесса. В большинстве случаев карточкой процесса может являться объект предметной области, состояние которого меняется в соответствии с процессом. Это, например, документ для согласования, или тикет в системе отслеживания дефектов. В случае если такого объекта в предметной области нет, карточкой может являться искусственная сущность, просто отражающая текущее состояние экземпляра процесса.

Можно сказать, что процесс задает тип бизнес-процесса, а карточка представляет собой один экземпляр этого бизнес-процесса.

Процесс задает набор _состояний_ (узлов) и переходов между ними, а также следующие ассоциированные объекты:

* _Activities_ (действия) - программный код, выполняющийся при переходе в некоторое состояние.

* _Forms_ (формы) - экраны, позволяющие взаимодействовать с пользователем во время принятия им решений о переходе по процессу.

* _Timers_ (таймеры) - программный код, автоматически срабатывающий по истечении заданного времени после входа в некоторое состояние.

Во время выполнения процесса возникают объекты _Assignments_ (назначения), сигнализирующие пользователю о том, что он должен предпринятьнекоторые действия по процессу.

В подсистему Workflow платформы интегрирован визуальный редактор процессов _Visual Designer_, который позволяет создавать дизайн процессов и разворачивать их прямо в процессе работы приложения. Наборвозможных состояний, действий, форм и таймеров, из которых конструируются процессы, закладывается в приложение на этапе разработки.

=== Модель данных

Рассмотрим диаграмму классов основных элементов подсистемы Workflow.

.Диаграмма классов Workflow
image::WorkflowEntities.png[align="center"]

* `Design` - объект, хранящий дизайн процесса.

* `Proc` - исполняемый процесс. Атрибуты процесса:

** `design` - ссылка на дизайн, по которому был создан данный процесс.

** `name` - имя процесса, понятное пользователям. Имя задается на этапе дизайна, однако может быть задано и в экране редактирования процесса.

** `jbpmProcessKey` - ключ процесса в исполняющем механизме jBPM. Формируется автоматически при развертывании дизайна процесса.

** `code` - код процесса для обращения к нему программными средствами. По умолчанию равен `jbpmProcessKey`, однако может быть изменен в экране редактирования процесса.

** `messagesPack` - имя пакета сообщений, в котором содержатся локализованные названия состояний, переходов, различных описаний и сообщений процесса. Данный пакет сообщений формируется автоматически на этапе развертывания дизайна процесса и хранится вместе с другими файлами процесса в соответствующем подкаталоге конфигурационного каталога приложения.

** `roles` - список объектов типа `ProcRole`, определяющих роли участников процесса.

* `ProcRole` - роль в процессе. Объекты данного типа создаются автоматически при развертывании дизайна процесса если он содержит состояния вида _Назначение_, то есть те, которые выдают задачи пользователям и останавливают выполнение процесса до принятия пользователем необходимых действий. Изначально объекты `ProcRole` не связываются ни с какими пользователями системы, однако в экране редактирования процесса для каждой роли можно назначить исполнителя по умолчанию.

* `DefaultProcActor` - список исполнителей некоторой роли, задаваемый на уровне процесса.

* `Card` - карточка процесса. Как правило, от класса `Card` наследуется некоторая сущность предметной области, которая тем самым приобретает возможность двигаться по процессу. Атрибуты карточки:

** `description` - опциональное текстовое описание данного экземпляра карточки, позволяющее пользователю различать карточки без загрузки атрибутов конкретного типа, расширяющего `Card`. Например, если карточка отражает документ, то в поле `description` имеет смысл записать тип, номер и дату этого документа.

** `proc` - ссылка на процесс.

** `roles` - список объектов типа CardRole, определяющих исполнителей ролей процесса для данной карточки.

** `jbpmProcessId` - идентификатор экземпляра процесса в механизме исполнения jBPM.

** `state` - название текущего состояния процесса.

** `assignments` - список объектов типа `Assignment`, созданных в данном экземпляре процесса.

** `attachments` - список объектов типа `CardAttachment`, позволяющих привязывать к карточке загружаемые во время выполнения процесса файлы.

* `CardRole` - сущность, определяющая исполнителей ролей процесса для данной карточки. Атрибуты `CardRole`:

** `card` - карточка, для которой определяется исполнитель роли.

** `procRole` - роль в процессе.

** `user` - исполнитель роли (типа `User` - пользователь системы).

* `CardAttachment` - вложение, предоставляет возможность ассоциировать с карточкой загружаемые файлы. Атрибуты (вместе с суперклассом `Attachment`):

** `card` - карточка.

** `assignment` - если файл загружен на этапе выполнения назначения, то этот атрибут содержит ссылку на соответствующий объект `Assignment`.

** `file` - загруженный файл типа `FileDescriptor`.

** `name` - название вложения.

** `comment` - комментарий к вложению.

* `Assignment` - назначение. Объекты данного типа создаются в системе при переходе процесса в состояние "назначение". В этом состоянии процесс останавливает выполнение и ожидает команды от пользователя или от автоматического механизма. При получении команды о завершении в назначении заполняются атрибуты `finished`, `finishedByUser` и `outcome`, и процесс переходит в следующее состояние. Для одной карточки и пользователя может существовать не более одного незавершенного назначения. Атрибуты назначения:

** `card` - карточка.

** `user` - пользователь системы, для которого выдано назначение.

** `proc` (процесс) - тот же процесс, который в момент создания назначения установлен для карточки.

** `name` - наименование назначения.

** `description` - описание назначения.

** `jbpmProcessId` - идентификатор экземпляра процесса jBPM, исполняемого по карточке в момент создания назначения.

** `dueDate` - момент времени, до которого назначение должно быть выполнено.

** `finished` - фактический момент времени завершения назначения. Равен `null`, пока назначение не завершено.

** `finishedByUser` - пользователь, фактически завершивший назначение. Равен `null`, пока назначение не завершено.

** `outcome` - наименование выхода из состояния назначения, которое выбрал пользователь. Например, в схеме бизнес-процесса может быть узел-назначение, который предписывает пользователю проверить факт исправления некоторого дефекта и выбрать один из двух путей дальнейшего следования процесса: "OK" или "Not OK". Тогда, если пользователь выбрал "OK", то в поле `outcome` назначения запишется эта строка, и наоборот.

** `attachments` - список объектов типа `CardAttchment`, которые были созданы для этого назначения.

