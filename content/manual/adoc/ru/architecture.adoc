[[architecture]]
=== Архитектура

В данной главе рассмотрена архитектура CUBA-приложений в различных разрезах: по уровням, блокам, модулям, и по используемым базовым проектам.

[[app_tiers]]
==== Уровни и блоки приложения

Платформа позволяет строить приложения по классической трехуровневой схеме: клиентский уровень, средний слой, база данных. _Уровень_ отражает степень "удаленности" от хранимых данных. 

В дальнейшем речь пойдет в основном о среднем слое и клиентах, поэтому для краткости выражение "все уровни" означает два этих уровня.

На каждом уровне возможно создание одного или нескольких _блоков_ (units) приложения. Блок представляет собой обособленную исполняемую программу, взаимодействующую с другими блоками приложения. Средства платформы CUBA позволяют создавать блоки в виде веб-приложений и десктопных приложений. Разработка блоков для мобильных платформ на данный момент остается за рамками CUBA, однако такие блоки, созданные другими средствами, могут быть интегрированы со стандартными блоками приложения. 

.Уровни и блоки приложения
image::AppTiers.png[align="center"]

Middleware:: 
Средний слой, содержащий основную бизнес-логику приложения и выполняющий обращения к базе данных. Представляет собой отдельное веб-приложение под управлением стандартного контейнера <<javaee_web_profile,Java EE Web Profile>>. См. <<middleware,Компоненты среднего слоя>>

Web Client:: 
Основной блок клиентского уровня. Содержит интерфейс, предназначенный, как правило, для внутренних пользователей организации. Представляет собой отдельное веб-приложение под управлением стандартного контейнера *Java EE Web Profile*. Реализация <<gui_framework,пользовательского интерфейса>> основана на фреймворке *Vaadin*. См. <<gui_framework,Универсальный пользовательский интерфейс>>

Desktop Client:: 
Дополнительный блок клиентского уровня. Содержит интерфейс, предназначенный, как правило, для внутренних пользователей организации. Представляет собой десктопное Java-приложение, реализация пользовательского интерфейса основана на фреймворке *Java Swing*. См. <<gui_framework,Универсальный пользовательский интерфейс>>

Web Portal:: 
Дополнительный блок клиентского уровня. Содержит интерфейс для внешних пользователей и средства интеграции с мобильными устройствами и сторонними приложениями. Представляет собой отдельное веб-приложение под управлением стандартного контейнера *Java EE Web Profile*. Реализация пользовательского интерфейса основана на фреймворке *Spring MVC*. См. <<portal,Компоненты портала>>

Обязательным блоком любого приложения является средний слой - *Middleware*. Для реализации пользовательского интерфейса, как правило, используется один или несколько клиентских блоков, например, *Web Client* и *Web Portal*. 

Вышеперечисленные блоки являются стандартными, однако в сложном приложении для разделения функциональности можно без труда создать произвольное количество как клиентских блоков, так и блоков среднего слоя.

Все клиентские блоки взаимодействуют со средним слоем одинаковым образом посредством протокола *HTTP*, что позволяет размещать средний слой произвольным образом, в том числе за сетевым экраном. Следует отметить, что при развертывании в простейшем случае среднего слоя и веб-клиента на одном сервере между ними организуется локальное взаимодействие в обход сетевого стека для снижения накладных расходов.

[[app_modules]]
==== Модули приложения

Модуль – наименьшая структурная единица CUBA-приложения. Представляет собой один модуль проекта приложения и соответствующий ему JAR файл с исполняемым кодом.

Стандартные модули: 

* *global* – включает в себя классы сущностей, интерфейсы сервисов и другие общие для всех уровней классы. Используется во всех <<app_tiers,блоках приложения>>.

* *core* – реализация сервисов и всех остальных компонентов среднего слоя. Используется только на *Middleware*.

* *gui* – общие компоненты <<gui_framework,универсального пользовательского интерфейса>>. Используется в *Web Client* и *Desktop Client*.

* *web* – реализация универсального пользовательского интерфейса на *Vaadin*, а также другие специфичные для веб-клиента классы. Используется в блоке *Web Client*.

* *desktop* – опциональный модуль – реализация универсального пользовательского интерфейса на *Java Swing*, а также другие специфичные для десктоп-клиента классы. Используется в блоке *Desktop Client*.

* *portal* – опциональный модуль – реализация веб-портала на *Spring MVC*. 

.Модули приложения
image::AppModules.png[align="center"]

[[base_projects]]
==== Базовые проекты

Функциональность платформы разделена на несколько так называемых _базовых проектов_: 

* *cuba* – основной базовый проект, содержит всю функциональность, описанную в данном руководстве, плюс подсистему безопасности (управление пользователями и их доступом к данным)

* *reports* – подсистема генерации отчетов

* *workflow* – подсистема управления потоками работ со встроенным визуальным редактором бизнес-процессов

* *fts* – подсистема полнотекстового поиска

* *charts* – подсистема вывода диаграмм

* *ccpayments* – подсистема работы с кредитными картами

* *bpmn* – механизм исполнения бизнес-процессов по стандарту *BPMN 2.0*

Создаваемое на основе платформы приложение может включать в себя функциональность базовых проектов путем объявления зависимостей от их <<artifact,артефактов>>. Зависимость от артефактов *cuba* является обязательной. Опциональные базовые проекты в свою очередь также зависят от *cuba*, и в принципе могут содержать зависимости между собой.

.Зависимости между проектами
image::BaseProjects.png[align="center"]

Сплошными линиями изображены обязательные зависимости, пунктирными − опциональные.

==== Состав приложения

Вышеописанные архитектурные принципы напрямую отражаются на составе собранного приложения. Рассмотрим его на примере простого приложения *sales*, которое имеет 2 блока – *Middleware* и *Web Client*; и включает в себя функциональность базовых проектов *cuba* и *reports*.

.Состав простого приложения
image::SampleAppArtifacts.png[align="center"]

На рисунке изображено содержимое некоторых каталогов сервера *Tomcat* с развернутым в нем приложением *sales*. 

<<app_tiers,Блок>> *Middleware* реализован веб-приложением `app-core`, блок *Web Client* – веб-приложением `app`. Исполняемый код веб-приложений содержится в каталогах `WEB-INF/lib` в наборе JAR-файлов. Каждый JAR представляет собой результат сборки (<<artifact,артефакт>>) одного из <<app_modules,модулей>> приложения или <<base_projects,базового проекта>>.

Например, состав JAR-файлов веб-приложения среднего слоя `app-core` определяется тем, что блок *Middleware* состоит из модулей *global* и *core*, и приложение использует базовые проекты *cuba* и *reports* (в данном случае версии 4.0.0). 

