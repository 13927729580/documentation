:sourcesdir: ../../../../source

[[bluemix_deployment]]
==== Развёртывание в облаке Bluemix

С помощью CUBA Studio можно легко развернуть приложение в облаке IBM® Bluemix®.

[TIP]
====
Развёртывание в облаке Bluemix в настоящее время рекомендуется только для проектов, использующих базу данных PostgreSQL. HSQLDB доступна только с опцией _in-process_, таким образом, база данных будет пересоздаваться каждый раз при перезапуске облачного приложения, соответственно, пользовательские данные будут потеряны.
====

. Создайте учётную запись в сервисе Bluemix. Также скачайте и установите следующее программное обеспечение:
.. Bluemix CLI: http://clis.ng.bluemix.net/ui/home.html
.. Cloud Foundry CLI: https://github.com/cloudfoundry/cli/releases
.. После установки убедитесь, что команды `bluemix` и `cf` работают в командной строке. При необходимости добавьте путь к исполняемым файлам `\IBM\Bluemix\bin` в переменную среды `PATH`.

. Создайте новое пространство (Space) в облаке Bluemix, задайте ему любое имя. В дальнейшем вы можете поместить несколько приложений в одно пространство.

. Добавьте к созданному пространству сервер приложений Tomcat: *Create App* -> *CloudFoundry Apps* -> *Tomcat*.

. Задайте имя приложения. Имя должно быть уникальным, так как на его основе строится URL, по которому WEB-приложение будет доступно впоследствии.

. Чтобы добавить к пространству подходящий сервис базы данных, нажмите *Create service* в панели управления пространством и выберите *ElephantSQL*.

. Откройте панель управления приложением (ранее созданный Tomcat) и подключите сервис базы данных к приложению. Нажмите *Connect Existing*. Чтобы изменения вступили в силу, система предлагает обновить (restage) приложение. На данном этапе в этом нет необходимости: сервер Tomcat будет обновлен позже при развертывании CUBA-приложения.

. После подключения сервиса базы данных к приложению параметры подключения к СУБД будут доступны по кнопке *View Credentials*. Также параметры подключения к СУБД сохраняются в переменной среды `VCAP_SERVICES` облачного приложения и доступны по команде `cf&#160;env`. Созданная БД доступна глобально, управлять базой данных можно по указанному URL.

. Настройте CUBA-проект на базу данных PostgreSQL (на СУБД, аналогичную той которую Вы используете в облаке Bluemix).

. Создайте скрипты базы данных и запустите локальный сервер Tomcat. Убедитесь, что приложение работоспособно.

. Создайте WAR-файл, при помощи которого приложение будет равзернуто в сервер Tomcat.
.. Нажмите *Deployment Settings* в разделе *Project Properties* панели навигатора Studio.
.. Перейдите на вкладку *WAR*.
.. При помощи чекбоксов выберите все доступные опции: для корректного развертывания в облаке необходим единый *Single WAR* файл с помещёнными в него драйвером базы данных и конфигурационным файлом `context.xml`.
+
image::bluemix_war_settings.png[align="center"]

.. Нажмите кнопку *Generate* рядом с полем *Custom context.XML*. В появившемся диалоге укажите параметры подключения к базе данных - сервису в облаке Bluemix.
+
Используйте параметры из строки `uri` сервиса, как в примере ниже:
+
[source, json]
----
include::{sourcesdir}/deployment/bluemix_credentials.json[]
----
+
*Database user*: `ldwpelpl`
+
*Database password*: `eFwXx6lNFLheO5maP9iRbS77Sk1VGO_T`
+
*Database URL*: `echo-01.db.elephantsql.com:5432`
+
*Database name*: `ldwpelpl`

.. Нажмите кнопку *Generate* для создания собственного файла `web.xml`, необходимого для единого WAR-файла.

.. Сохраните настройки. Создайте WAR-файл, выполнив команду Gradle `buildWar` в Studio или из командной строки.
+
image::bluemix_buildWar.png[align="center"]
+
В результате, в папке проекта `build/distributions/war/` появился файл `app.war`.

. В корневом каталоге прокекта вручную создайте файл `manifest.yml` со следующим содержимым:
+
[source, yml]
----
include::{sourcesdir}/deployment/bluemix_manifest.yml[]
----
+
где
+
* `path` - относительный путь к сгенерированному WAR-файлу.
* `memory`: по умолчанию серверу Tomcat выделяется лимит памяти в 1G. При необходимости вы можете уменьшить или увеличить объём выделенной памяти, эта настройка также доступна через WEB-интерфейс Bluemix. Учтите, что количество памяти, выделенной приложению, влияет на стоимость облачного размещения.
* `name` - имя сервера приложения Tomcat, созданного в облаке.
* `host`: идентично имени приложения.
* `env`: этим параметром задаются переменные среды. В нашем случае переменными среды задаются версии Tomcat и Java, необходимые для правильного функционирования CUBA-приложения.

. В комадной строке перейдите в корневой каталог проекта CUBA.
+
[source, yml]
----
cd your_project_directory
----

. Создайте подключение к Bluemix.
+
[source, yml]
----
bluemix api https://api.ng.bluemix.net
----

. Зайдите в Вашу учетную запись Bluemix.
+
[source, yml]
----
cf login
----

.  Разверните созданный WAR в облачный Tomcat.
+
[source, yml]
----
cf push
----
+
Команда `push` использует параметры, указанные в конфигурационном файле `manifest.yml`.

. Посмотреть логи сервера Tomcat можно на вкладке *Logs* панели управления приложением в WEB-интерфейсе Bluemix, а также в командной строке при помощи команды
+
[source, yml]
----
cf logs cuba-app --recent
----

. По завершению процесса развёртывания CUBA-приложение будет доступно в облаке Bluemix. Чтобы его открыть, воспользуйтесь URL `host.domain` в браузере. Этот URL будет отображаться в поле *ROUTE* таблицы ваших приложений *Cloud Foundry Apps*.

