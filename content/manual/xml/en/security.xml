<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" []>
<chapter id="chapter_security" lang="en">
  <title>Security Subsystem</title>
  <para>The CUBA platform uses the following methods to control access rights:
      <itemizedlist>
      <listitem>
        <para>The <link linkend="roles">role-based</link> system for assigning user <link linkend="permissions">permissions</link>. A set of roles and permissions can be configured by the system administrator during the system deployment or later in production.</para>
      </listitem>
      <listitem>
        <para>A hierarchical structure of <link linkend="groups">access groups</link> with <link linkend="constraints">constraint</link> inheritance.</para>
      </listitem>
      <listitem>Access control at the following levels: <itemizedlist>
          <listitem>
            <para>Operations on entities (read, create, update, delete): for example, user <userinput>Smith</userinput> can view documents, but cannot create, update or delete them.</para>
          </listitem>
          <listitem>
            <para>Entity attributes (modify, read, access denied): user <userinput>Smith</userinput> can view all document attributes except for <code>amount</code>.</para>
          </listitem>
          <listitem>
            <para>Access to particular entity instances (access control at the row level): user <userinput>Smith</userinput> can view the documents that have been created in their department only.</para>
          </listitem>
        </itemizedlist></listitem>
      <listitem>
        <para>Integration with <link linkend="ldap">LDAP</link>  with an ability to implement SSO (Single Sign-On) for <application>Windows</application> users.</para>
      </listitem>
    </itemizedlist>
  </para>
  <section id="security_components">
    <title>Security Subsystem Components</title>
    <para>The main CUBA security subsystem components are shown in the diagram below. </para>
    <figure>
      <title>Security Subsystem Components Diagram</title>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/Security.png"/>
        </imageobject>
      </mediaobject>
    </figure>
    <para>Below is an overview of these components. </para>
    <para><emphasis>Security management screens</emphasis> – screens available to system administrator for configuring <link linkend="users">user</link> access rights.</para>
    <para><emphasis>Login screen</emphasis>  − system <link linkend="login_screen">login</link> window. This window provides user authentication by username and password. The database stores password hashes for security.</para>
    <para>The <link linkend="userSession">UserSession</link> object is created upon login. This is the central security element associated with the currently authenticated user and containing information on data access rights.</para>
    <para>The user login process is described in  <xref linkend="login"/>.</para>
    <para><emphasis>Roles</emphasis> − user roles. A <link linkend="roles">role</link> is a system object, which, on the one hand, matches the <link linkend="permissions">permission</link> set required to perform specific functions, and on the other hand, the subset of users who must have these permissions.</para>
    <para>The permissions can have the following types:<itemizedlist>
        <listitem>
          <para><emphasis>Screen Permissions</emphasis> − an ability to open a screen.</para>
        </listitem>
        <listitem>
          <para><emphasis>Entity Operation Permissions</emphasis> − an ability to perform operations with an entity: read, create, update, delete.</para>
        </listitem>
        <listitem>
          <para><emphasis>Entity Attribute Permissions</emphasis> − access to an arbitrary entity attribute: modify, read only, access denied.</para>
        </listitem>
        <listitem>
          <para><emphasis>Specific Permissions</emphasis> − permissions for some named functionality.</para>
        </listitem>
        <listitem>
          <para><emphasis>UI Permissions</emphasis> − control access to screen elements.</para>
        </listitem>
      </itemizedlist> </para>
    <para><emphasis>Access Groups</emphasis> −  user access groups. The <link linkend="groups">groups</link> have a hierarchical structure, with each element defining a set of <link linkend="constraints">constraints</link>, allowing controlling access to individual entity instances (at table row level). For example,  users can view the documents that have been created in their department only.</para>
    <section id="login_screen">
      <title>Login Screen</title>
      <para>The login screen provides ability to register within the system with a username and password.</para>
      <para>The login is case-insensitive.</para>
      <para>The Web Client screen class is <code>LoginWindow</code>, the Desktop Client class is <code>LoginDialog</code>. These classes can be extended to provide additional functionality in the application. Override the following methods to register extended classes:<itemizedlist>
          <listitem>
            <para> <code>createLoginWindow()</code> method of the <code>com.haulmont.cuba.web.App</code> class for the <link linkend="gui_web">Web Client</link>.</para>
          </listitem>
          <listitem>
            <para> <code>createLoginDialog()</code> method of the <code>com.haulmont.cuba.desktop.App</code> class for the <link linkend="gui_desktop">Desktop Client</link>.</para>
          </listitem>
        </itemizedlist></para>
      <para>The Web Client’s <guilabel>Remember Me</guilabel> checkbox can be configured by using the  <link linkend="cuba.web.rememberMeEnabled">cuba.web.rememberMeEnabled</link> application property.</para>
      <para>The drop-down list of supported languages on the standard login screen can be configured with the <link linkend="cuba.localeSelectVisible">cuba.localeSelectVisible</link> and <link linkend="cuba.availableLocales">cuba.availableLocales</link> application properties.</para>
    </section>
    <section id="users">
      <title>Users</title>
      <para>Each system user has a corresponding instance of <code>sec$User</code> entity, containing unique login, password hash, reference to access group and list of roles, and other attributes. User management is carried out using the <guimenu>Administration</guimenu> &gt; <guimenu>Users screen</guimenu>: </para>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/user_browser.png"/>
        </imageobject>
      </mediaobject>
      <para>In addition to the standard actions to create, update and delete records, the following actions are available:<itemizedlist>
          <listitem>
            <para><guibutton>Copy</guibutton> – quickly creates a new user based on the selected one. The new user will have the same access group and role set. Both can be changed in the new user edit screen.</para>
          </listitem>
          <listitem>
            <para><guibutton>Copy settings</guibutton> – allows copying user interface settings from one user to several others. The settings include the <link linkend="gui_Table_presentations">table presentations</link>, the <link linkend="gui_SplitPanel">SplitPanel</link> separator position, <link linkend="gui_Filter">filters</link> and <link linkend="folders_pane">search folders</link>.</para>
          </listitem>
          <listitem>
            <para><guibutton>Change password</guibutton> – allowing changing password for a selected user.</para>
          </listitem>
          <listitem>
            <para><guibutton>Reset passwords</guibutton> – allows performing the following actions on selected users:<itemizedlist>
                <listitem>
                  <para>If <guilabel>Generate new passwords</guilabel> flag is not selected in the <guilabel>Reset passwords for selected users</guilabel> dialog, the <guilabel>Change password at next logon</guilabel> flag will be assigned to selected users. These users will be asked to change the password on the next successful login.</para>
                </listitem>
                <listitem>
                  <para>If <guilabel>Generate new passwords flag</guilabel> is selected, new random passwords will be generated for selected users and displayed to the system administrator. The list of passwords can be exported to XLS and sent to related users. Additionally, the <guilabel>Change password at next logon</guilabel> flag will be set for each user, ensuring that users change the password on next login.</para>
                </listitem>
                <listitem>
                  <para>If <guilabel>Send emails with generated passwords</guilabel> flag is selected in addition to <guilabel>Generate new passwords</guilabel>, the automatically generated one-time passwords will be sent to corresponding users directly, and not shown to system administrator.</para>
                </listitem>
              </itemizedlist></para>
          </listitem>
        </itemizedlist></para>
      <para>The user edit screen is described below:<mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/user_editor.png"/>
          </imageobject>
        </mediaobject></para>
      <itemizedlist>
        <listitem>
          <para><guilabel>Login</guilabel> – unique login name (required).</para>
        </listitem>
        <listitem>
          <para><guilabel>Group</guilabel> – <link linkend="groups">access group</link>.</para>
        </listitem>
        <listitem>
          <para><guilabel>Last name</guilabel>, <guilabel>First name</guilabel>, <guilabel>Middle name</guilabel> – parts of user’s full name.</para>
        </listitem>
        <listitem>
          <para><guilabel>Name</guilabel> – automatically generated user’s full name. Based on full name parts above and a rule defined in the <link linkend="cuba.user.fullNamePattern">cuba.user.fullNamePattern</link> application property. The name can also be changed manually.</para>
        </listitem>
        <listitem>
          <para><guilabel>Position</guilabel> – job position.</para>
        </listitem>
        <listitem>
          <para><guilabel>Language</guilabel> – the user interface language that will be set for the user, if the ability to choose a language on login is turned off using the <link linkend="cuba.localeSelectVisible">cuba.localeSelectVisible</link> application property.</para>
        </listitem>
        <listitem>
          <para><guilabel>Email</guilabel> – email address.</para>
        </listitem>
        <listitem>
          <para><guilabel>Active</guilabel> – if not set, the user is unable to login to the system.</para>
        </listitem>
        <listitem>
          <para><guilabel>Permitted IP Mask</guilabel> – IP address mask, defining addresses from which the user is allowed to login.</para>
          <para>The mask is a list of IP addresses, separated with commas. Both the IPv4 and IPv6 address formats are supported. IPv4 address should consist of four numbers separated with periods. IPv6 address represents eight groups of four hexadecimal characters separated with colons.

The &quot;*” symbol can be used in place of an address part, to match any value. Only one type of address format (IPv4 or IPv6) can be used in the mask at the same time. </para>
          <para>Example: <code>192.168.*.*</code></para>
        </listitem>
        <listitem>
          <para><guilabel>Roles</guilabel> – user <link linkend="roles">roles</link> list.</para>
        </listitem>
        <listitem>
          <para><guilabel>Substituted Users</guilabel> – <link linkend="user_substitution">substituted</link> users list.</para>
        </listitem>
      </itemizedlist>
      <section id="user_substitution">
        <title>User Substitution</title>
        <para>The system administrator can give a user an ability to <emphasis>substitute</emphasis> another user. The substituting user will have the same <link linkend="userSession">session</link>, but a different set of <link linkend="roles">roles</link>, <link linkend="constraints">constraints</link> and <link linkend="session_attr">attributes</link>, assigned from the substituted user.</para>
        <tip>
          <para>It is recommended to use the <code>UserSession.getCurrentOrSubstitutedUser()</code> method for retrieving the current user in the application code, which returns the substituted user, if there is an active substitution. The platform audit mechanisms (the <code>createdBy</code> and <code>updatedBy</code> attributes, <link linkend="entity_log">change log</link> and <link linkend="entity_snapshots">entity snapshots</link>) always register the real logged-in user. </para>
        </tip>
        <para>If the user has substituted users, a drop-down list will be shown in the application upper right corner instead of the plain text with the current user name:<mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/user_subst_select.png"/>
            </imageobject>
          </mediaobject></para>
        <para>If another user is selected in this list, all opened screens will be closed and the substitution will be made active. The <code>UserSession.getUser()</code> method will still return the user that has logged in, however, the <code>UserSession.getSubstitutedUser()</code> method will return the substituted user. If there is no substitution, the <code>UserSession.getSubstitutedUser()</code> method will return <code>null</code>. </para>
        <para>Substituted users can be managed through the <guilabel>Substituted Users</guilabel> table in the user edit screen. The user substitution screen is described below:<mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/user_subst_edit.png"/>
            </imageobject>
          </mediaobject></para>
        <itemizedlist>
          <listitem>
            <para><guilabel>User</guilabel> – the edited user. This user will substitute another user.</para>
          </listitem>
          <listitem>
            <para><guilabel>Substituted user</guilabel> – the substituted user.</para>
          </listitem>
          <listitem>
            <para><guilabel>Start date</guilabel>, <guilabel>End date</guilabel> – optional substitution period. User substitution will be unavailable outside of this period. If no period is specified, substitution will be available until this table entry is removed.</para>
          </listitem>
        </itemizedlist>
      </section>
    </section>
    <section id="permissions">
      <title>Permissions</title>
      <para>The <emphasis>permission</emphasis> determines the user’s right to any system object or functionality, such as screen, entity operation, etc. The permission can either grant the user the right to the object, or revoke it (in essence, it is actually a <emphasis>prohibition</emphasis>).</para>
      <tip>
        <para>By default, the user has the right to an object, unless explicitly denied by a permission.</para>
      </tip>
      <para>The permissions are granted by the <code>sec$Permission</code> entity instances and contain the following attributes:<itemizedlist>
          <listitem>
            <para><code>type</code> – permission type: determines the object type the permission is imposed on.</para>
          </listitem>
          <listitem>
            <para><code>target</code> – permission object: determines the specific object the permission is imposed on. The format of the attribute depends on the permission type.</para>
          </listitem>
          <listitem>
            <para><code>value</code> – permission value. The value range depends on the permission type.</para>
          </listitem>
        </itemizedlist></para>
      <para>The permission types are described below:<itemizedlist>
          <listitem>
            <para><code>PermissionType.SCREEN</code> – screen permission.</para>
            <para>The screen identifier should be specified in the <code>target</code> attribute; the <code>value</code> attribute can be 0 or 1 (the screen is denied or allowed, respectively).</para>
            <para>The screen permissions are checked when building the system main menu and with each invocation of the <code>openWindow()</code>, <code>openEditor()</code>, <code>openLookup()</code> methods of the <link linkend="abstractFrame">IFrame</link> interfaces.</para>
            <para>To check the screen permission in the application code, use the <code>isScreenPermitted()</code> method of the <link linkend="security">Security</link> interface.</para>
          </listitem>
          <listitem>
            <para><code>PermissionType.ENTITY_OP</code> – entity operation permission.</para>
            <para>The entity name should be specified in the <code>target</code> attribute, followed by a colon, and then an operation type: <code>create</code>, <code>read</code>, <code>update</code>, <code>delete</code>. For example: <userinput>library$Book:delete</userinput>. The <code>value</code> attribute can be 0 or 1 (the operation is denied or allowed, respectively).</para>
            <para>The entity operation permissions are checked when working with data through the <link linkend="dataService">DataService and DataWorker</link>, in data aware <link linkend="gui_components">visual components</link>, and in <link linkend="standard_actions">standard actions</link>, which work with entity lists. As a result, the operation permissions affect the behavior of the client blocks and the <link linkend="rest_api">REST API</link>. The permissions are not checked when working with data on the Middleware directly via the <link linkend="entityManager">EntityManager</link>.</para>
            <para>To check the entity operation permission in the application code, use the <code>isEntityOpPermitted()</code> method of the <link linkend="security">Security</link> interface.</para>
          </listitem>
          <listitem>
            <para><code>PermissionType.ENTITY_ATTR</code> – entity attribute permission.</para>
            <para>The entity name should be specified in the <code>target</code> attribute, followed by a colon, and then an attribute name. For example: <userinput>library$Book:name</userinput>. The <code>value</code> attribute can be 0, 1 or 2 (the attribute is hidden, read-only or read-write, respectively).</para>
            <para>The entity attribute permissions are only checked in the data aware <link linkend="gui_components">visual components</link> and the <link linkend="rest_api">REST API</link>.</para>
            <para>To check the entity attribute permission in the application code, use the <code>isEntityAttrPermitted()</code> method of the <link linkend="security">Security</link> interface.</para>
          </listitem>
          <listitem>
            <para><code>PermissionType.SPECIFIC</code> –  permission on an arbitrary named functionality.</para>
            <para>The functionality identifier should be specified in the <code>target</code> attribute; the <code>value</code> attribute can be 0 or 1 (denied or allowed, respectively).</para>
            <para>Specific permissions for this project are set in the configuration file <link linkend="permissions.xml">permissions.xml</link>.</para>
            <para>For example:<programlisting language="java">@Inject
private Security security;

private void calculateBalance() {
    if (!security.isSpecificPermitted(&quot;myapp.calculateBalance&quot;))
        return;
    ...
}</programlisting></para>
          </listitem>
          <listitem>
            <para><code>PermissionType.UI</code> – arbitrary screen component permission.</para>
            <para>The screen identifier should be specified in the <code>target</code> attribute, followed by a colon, and then a component path. The format of the component path is described in the next section.</para>
          </listitem>
        </itemizedlist></para>
      <tip>
        <para>To check permissions, instead of directly using methods of the <code>UserSession</code> class, it is recommended to use the same methods of <link linkend="security">Security</link> interface that works with possible entity <link linkend="entity_extension">extension</link>.</para>
      </tip>
    </section>
    <section id="roles">
      <title>Roles</title>
      <para>The role combines a set of <link linkend="permissions">permissions</link> that can be granted to the user.</para>
      <para>The user may have several roles, in which case a logical sum (OR) is devised from all of the assigned roles. For example, if a user has roles A, B and C, role A denies X, role B allows X, role C does not set explicit permissions on X, then X will be allowed.</para>
      <para>If no user roles explicitly define permission on the object, the user will have the permission for this object. Therefore, the users have rights to all the objects if they have no roles that explicitly define the permission, or have at least one role that grants the permission.</para>
      <warning>
        <para>If a user has a single role without explicitly set permissions, or does not have any roles at all, he will have all rights to all objects. </para>
      </warning>
      <para>The role list is displayed in the <guimenu>Administration</guimenu> &gt; <guimenu>Roles screen</guimenu>. In addition to the standard actions to create, update, and delete records, the screen has the <guibutton>Assign to users</guibutton> button, allowing assigning the selected role to multiple users.</para>
      <para>The role edit screen is described below. The role attributes are displayed in the upper part: </para>
      <mediaobject>
        <imageobject>
          <imagedata align="center" fileref="img/role_attributes.png"/>
        </imageobject>
      </mediaobject>
      <itemizedlist>
        <listitem>
          <para><guilabel>Name</guilabel> – unique role name or id (required). The name cannot be changed after the role has been created.</para>
        </listitem>
        <listitem>
          <para><guilabel>Localized name</guilabel> – user-friendly role name.</para>
        </listitem>
        <listitem>
          <para><guilabel>Description</guilabel> – arbitrary role description.</para>
        </listitem>
        <listitem>
          <para><guilabel>Type</guilabel> – role type, can be:<itemizedlist>
              <listitem>
                <para><guilabel>Standard</guilabel> – the role of this type grants only explicitly set permissions.</para>
              </listitem>
              <listitem>
                <para><guilabel>Super</guilabel> – the role of this type automatically grants all permissions. It should be assigned to system administrators, since it removes all prohibitions set by other roles.</para>
              </listitem>
              <listitem>
                <para><guilabel>Read-only</guilabel> – the role of this type automatically denies the permissions for the following entity operations: CREATE, UPDATE, DELETE. Therefore, the user with this role can only read the data and is unable to update it (unless there are other user roles explicitly allowing these operations).</para>
              </listitem>
              <listitem>
                <para><guilabel>Denying</guilabel> – the role of this type automatically denies the permissions for all objects, except entity attributes. In order to view or update something in the system, the user should be assigned an additional role that explicitly gives the necessary rights.</para>
              </listitem>
            </itemizedlist></para>
          <para>Permissions can be explicitly set for all the role types; for example, you can add the permissions to modify entities for the <guilabel>Read-only</guilabel> role. However, it does not make sense to prohibit anything for the <guilabel>Super</guilabel> role, because this special role type removes all prohibitions.</para>
        </listitem>
        <listitem>
          <para><guilabel>Default role</guilabel> – default role flag. All roles with this flag are automatically assigned to the newly created users.</para>
        </listitem>
      </itemizedlist>
      <para>The permission management tabs are described below.<itemizedlist>
          <listitem>
            <para>The <guilabel>Screens</guilabel> tab configures screen permissions:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/role_screen_permissions.png"/>
                </imageobject>
              </mediaobject></para>
            <para>The tree in the left part of the tab reflects the structure of the application’s main menu. The last tree element is <guilabel>Other screens</guilabel>, which contains screens without a main menu item (for example, entity edit screens).</para>
          </listitem>
          <listitem>
            <para>The <guilabel>Entities</guilabel> tab – configures entity operation permissions:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/role_entity_permissions.png"/>
                </imageobject>
              </mediaobject></para>
            <para>The <guilabel>Assigned only</guilabel> is selected by default, so that the table contains only the entities that have explicit permissions in this role. Therefore, the table for a new role will be empty. In order to add permissions, uncheck <guilabel>Assigned only</guilabel> and click <guibutton>Apply</guibutton>. The entity list can be filtered by entering a part of an entity name in the <guilabel>Entity</guilabel> field and clicking <guibutton>Apply</guibutton>.</para>
            <para><guilabel>System level</guilabel> checkbox allows viewing and selecting system entities marked with the <code>@SystemLevel</code> annotation, which are not shown by default.</para>
          </listitem>
          <listitem>
            <para>The <guilabel>Attributes</guilabel> tab – configures entity attribute permissions:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/role_attr_permissions.png"/>
                </imageobject>
              </mediaobject></para>
            <para>The <guilabel>Permissions</guilabel> column in the entity table shows the list of the attributes that have explicit permissions. The <guilabel>modify</guilabel> (full access) permissions are marked with green, <guilabel>read-only</guilabel> (read-only) – with blue, <guilabel>hide</guilabel> (the attribute is hidden) – with red.</para>
            <para>Entity list can be managed similarly to the list in the <guilabel>Entities</guilabel> tab.</para>
          </listitem>
          <listitem>
            <para>The <guilabel>Specific</guilabel> tab  configures named functionality permissions:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/role_specific_permissions.png"/>
                </imageobject>
              </mediaobject></para>
            <para>The <link linkend="permissions.xml">permissions.xml</link> project configuration file defines the object names to which specific permissions can be assigned.</para>
          </listitem>
          <listitem>
            <para>The <guilabel>UI</guilabel> tab  configures UI screen component permissions:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/role_ui_permissions.png"/>
                </imageobject>
              </mediaobject></para>
            <para>The permissions on this screen allow restricting access to any screen component, including the ones not associated with any data (for example, a container). The component identifiers

must be known to create such permissions, therefore access to the screen source code is required.</para>
            <para>In order to create a constraint, select the desired screen in the <guilabel>Screen</guilabel> drop-down list, specify the component path in the <guilabel>Component</guilabel> field, and click <guibutton>Add</guibutton>. Then set the access mode for the selected component in the <guilabel>Permissions</guilabel> panel.</para>
            <para>The rules to forming the component path are listed below:<itemizedlist>
                <listitem>
                  <para>If the component belongs to the screen, simply specify the component identifier, <code>id</code>.</para>
                </listitem>
                <listitem>
                  <para>If the component belongs to the frame that is embedded within the screen, specify the frame identifier, and then the component identifier separated with period.</para>
                </listitem>
                <listitem>
                  <para>If configuring permission for the <link linkend="gui_TabSheet">TabSheet</link> tab or the <link linkend="gui_FieldGroup">FieldGroup</link> field, specify the component identifier, and then the tab or field identifier in square brackets.</para>
                </listitem>
              </itemizedlist></para>
          </listitem>
        </itemizedlist></para>
    </section>
    <section id="groups">
      <title>Access Groups</title>
      <para>With access groups, users can be organized into a hierarchical structure and assigned <link linkend="constraints">constraints</link> and arbitrary <link linkend="session_attr">session attributes</link>.</para>
      <para>The user can be added to one group only, however the list of constraints and session attributes from all the groups up the hierarchy will be inherited.</para>
      <para>User access groups can be managed from the <guimenu>Administration</guimenu> &gt; <guimenu>Access Groups</guimenu> screen:<mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/group_users.png"/>
          </imageobject>
        </mediaobject></para>
      <section id="constraints">
        <title>Constraints</title>
        <para>Constraints allow restricting access to particular entity instances (table records).</para>
        <para>Constraints for an entity class are specified using <link linkend="jpql">JPQL</link> expression fragments. These fragments are appended to all entity instance selection queries, thereby filtering them.</para>
        <para>The user gets the constraint list from all the groups, starting with their own one, following up the hierarchy. Thus, the following principle is implemented: the lower the users are in the group hierarchy, the more constraints they have.</para>
        <para>In order to create a constraint in the <guimenu>Access Groups</guimenu> screen, select the group to create the constraint for, go to the <guilabel>Constraints</guilabel> tab and click <guibutton>Create</guibutton>:<mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/constraint_edit.png"/>
            </imageobject>
          </mediaobject></para>
        <para>Then, select an entity from the <guilabel>Entity Name</guilabel> drop-down list and set the constraint in the <guilabel>Join Clause</guilabel> and <guilabel>Where Clause</guilabel> fields.<tip>
            <para>The JPQL editor in the <guilabel>Join Clause</guilabel> and <guilabel>Where Clause</guilabel> fields supports autocompletion for entity names and their attributes. In order to invoke autocompletion, press <keycap>Ctrl+Space</keycap>. If the invocation is made after the period symbol, an entity attributes list matching the context will be shown, otherwise – a list of all data model entities.</para>
          </tip></para>
        <para>The following JPQL constraint rules apply:<itemizedlist>
            <listitem>
              <para>The <code>{E}</code> string should be used as an alias of the entity being extracted. On execution of the query, it will be replaced with a real alias, specified in the query.</para>
            </listitem>
            <listitem>
              <para>The following predefined constants can be used in JPQL parameters:<itemizedlist>
                  <listitem>
                    <para><literal>session$userLogin</literal> – login name of the current user (in case of <link linkend="user_substitution">substitution</link> – the login name of the substituted user).</para>
                  </listitem>
                  <listitem>
                    <para><literal>session$userId</literal> – ID of the current user (in case of substitution – ID of the substituted user).</para>
                  </listitem>
                  <listitem>
                    <para><literal>session$userGroupId</literal> – group ID of the current user (in case of substitution − group ID of the substituted user).</para>
                  </listitem>
                  <listitem>
                    <para><literal>session$XYZ</literal> – arbitrary attribute of the current <link linkend="userSession">user session</link>, where XYZ is the attribute name.</para>
                  </listitem>
                </itemizedlist></para>
            </listitem>
            <listitem>
              <para>The <guilabel>Where Clause</guilabel> field content is added to the <code>where</code> query clause using <code>and</code> condition. Adding <code>where</code> word is not needed, as it will be added automatically.</para>
            </listitem>
            <listitem>
              <para>The <guilabel>Join Clause</guilabel> field content is added to the <code>from</code> query clause. It should begin with a comma, <code>join</code> or <code>left join</code>.</para>
            </listitem>
          </itemizedlist></para>
        <para>The simplest constraint example is shown in the figure above: the users with this constraint will see the <code>library$BookPublication</code> entity instances that they have created themselves only. </para>
      </section>
      <section id="session_attr">
        <title>Session Attributes</title>
        <para>The access group can determine the <link linkend="userSession">session</link> attribute list for the users in this group. These attributes can be used when setting the <link linkend="constraints">constraints</link>. The availability of the session attributes can be checked in the application code at the development stage, so the final system behavior for particular user groups can be controlled at the operation stage. </para>
        <para>When logging in, all the attributes set for the user group and for all the groups up the hierarchy will be placed into the user session. If an attribute is found in several levels of the hierarchy, the uppermost group value will be used. Hence, overriding the attribute values at the lower levels of the hierarchy is not possible. In case of the override attempt, the <code>WARN</code> level message will be written to the server <link linkend="logging_setup_tomcat">log</link>. </para>
        <para>In order to create an attribute in the <guimenu>Access Groups</guimenu> screen, select the group to create the attribute for, go to the <guilabel>Session Attributes</guilabel> tab, and click <guibutton>Create</guibutton>:<mediaobject>
            <imageobject>
              <imagedata align="center" fileref="img/session_attr_edit.png"/>
            </imageobject>
          </mediaobject></para>
        <para>A unique attribute name, data type, and value must be specified. </para>
        <para>A <link linkend="userSession">session</link> attribute can be accessed in the application code in the following way:<programlisting language="java">@Inject
private UserSessionSource userSessionSource;
...
Integer accessLevel = userSessionSource.getUserSession().getAttribute(&quot;accessLevel&quot;);</programlisting></para>
        <para>A session attribute can be used in the <link linkend="constraints">constraints</link> as a JPQL parameter by adding the <code>session$</code> prefix:<programlisting>{E}.accessLevel = :session$accessLevel</programlisting></para>
      </section>
    </section>
    <section id="ldap">
      <title>Integration with LDAP</title>
      <para>CUBA application can be integrated with LDAP to provide the following benefits:<orderedlist>
          <listitem>
            <para>Keep and manage user passwords centrally in the LDAP database.</para>
          </listitem>
          <listitem>
            <para>For Windows domain users, allow logging in through Single Sign-On without having to specify the username and password.</para>
          </listitem>
        </orderedlist></para>
      <para>To enable login, a user account with all the required properties and permissions must be created in the application. It is recommended to leave the password empty, so that the user could log in using the password from LDAP only. The first authentication attempt is made via LDAP, followed by the standard way of using the password hash from the database. As a result, a user can log in to the system with this password even if the user is not registered in LDAP or has a different LDAP password.</para>
      <para>A CUBA-based application interacts with LDAP via the  <code>CubaAuthProvider</code> interface. The platform includes a single implementation of this interface, <code>LdapAuthProvider</code>, which supports LDAP authentication without Single Sign-On. In order to enable advanced Active Directory integration and Single Sign-On, the <application>Jespa</application> library can be used with the corresponding  <code>CubaAuthProvider</code> implementation, as described in   <xref linkend="jespa"/>. A custom  <code>CubaAuthProvider</code> implementation class can also be used by setting the following application properties:<programlisting>cuba.web.useActiveDirectory = true
cuba.web.activeDirectoryAuthClass = com.company.sample.web.MyAuthProvider</programlisting></para>
      <section id="ldap_basic">
        <title>Basic Active Directory Integration</title>
        <para>If the <code>cuba.web.useActiveDirectory</code> property is enabled, the    <code>LdapAuthProvider</code> class is used by default. In this case,  <application>Spring LDAP</application> library is used for user authentication.</para>
        <para>The following Web Client application properties are used to setup:<itemizedlist>
            <listitem>
              <para><code>cuba.web.ldap.urls</code> – Active Directory server URL.</para>
            </listitem>
            <listitem>
              <para><code>cuba.web.ldap.base</code> – database for username search.</para>
            </listitem>
            <listitem>
              <para><code>cuba.web.ldap.user</code> –  <code>sAMAccountName</code> attribute value of the user, which has the right to read the information from the Active Directory.</para>
            </listitem>
            <listitem>
              <para><code>cuba.web.ldap.password</code> – the password for the LDAP user defined in the <code>cuba.web.ldap.user</code> property.</para>
            </listitem>
          </itemizedlist></para>
        <para>Example of  <link linkend="app_properties_files">local.app.properties</link> file for the Web Client block:<programlisting>cuba.web.useActiveDirectory = true
cuba.web.ldap.urls = ldap://192.168.1.1:389
cuba.web.ldap.base = ou=Employees,dc=mycompany,dc=com
cuba.web.ldap.user = myuser
cuba.web.ldap.password = mypassword</programlisting></para>
      </section>
      <section id="jespa">
        <title>Setting Up Authentication Using Jespa</title>
        <para>Jespa is a Java library that enables integrating Active Directory service and Java applications using  <ulink url="http://en.wikipedia.org/wiki/NTLMv2#NTLMv2">NTLMv2</ulink>. For details, see  <ulink url="http://www.ioplex.com">http://www.ioplex.com</ulink>. </para>
        <section>
          <title>Including the Library</title>
          <para>Download the library at  <ulink url="http://www.ioplex.com">http://www.ioplex.com</ulink> and place the JAR in a   <link linkend="artifact_repository">repository</link> registered in your <link linkend="build.gradle">build.gradle</link> script. This can be  <code>mavenLocal()</code> or an in-house repository.</para>
          <para>Add the following dependency to the <structname>web</structname> module configuration section in  <filename>build.gradle</filename>:<programlisting>configure(webModule) {
    ...
    dependencies {
        compile(&apos;com.company.thirdparty:jespa:1.1.17&apos;)
    ...    </programlisting></para>
          <para>Create a <code>CubaAuthProvider</code> implementation class in the <structname>web</structname> module:<programlisting language="java">package com.company.sample.web;

import com.haulmont.cuba.core.global.AppBeans;
import com.haulmont.cuba.core.global.Configuration;
import com.haulmont.cuba.core.global.GlobalConfig;
import com.haulmont.cuba.core.global.Messages;
import com.haulmont.cuba.core.sys.AppContext;
import com.haulmont.cuba.security.global.LoginException;
import com.haulmont.cuba.web.auth.ActiveDirectoryHelper;
import com.haulmont.cuba.web.auth.CubaAuthProvider;
import com.haulmont.cuba.web.auth.DomainAliasesResolver;
import jespa.http.HttpSecurityService;
import jespa.ntlm.NtlmSecurityProvider;
import jespa.security.PasswordCredential;
import jespa.security.SecurityProviderException;
import org.apache.commons.lang.StringUtils;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

import javax.inject.Inject;
import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import java.io.IOException;
import java.util.HashMap;
import java.util.Locale;
import java.util.Map;

public class JespaAuthProvider extends HttpSecurityService implements CubaAuthProvider {

    private static class DomainInfo {
        private String bindStr;
        private String acctName;
        private String acctPassword;

        private DomainInfo(String bindStr, String acctName, String acctPassword) {
            this.acctName = acctName;
            this.acctPassword = acctPassword;
            this.bindStr = bindStr;
        }
    }

    private static Map&lt;String, DomainInfo&gt; domains = new HashMap&lt;&gt;();

    private static String defaultDomain;

    private Log log = LogFactory.getLog(getClass());

    @Inject
    private Configuration configuration;

    @Inject
    private Messages messages;

    @SuppressWarnings(&quot;deprecation&quot;)
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {

        initDomains();

        Map&lt;String, String&gt; properties = new HashMap&lt;&gt;();

        properties.put(&quot;jespa.bindstr&quot;, getBindStr());
        properties.put(&quot;jespa.service.acctname&quot;, getAcctName());
        properties.put(&quot;jespa.service.password&quot;, getAcctPassword());
        properties.put(&quot;jespa.account.canonicalForm&quot;, &quot;3&quot;);
        properties.put(&quot;jespa.log.path&quot;, configuration.getConfig(GlobalConfig.class).getLogDir() + &quot;/jespa.log&quot;);
        properties.put(&quot;http.parameter.anonymous.name&quot;, &quot;anon&quot;);

        fillFromSystemProperties(properties);

        try {
            super.init(properties);
        } catch (SecurityProviderException e) {
            throw new ServletException(e);
        }
    }

    @Override
    public void destroy() {
    }

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest httpServletRequest = (HttpServletRequest) request;
        if (httpServletRequest.getHeader(&quot;User-Agent&quot;) != null) {
            String ua = httpServletRequest.getHeader(&quot;User-Agent&quot;).toLowerCase();
            boolean windows = ua.contains(&quot;windows&quot;);
            boolean gecko = ua.contains(&quot;gecko&quot;) &amp;&amp; !ua.contains(&quot;webkit&quot;);
            if (!windows &amp;&amp; gecko) {
                chain.doFilter(request, response);
                return;
            }
        }
        super.doFilter(request, response, chain);
    }

    @Override
    public void authenticate(String login, String password, Locale loc) throws LoginException {
        DomainAliasesResolver aliasesResolver = AppBeans.get(DomainAliasesResolver.NAME);

        String domain;
        String userName;

        int atSignPos = login.indexOf(&quot;@&quot;);
        if (atSignPos &gt;= 0) {
            String domainAlias = login.substring(atSignPos + 1);
            domain = aliasesResolver.getDomainName(domainAlias).toUpperCase();
        } else {
            int slashPos = login.indexOf(&apos;\\&apos;);
            if (slashPos &lt;= 0) {
                throw new LoginException(
                        messages.getMessage(ActiveDirectoryHelper.class, &quot;activeDirectory.invalidName&quot;, loc),
                        login
                );
            }
            String domainAlias = login.substring(0, slashPos);
            domain = aliasesResolver.getDomainName(domainAlias).toUpperCase();
        }

        userName = login;

        DomainInfo domainInfo = domains.get(domain);
        if (domainInfo == null) {
            throw new LoginException(
                    messages.getMessage(ActiveDirectoryHelper.class, &quot;activeDirectory.unknownDomain&quot;, loc),
                    domain
            );
        }

        Map&lt;String, String&gt; params = new HashMap&lt;&gt;();
        params.put(&quot;bindstr&quot;, domainInfo.bindStr);
        params.put(&quot;service.acctname&quot;, domainInfo.acctName);
        params.put(&quot;service.password&quot;, domainInfo.acctPassword);
        params.put(&quot;account.canonicalForm&quot;, &quot;3&quot;);
        fillFromSystemProperties(params);

        NtlmSecurityProvider provider = new NtlmSecurityProvider(params);
        try {
            PasswordCredential credential = new PasswordCredential(userName, password.toCharArray());
            provider.authenticate(credential);
        } catch (SecurityProviderException e) {
            throw new LoginException(
                    messages.getMessage(ActiveDirectoryHelper.class, &quot;activeDirectory.authenticationError&quot;, loc),
                    e.getMessage()
            );
        }
    }

    private void initDomains() {
        String domainsStr = AppContext.getProperty(&quot;cuba.web.activeDirectoryDomains&quot;);
        if (!StringUtils.isBlank(domainsStr)) {
            String[] strings = domainsStr.split(&quot;;&quot;);
            for (int i = 0; i &lt; strings.length; i++) {
                String domain = strings[i];
                domain = domain.trim();
                if (!StringUtils.isBlank(domain)) {
                    String[] parts = domain.split(&quot;\\|&quot;);
                    if (parts.length != 4) {
                        log.error(&quot;Invalid ActiveDirectory domain definition: &quot; + domain);
                        break;
                    } else {
                        domains.put(parts[0], new DomainInfo(parts[1], parts[2], parts[3]));
                        if (i == 0)
                            defaultDomain = parts[0];
                    }
                }
            }
        }
    }

    public String getDefaultDomain() {
        return defaultDomain != null ? defaultDomain : &quot;&quot;;
    }

    public String getBindStr() {
        return getBindStr(getDefaultDomain());
    }

    public String getBindStr(String domain) {
        initDomains();
        DomainInfo domainInfo = domains.get(domain);
        return domainInfo != null ? domainInfo.bindStr : &quot;&quot;;
    }

    public String getAcctName() {
        return getAcctName(getDefaultDomain());
    }

    public String getAcctName(String domain) {
        initDomains();
        DomainInfo domainInfo = domains.get(domain);
        return domainInfo != null ? domainInfo.acctName : &quot;&quot;;
    }

    public String getAcctPassword() {
        return getAcctPassword(getDefaultDomain());
    }

    public String getAcctPassword(String domain) {
        initDomains();
        DomainInfo domainInfo = domains.get(domain);
        return domainInfo != null ? domainInfo.acctPassword : &quot;&quot;;
    }

    public void fillFromSystemProperties(Map&lt;String, String&gt; params) {
        for (String name : AppContext.getPropertyNames()) {
            if (name.startsWith(&quot;jespa.&quot;)) {
                params.put(name, AppContext.getProperty(name));
            }
        }
    }
}</programlisting></para>
        </section>
        <section>
          <title>Setting Up Configuration</title>
          <itemizedlist>
            <listitem>
              <para>Follow the steps described in <guimenu>Installation</guimenu> -&gt; <guimenu>Step 1: Create the Computer Account for NETLOGON Communication</guimenu> of the <application>Jespa Operator&apos;s Manual</application>, which is available at  <ulink url="http://www.ioplex.com/support.html">http://www.ioplex.com/support.html</ulink>.</para>
            </listitem>
            <listitem>
              <para>Set domain parameters in the <code>cuba.web.activeDirectoryDomains</code> property in the   <link linkend="app_properties_files">local.app.properties</link> file. Each domain descriptor should have the following format: <code>domain_name|full_domain_name|service_account_name|service_account_password</code>. Domain descriptors are separated by semicolons. </para>
              <para>Example:<programlisting>cuba.web.activeDirectoryDomains = MYCOMPANY|mycompany.com|JESPA$@MYCOMPANY.COM|password1;TEST|test.com|JESPA$@TEST.COM|password2</programlisting></para>
            </listitem>
            <listitem>
              <para>Enable the Active Directory integration by setting the <code>cuba.web.useActiveDirectory</code>  property in the <filename>local.app.properties</filename> file:<programlisting>cuba.web.useActiveDirectory = true</programlisting></para>
            </listitem>
            <listitem>
              <para>Configure additional Jespa properties in the  <filename>local.app.properties</filename> file (see <application>Jespa Operator&apos;s Manual</application>). For example:<programlisting>jespa.log.level=3</programlisting></para>
            </listitem>
            <listitem>
              <para>Add the server address to the local intranet in the browser settings:<itemizedlist>
                  <listitem>
                    <para>For  <application>Internet Explorer</application> and <application>Chrome</application>: Settings -&gt; Security -&gt; Local intranet -&gt; Sites -&gt; Advanced</para>
                  </listitem>
                  <listitem>
                    <para>For <application> Firefox</application>: about:config -&gt; network.automatic-ntlm-auth.trusted-uris=http://myapp.mycompany.com</para>
                  </listitem>
                </itemizedlist></para>
            </listitem>
          </itemizedlist>
        </section>
      </section>
    </section>
  </section>
  <section id="security_examples">
    <title>Access Control Examples</title>
    <para>This section provides some practical recommendations on how to configure data access for users.</para>
    <section id="roles_example">
      <title>Configuring Roles</title>
      <para>The recommended way to configure <link linkend="roles">roles</link> and <link linkend="permissions">permissions</link> is as follows:<orderedlist>
          <listitem>
            <para>Create a <userinput>Default</userinput> role, which denies all system rights. Create a role with <guilabel>Denying</guilabel> type and select the <guilabel>Default role</guilabel> checkbox to automatically assign this role to all new users.</para>
          </listitem>
          <listitem>
            <para>Create a set of roles for granting specific rights to different user categories. There are two strategies for creating such roles:<itemizedlist>
                <listitem>
                  <para>Coarse-grained roles – each role has a permission set for the full range of user responsibilities in the system. For example, <userinput>Sales Manager</userinput>, <userinput>Accountant</userinput>. Only one role is assigned to each user when using this strategy, excluding the <userinput>Default</userinput> role.</para>
                </listitem>
                <listitem>
                  <para>Fine-grained roles – each role has a small permission set to execute specific functions within the system. For example, <userinput>Task Creator</userinput>, <userinput>References Editor</userinput>. Each user will then be assigned numerous roles according to their range of responsibilities.</para>
                </listitem>
              </itemizedlist></para>
            <para>The strategies can also be combined.</para>
          </listitem>
          <listitem>
            <para>It is possible to leave the system administrator without any assigned roles, in which case, they will have all the rights to all the system objects. Alternatively a <guilabel>Super</guilabel> type role, overriding any restriction imposed by other roles, can be assigned.</para>
          </listitem>
        </orderedlist></para>
    </section>
    <section id="local_admins_example">
      <title>Creating Local Administrators</title>
      <para>The hierarchical structure of <link linkend="groups">access groups</link> combined with the <link linkend="constraints">constraints</link> inheritance allows creating <firstterm>local administrators</firstterm>, by delegating creation and configuration of users and their rights under organization departments.</para>
      <para>The local administrators have access to the security subsystem screens; however they only see the users and groups in their access group and below. Local administrators can create subgroups and users and <link linkend="roles">assign</link> roles available in the system, however they will have at least the same constraints as the administrator who created them.</para>
      <para>The global administrator in the root access group should create the roles that will be available to the local administrators for assigning to the users. The local administrators should not be able to create and update the roles.</para>
      <para>An example access group structure is presented below:<mediaobject>
          <imageobject>
            <imagedata align="center" fileref="img/local_admins_groups.png"/>
          </imageobject>
        </mediaobject></para>
      <para>Problem:<itemizedlist>
          <listitem>
            <para>The users under the <userinput>Departments</userinput> group should only see the users of their own group and the groups below.</para>
          </listitem>
          <listitem>
            <para>Each subgroup –     <userinput>Dept 1</userinput>, <userinput>Dept 2</userinput>, etc. should have its own administrator, who can create users and assign them the available roles.</para>
          </listitem>
        </itemizedlist></para>
      <para>Solution:<itemizedlist>
          <listitem>
            <para>Add the following constraints for the <userinput>Departments</userinput> group:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/local_admins_constraints.png"/>
                </imageobject>
              </mediaobject><itemizedlist>
                <listitem>
                  <para>For the <code>sec$Group</code> entity:<programlisting>{E}.id in (
  select h.group.id from sec$GroupHierarchy h
  where h.group.id = :session$userGroupId or h.parent.id = :session$userGroupId
)</programlisting></para>
                  <para>With this constraint, the users will not be able to see the groups higher than their own.</para>
                </listitem>
                <listitem>
                  <para>For the <code>sec$User</code> entity:<programlisting>{E}.group.id in (
  select h.group.id from sec$GroupHierarchy h
  where h.group.id = :session$userGroupId or h.parent.id = :session$userGroupId
)</programlisting></para>
                  <para>With this constraint, the users will not be able to see the users in groups higher than their own.</para>
                </listitem>
                <listitem>
                  <para>For the <code>sec$User</code> entity:<programlisting>({E}.description is null or {E}.description not like &apos;[hide]&apos;)</programlisting></para>
                  <para>With this constraint, the users will not be able to view the roles that have the <userinput>[hide]</userinput> string in the <code>description</code> attribute.</para>
                </listitem>
              </itemizedlist></para>
          </listitem>
          <listitem>
            <para>Create a role that denies editing roles and permissions:<mediaobject>
                <imageobject>
                  <imagedata align="center" fileref="img/local_admins_role.png"/>
                </imageobject>
              </mediaobject></para>
            <itemizedlist>
              <listitem>
                <para>Select the <guilabel>Default</guilabel> role checkbox:</para>
              </listitem>
              <listitem>
                <para>Add the <userinput>[hide]</userinput> string to the <guilabel>Description</guilabel> field.</para>
              </listitem>
              <listitem>
                <para>In the <guilabel>Entities</guilabel> tab, deny <guilabel>create</guilabel>, <guilabel>update</guilabel> and <guilabel>delete</guilabel> operations for the <code>sec$Role</code> and <code>sec$Permission</code> entities (to add permissions for the <code>sec$Permission</code> object, select the <guilabel>System level</guilabel> checkbox).</para>
              </listitem>
            </itemizedlist>
            <para>All created users, including the local administrators, will get the <userinput>local_user</userinput> role. This role is invisible to the users in the <userinput>Departments</userinput> group, so even the local administrators are unable to unassign this role from themselves. Local administrators can only operate on the existing roles that have been created for them by the global administrator. Obviously, the roles available to department users should not remove restrictions imposed by the <userinput>local_user</userinput> role.</para>
          </listitem>
        </itemizedlist></para>
    </section>
  </section>
</chapter>
